"use strict";(self.webpackChunk_N_E=self.webpackChunk_N_E||[]).push([[16],{19:function(e,t,n){n.d(t,{$q:function(){return Bc},AK:function(){return Rl},Ab:function(){return Ol},B$:function(){return qu},Bt:function(){return Ll},Cf:function(){return ku},EK:function(){return q},ET:function(){return _l},Eo:function(){return Bu},F8:function(){return cc},Fc:function(){return Zu},GL:function(){return kl},IO:function(){return Qc},IX:function(){return ju},Ix:function(){return tc},JU:function(){return Uu},Jj:function(){return ac},K9:function(){return b},Ky:function(){return z},L$:function(){return sc},Lx:function(){return il},Lz:function(){return oc},Me:function(){return _e},Mx:function(){return ec},PL:function(){return bl},PU:function(){return gl},Pb:function(){return rc},QT:function(){return yl},ST:function(){return Ju},TF:function(){return nc},TQ:function(){return rl},UQ:function(){return El},Ub:function(){return m},W:function(){return Kc},WA:function(){return S},Wi:function(){return Du},Wu:function(){return ol},Xb:function(){return $},Xk:function(){return Il},Xo:function(){return Yc},ar:function(){return Hc},at:function(){return Ru},b9:function(){return Zc},cf:function(){return Nl},e0:function(){return nl},fH:function(){return Yu},hJ:function(){return Pu},i3:function(){return Ml},iE:function(){return Ku},kl:function(){return vl},l7:function(){return Oe},my:function(){return Lu},nP:function(){return Pl},oe:function(){return Dl},pl:function(){return Sl},qK:function(){return $c},qY:function(){return Wu},r7:function(){return xl},sc:function(){return Al},u7:function(){return dl},vh:function(){return el},vr:function(){return Fl},xU:function(){return Uc},yq:function(){return y},zN:function(){return Tl}});var r=n(5816),s=n(8463),i=n(3333),o=n(4444),a=n(3510),u=n(3454);const c="@firebase/firestore";class l{constructor(e){this.uid=e}isAuthenticated(){return null!=this.uid}toKey(){return this.isAuthenticated()?"uid:"+this.uid:"anonymous-user"}isEqual(e){return e.uid===this.uid}}l.UNAUTHENTICATED=new l(null),l.GOOGLE_CREDENTIALS=new l("google-credentials-uid"),l.FIRST_PARTY=new l("first-party-uid"),l.MOCK_USER=new l("mock-user");let h="9.9.0";const d=new i.Yd("@firebase/firestore");function f(){return d.logLevel}function m(e){d.setLogLevel(e)}function g(e,...t){if(d.logLevel<=i.in.DEBUG){const n=t.map(w);d.debug(`Firestore (${h}): ${e}`,...n)}}function p(e,...t){if(d.logLevel<=i.in.ERROR){const n=t.map(w);d.error(`Firestore (${h}): ${e}`,...n)}}function y(e,...t){if(d.logLevel<=i.in.WARN){const n=t.map(w);d.warn(`Firestore (${h}): ${e}`,...n)}}function w(e){if("string"==typeof e)return e;try{return t=e,JSON.stringify(t)}catch(t){return e}var t}function v(e="Unexpected state"){const t=`FIRESTORE (${h}) INTERNAL ASSERTION FAILED: `+e;throw p(t),new Error(t)}function I(e,t){e||v()}function b(e,t){e||v()}function E(e,t){return e}const T={OK:"ok",CANCELLED:"cancelled",UNKNOWN:"unknown",INVALID_ARGUMENT:"invalid-argument",DEADLINE_EXCEEDED:"deadline-exceeded",NOT_FOUND:"not-found",ALREADY_EXISTS:"already-exists",PERMISSION_DENIED:"permission-denied",UNAUTHENTICATED:"unauthenticated",RESOURCE_EXHAUSTED:"resource-exhausted",FAILED_PRECONDITION:"failed-precondition",ABORTED:"aborted",OUT_OF_RANGE:"out-of-range",UNIMPLEMENTED:"unimplemented",INTERNAL:"internal",UNAVAILABLE:"unavailable",DATA_LOSS:"data-loss"};class S extends o.ZR{constructor(e,t){super(e,t),this.code=e,this.message=t,this.toString=()=>`${this.name}: [code=${this.code}]: ${this.message}`}}class x{constructor(){this.promise=new Promise(((e,t)=>{this.resolve=e,this.reject=t}))}}class D{constructor(e,t){this.user=t,this.type="OAuth",this.headers=new Map,this.headers.set("Authorization",`Bearer ${e}`)}}class _{getToken(){return Promise.resolve(null)}invalidateToken(){}start(e,t){e.enqueueRetryable((()=>t(l.UNAUTHENTICATED)))}shutdown(){}}class N{constructor(e){this.token=e,this.changeListener=null}getToken(){return Promise.resolve(this.token)}invalidateToken(){}start(e,t){this.changeListener=t,e.enqueueRetryable((()=>t(this.token.user)))}shutdown(){this.changeListener=null}}class A{constructor(e){this.t=e,this.currentUser=l.UNAUTHENTICATED,this.i=0,this.forceRefresh=!1,this.auth=null}start(e,t){let n=this.i;const r=e=>this.i!==n?(n=this.i,t(e)):Promise.resolve();let s=new x;this.o=()=>{this.i++,this.currentUser=this.u(),s.resolve(),s=new x,e.enqueueRetryable((()=>r(this.currentUser)))};const i=()=>{const t=s;e.enqueueRetryable((async()=>{await t.promise,await r(this.currentUser)}))},o=e=>{g("FirebaseAuthCredentialsProvider","Auth detected"),this.auth=e,this.auth.addAuthTokenListener(this.o),i()};this.t.onInit((e=>o(e))),setTimeout((()=>{if(!this.auth){const e=this.t.getImmediate({optional:!0});e?o(e):(g("FirebaseAuthCredentialsProvider","Auth not yet detected"),s.resolve(),s=new x)}}),0),i()}getToken(){const e=this.i,t=this.forceRefresh;return this.forceRefresh=!1,this.auth?this.auth.getToken(t).then((t=>this.i!==e?(g("FirebaseAuthCredentialsProvider","getToken aborted due to token change."),this.getToken()):t?(I("string"==typeof t.accessToken),new D(t.accessToken,this.currentUser)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.auth&&this.auth.removeAuthTokenListener(this.o)}u(){const e=this.auth&&this.auth.getUid();return I(null===e||"string"==typeof e),new l(e)}}class k{constructor(e,t,n){this.type="FirstParty",this.user=l.FIRST_PARTY,this.headers=new Map,this.headers.set("X-Goog-AuthUser",t);const r=e.auth.getAuthHeaderValueForFirstParty([]);r&&this.headers.set("Authorization",r),n&&this.headers.set("X-Goog-Iam-Authorization-Token",n)}}class C{constructor(e,t,n){this.h=e,this.l=t,this.m=n}getToken(){return Promise.resolve(new k(this.h,this.l,this.m))}start(e,t){e.enqueueRetryable((()=>t(l.FIRST_PARTY)))}shutdown(){}invalidateToken(){}}class V{constructor(e){this.value=e,this.type="AppCheck",this.headers=new Map,e&&e.length>0&&this.headers.set("x-firebase-appcheck",this.value)}}class M{constructor(e){this.g=e,this.forceRefresh=!1,this.appCheck=null,this.p=null}start(e,t){const n=e=>{null!=e.error&&g("FirebaseAppCheckTokenProvider",`Error getting App Check token; using placeholder token instead. Error: ${e.error.message}`);const n=e.token!==this.p;return this.p=e.token,g("FirebaseAppCheckTokenProvider",`Received ${n?"new":"existing"} token.`),n?t(e.token):Promise.resolve()};this.o=t=>{e.enqueueRetryable((()=>n(t)))};const r=e=>{g("FirebaseAppCheckTokenProvider","AppCheck detected"),this.appCheck=e,this.appCheck.addTokenListener(this.o)};this.g.onInit((e=>r(e))),setTimeout((()=>{if(!this.appCheck){const e=this.g.getImmediate({optional:!0});e?r(e):g("FirebaseAppCheckTokenProvider","AppCheck not yet detected")}}),0)}getToken(){const e=this.forceRefresh;return this.forceRefresh=!1,this.appCheck?this.appCheck.getToken(e).then((e=>e?(I("string"==typeof e.token),this.p=e.token,new V(e.token)):null)):Promise.resolve(null)}invalidateToken(){this.forceRefresh=!0}shutdown(){this.appCheck&&this.appCheck.removeTokenListener(this.o)}}function R(e){const t="undefined"!=typeof self&&(self.crypto||self.msCrypto),n=new Uint8Array(e);if(t&&"function"==typeof t.getRandomValues)t.getRandomValues(n);else for(let r=0;r<e;r++)n[r]=Math.floor(256*Math.random());return n}class L{static I(){const e="ABCDEFGHIJKLMNOPQRSTUVWXYZabcdefghijklmnopqrstuvwxyz0123456789",t=Math.floor(256/e.length)*e.length;let n="";for(;n.length<20;){const r=R(40);for(let s=0;s<r.length;++s)n.length<20&&r[s]<t&&(n+=e.charAt(r[s]%e.length))}return n}}function F(e,t){return e<t?-1:e>t?1:0}function O(e,t,n){return e.length===t.length&&e.every(((e,r)=>n(e,t[r])))}function P(e){return e+"\0"}class q{constructor(e,t){if(this.seconds=e,this.nanoseconds=t,t<0)throw new S(T.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(t>=1e9)throw new S(T.INVALID_ARGUMENT,"Timestamp nanoseconds out of range: "+t);if(e<-62135596800)throw new S(T.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e);if(e>=253402300800)throw new S(T.INVALID_ARGUMENT,"Timestamp seconds out of range: "+e)}static now(){return q.fromMillis(Date.now())}static fromDate(e){return q.fromMillis(e.getTime())}static fromMillis(e){const t=Math.floor(e/1e3),n=Math.floor(1e6*(e-1e3*t));return new q(t,n)}toDate(){return new Date(this.toMillis())}toMillis(){return 1e3*this.seconds+this.nanoseconds/1e6}_compareTo(e){return this.seconds===e.seconds?F(this.nanoseconds,e.nanoseconds):F(this.seconds,e.seconds)}isEqual(e){return e.seconds===this.seconds&&e.nanoseconds===this.nanoseconds}toString(){return"Timestamp(seconds="+this.seconds+", nanoseconds="+this.nanoseconds+")"}toJSON(){return{seconds:this.seconds,nanoseconds:this.nanoseconds}}valueOf(){const e=this.seconds- -62135596800;return String(e).padStart(12,"0")+"."+String(this.nanoseconds).padStart(9,"0")}}class U{constructor(e){this.timestamp=e}static fromTimestamp(e){return new U(e)}static min(){return new U(new q(0,0))}static max(){return new U(new q(253402300799,999999999))}compareTo(e){return this.timestamp._compareTo(e.timestamp)}isEqual(e){return this.timestamp.isEqual(e.timestamp)}toMicroseconds(){return 1e6*this.timestamp.seconds+this.timestamp.nanoseconds/1e3}toString(){return"SnapshotVersion("+this.timestamp.toString()+")"}toTimestamp(){return this.timestamp}}class B{constructor(e,t,n){void 0===t?t=0:t>e.length&&v(),void 0===n?n=e.length-t:n>e.length-t&&v(),this.segments=e,this.offset=t,this.len=n}get length(){return this.len}isEqual(e){return 0===B.comparator(this,e)}child(e){const t=this.segments.slice(this.offset,this.limit());return e instanceof B?e.forEach((e=>{t.push(e)})):t.push(e),this.construct(t)}limit(){return this.offset+this.length}popFirst(e){return e=void 0===e?1:e,this.construct(this.segments,this.offset+e,this.length-e)}popLast(){return this.construct(this.segments,this.offset,this.length-1)}firstSegment(){return this.segments[this.offset]}lastSegment(){return this.get(this.length-1)}get(e){return this.segments[this.offset+e]}isEmpty(){return 0===this.length}isPrefixOf(e){if(e.length<this.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}isImmediateParentOf(e){if(this.length+1!==e.length)return!1;for(let t=0;t<this.length;t++)if(this.get(t)!==e.get(t))return!1;return!0}forEach(e){for(let t=this.offset,n=this.limit();t<n;t++)e(this.segments[t])}toArray(){return this.segments.slice(this.offset,this.limit())}static comparator(e,t){const n=Math.min(e.length,t.length);for(let r=0;r<n;r++){const n=e.get(r),s=t.get(r);if(n<s)return-1;if(n>s)return 1}return e.length<t.length?-1:e.length>t.length?1:0}}class K extends B{construct(e,t,n){return new K(e,t,n)}canonicalString(){return this.toArray().join("/")}toString(){return this.canonicalString()}static fromString(...e){const t=[];for(const n of e){if(n.indexOf("//")>=0)throw new S(T.INVALID_ARGUMENT,`Invalid segment (${n}). Paths must not contain // in them.`);t.push(...n.split("/").filter((e=>e.length>0)))}return new K(t)}static emptyPath(){return new K([])}}const G=/^[_a-zA-Z][_a-zA-Z0-9]*$/;class $ extends B{construct(e,t,n){return new $(e,t,n)}static isValidIdentifier(e){return G.test(e)}canonicalString(){return this.toArray().map((e=>(e=e.replace(/\\/g,"\\\\").replace(/`/g,"\\`"),$.isValidIdentifier(e)||(e="`"+e+"`"),e))).join(".")}toString(){return this.canonicalString()}isKeyField(){return 1===this.length&&"__name__"===this.get(0)}static keyField(){return new $(["__name__"])}static fromServerFormat(e){const t=[];let n="",r=0;const s=()=>{if(0===n.length)throw new S(T.INVALID_ARGUMENT,`Invalid field path (${e}). Paths must not be empty, begin with '.', end with '.', or contain '..'`);t.push(n),n=""};let i=!1;for(;r<e.length;){const t=e[r];if("\\"===t){if(r+1===e.length)throw new S(T.INVALID_ARGUMENT,"Path has trailing escape character: "+e);const t=e[r+1];if("\\"!==t&&"."!==t&&"`"!==t)throw new S(T.INVALID_ARGUMENT,"Path has invalid escape sequence: "+e);n+=t,r+=2}else"`"===t?(i=!i,r++):"."!==t||i?(n+=t,r++):(s(),r++)}if(s(),i)throw new S(T.INVALID_ARGUMENT,"Unterminated ` in path: "+e);return new $(t)}static emptyPath(){return new $([])}}class z{constructor(e){this.path=e}static fromPath(e){return new z(K.fromString(e))}static fromName(e){return new z(K.fromString(e).popFirst(5))}static empty(){return new z(K.emptyPath())}get collectionGroup(){return this.path.popLast().lastSegment()}hasCollectionId(e){return this.path.length>=2&&this.path.get(this.path.length-2)===e}getCollectionGroup(){return this.path.get(this.path.length-2)}getCollectionPath(){return this.path.popLast()}isEqual(e){return null!==e&&0===K.comparator(this.path,e.path)}toString(){return this.path.toString()}static comparator(e,t){return K.comparator(e.path,t.path)}static isDocumentKey(e){return e.length%2==0}static fromSegments(e){return new z(new K(e.slice()))}}class j{constructor(e,t,n,r){this.indexId=e,this.collectionGroup=t,this.fields=n,this.indexState=r}}function Q(e){return e.fields.find((e=>2===e.kind))}function W(e){return e.fields.filter((e=>2!==e.kind))}j.UNKNOWN_ID=-1;class H{constructor(e,t){this.fieldPath=e,this.kind=t}}class J{constructor(e,t){this.sequenceNumber=e,this.offset=t}static empty(){return new J(0,Z.min())}}function Y(e,t){const n=e.toTimestamp().seconds,r=e.toTimestamp().nanoseconds+1,s=U.fromTimestamp(1e9===r?new q(n+1,0):new q(n,r));return new Z(s,z.empty(),t)}function X(e){return new Z(e.readTime,e.key,-1)}class Z{constructor(e,t,n){this.readTime=e,this.documentKey=t,this.largestBatchId=n}static min(){return new Z(U.min(),z.empty(),-1)}static max(){return new Z(U.max(),z.empty(),-1)}}function ee(e,t){let n=e.readTime.compareTo(t.readTime);return 0!==n?n:(n=z.comparator(e.documentKey,t.documentKey),0!==n?n:F(e.largestBatchId,t.largestBatchId))}const te="The current tab is not in the required state to perform this operation. It might be necessary to refresh the browser tab.";class ne{constructor(){this.onCommittedListeners=[]}addOnCommittedListener(e){this.onCommittedListeners.push(e)}raiseOnCommittedEvent(){this.onCommittedListeners.forEach((e=>e()))}}async function re(e){if(e.code!==T.FAILED_PRECONDITION||e.message!==te)throw e;g("LocalStore","Unexpectedly lost primary lease")}class se{constructor(e){this.nextCallback=null,this.catchCallback=null,this.result=void 0,this.error=void 0,this.isDone=!1,this.callbackAttached=!1,e((e=>{this.isDone=!0,this.result=e,this.nextCallback&&this.nextCallback(e)}),(e=>{this.isDone=!0,this.error=e,this.catchCallback&&this.catchCallback(e)}))}catch(e){return this.next(void 0,e)}next(e,t){return this.callbackAttached&&v(),this.callbackAttached=!0,this.isDone?this.error?this.wrapFailure(t,this.error):this.wrapSuccess(e,this.result):new se(((n,r)=>{this.nextCallback=t=>{this.wrapSuccess(e,t).next(n,r)},this.catchCallback=e=>{this.wrapFailure(t,e).next(n,r)}}))}toPromise(){return new Promise(((e,t)=>{this.next(e,t)}))}wrapUserFunction(e){try{const t=e();return t instanceof se?t:se.resolve(t)}catch(e){return se.reject(e)}}wrapSuccess(e,t){return e?this.wrapUserFunction((()=>e(t))):se.resolve(t)}wrapFailure(e,t){return e?this.wrapUserFunction((()=>e(t))):se.reject(t)}static resolve(e){return new se(((t,n)=>{t(e)}))}static reject(e){return new se(((t,n)=>{n(e)}))}static waitFor(e){return new se(((t,n)=>{let r=0,s=0,i=!1;e.forEach((e=>{++r,e.next((()=>{++s,i&&s===r&&t()}),(e=>n(e)))})),i=!0,s===r&&t()}))}static or(e){let t=se.resolve(!1);for(const n of e)t=t.next((e=>e?se.resolve(e):n()));return t}static forEach(e,t){const n=[];return e.forEach(((e,r)=>{n.push(t.call(this,e,r))})),this.waitFor(n)}static mapArray(e,t){return new se(((n,r)=>{const s=e.length,i=new Array(s);let o=0;for(let a=0;a<s;a++){const u=a;t(e[u]).next((e=>{i[u]=e,++o,o===s&&n(i)}),(e=>r(e)))}}))}static doWhile(e,t){return new se(((n,r)=>{const s=()=>{!0===e()?t().next((()=>{s()}),r):n()};s()}))}}class ie{constructor(e,t){this.action=e,this.transaction=t,this.aborted=!1,this.T=new x,this.transaction.oncomplete=()=>{this.T.resolve()},this.transaction.onabort=()=>{t.error?this.T.reject(new ue(e,t.error)):this.T.resolve()},this.transaction.onerror=t=>{const n=fe(t.target.error);this.T.reject(new ue(e,n))}}static open(e,t,n,r){try{return new ie(t,e.transaction(r,n))}catch(e){throw new ue(t,e)}}get A(){return this.T.promise}abort(e){e&&this.T.reject(e),this.aborted||(g("SimpleDb","Aborting transaction:",e?e.message:"Client-initiated abort"),this.aborted=!0,this.transaction.abort())}R(){const e=this.transaction;this.aborted||"function"!=typeof e.commit||e.commit()}store(e){const t=this.transaction.objectStore(e);return new le(t)}}class oe{constructor(e,t,n){this.name=e,this.version=t,this.P=n,12.2===oe.v((0,o.z$)())&&p("Firestore persistence suffers from a bug in iOS 12.2 Safari that may cause your app to stop working. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.")}static delete(e){return g("SimpleDb","Removing database:",e),he(window.indexedDB.deleteDatabase(e)).toPromise()}static V(){if(!(0,o.hl)())return!1;if(oe.S())return!0;const e=(0,o.z$)(),t=oe.v(e),n=0<t&&t<10,r=oe.D(e),s=0<r&&r<4.5;return!(e.indexOf("MSIE ")>0||e.indexOf("Trident/")>0||e.indexOf("Edge/")>0||n||s)}static S(){var e;return"undefined"!=typeof u&&"YES"===(null===(e=u.env)||void 0===e?void 0:e.C)}static N(e,t){return e.store(t)}static v(e){const t=e.match(/i(?:phone|pad|pod) os ([\d_]+)/i),n=t?t[1].split("_").slice(0,2).join("."):"-1";return Number(n)}static D(e){const t=e.match(/Android ([\d.]+)/i),n=t?t[1].split(".").slice(0,2).join("."):"-1";return Number(n)}async k(e){return this.db||(g("SimpleDb","Opening database:",this.name),this.db=await new Promise(((t,n)=>{const r=indexedDB.open(this.name,this.version);r.onsuccess=e=>{const n=e.target.result;t(n)},r.onblocked=()=>{n(new ue(e,"Cannot upgrade IndexedDB schema while another tab is open. Close all tabs that access Firestore and reload this page to proceed."))},r.onerror=t=>{const r=t.target.error;"VersionError"===r.name?n(new S(T.FAILED_PRECONDITION,"A newer version of the Firestore SDK was previously used and so the persisted data is not compatible with the version of the SDK you are now using. The SDK will operate with persistence disabled. If you need persistence, please re-upgrade to a newer version of the SDK or else clear the persisted IndexedDB data for your app to start fresh.")):"InvalidStateError"===r.name?n(new S(T.FAILED_PRECONDITION,"Unable to open an IndexedDB connection. This could be due to running in a private browsing session on a browser whose private browsing sessions do not support IndexedDB: "+r)):n(new ue(e,r))},r.onupgradeneeded=e=>{g("SimpleDb",'Database "'+this.name+'" requires upgrade from version:',e.oldVersion);const t=e.target.result;this.P.O(t,r.transaction,e.oldVersion,this.version).next((()=>{g("SimpleDb","Database upgrade to version "+this.version+" complete")}))}}))),this.M&&(this.db.onversionchange=e=>this.M(e)),this.db}F(e){this.M=e,this.db&&(this.db.onversionchange=t=>e(t))}async runTransaction(e,t,n,r){const s="readonly"===t;let i=0;for(;;){++i;try{this.db=await this.k(e);const t=ie.open(this.db,e,s?"readonly":"readwrite",n),i=r(t).next((e=>(t.R(),e))).catch((e=>(t.abort(e),se.reject(e)))).toPromise();return i.catch((()=>{})),await t.A,i}catch(e){const t=e,n="FirebaseError"!==t.name&&i<3;if(g("SimpleDb","Transaction failed with error:",t.message,"Retrying:",n),this.close(),!n)return Promise.reject(t)}}}close(){this.db&&this.db.close(),this.db=void 0}}class ae{constructor(e){this.$=e,this.B=!1,this.L=null}get isDone(){return this.B}get U(){return this.L}set cursor(e){this.$=e}done(){this.B=!0}q(e){this.L=e}delete(){return he(this.$.delete())}}class ue extends S{constructor(e,t){super(T.UNAVAILABLE,`IndexedDB transaction '${e}' failed: ${t}`),this.name="IndexedDbTransactionError"}}function ce(e){return"IndexedDbTransactionError"===e.name}class le{constructor(e){this.store=e}put(e,t){let n;return void 0!==t?(g("SimpleDb","PUT",this.store.name,e,t),n=this.store.put(t,e)):(g("SimpleDb","PUT",this.store.name,"<auto-key>",e),n=this.store.put(e)),he(n)}add(e){return g("SimpleDb","ADD",this.store.name,e,e),he(this.store.add(e))}get(e){return he(this.store.get(e)).next((t=>(void 0===t&&(t=null),g("SimpleDb","GET",this.store.name,e,t),t)))}delete(e){return g("SimpleDb","DELETE",this.store.name,e),he(this.store.delete(e))}count(){return g("SimpleDb","COUNT",this.store.name),he(this.store.count())}K(e,t){const n=this.options(e,t);if(n.index||"function"!=typeof this.store.getAll){const e=this.cursor(n),t=[];return this.G(e,((e,n)=>{t.push(n)})).next((()=>t))}{const e=this.store.getAll(n.range);return new se(((t,n)=>{e.onerror=e=>{n(e.target.error)},e.onsuccess=e=>{t(e.target.result)}}))}}j(e,t){const n=this.store.getAll(e,null===t?void 0:t);return new se(((e,t)=>{n.onerror=e=>{t(e.target.error)},n.onsuccess=t=>{e(t.target.result)}}))}W(e,t){g("SimpleDb","DELETE ALL",this.store.name);const n=this.options(e,t);n.H=!1;const r=this.cursor(n);return this.G(r,((e,t,n)=>n.delete()))}J(e,t){let n;t?n=e:(n={},t=e);const r=this.cursor(n);return this.G(r,t)}Y(e){const t=this.cursor({});return new se(((n,r)=>{t.onerror=e=>{const t=fe(e.target.error);r(t)},t.onsuccess=t=>{const r=t.target.result;r?e(r.primaryKey,r.value).next((e=>{e?r.continue():n()})):n()}}))}G(e,t){const n=[];return new se(((r,s)=>{e.onerror=e=>{s(e.target.error)},e.onsuccess=e=>{const s=e.target.result;if(!s)return void r();const i=new ae(s),o=t(s.primaryKey,s.value,i);if(o instanceof se){const e=o.catch((e=>(i.done(),se.reject(e))));n.push(e)}i.isDone?r():null===i.U?s.continue():s.continue(i.U)}})).next((()=>se.waitFor(n)))}options(e,t){let n;return void 0!==e&&("string"==typeof e?n=e:t=e),{index:n,range:t}}cursor(e){let t="next";if(e.reverse&&(t="prev"),e.index){const n=this.store.index(e.index);return e.H?n.openKeyCursor(e.range,t):n.openCursor(e.range,t)}return this.store.openCursor(e.range,t)}}function he(e){return new se(((t,n)=>{e.onsuccess=e=>{const n=e.target.result;t(n)},e.onerror=e=>{const t=fe(e.target.error);n(t)}}))}let de=!1;function fe(e){const t=oe.v((0,o.z$)());if(t>=12.2&&t<13){const t="An internal error was encountered in the Indexed Database server";if(e.message.indexOf(t)>=0){const e=new S("internal",`IOS_INDEXEDDB_BUG1: IndexedDb has thrown '${t}'. This is likely due to an unavoidable bug in iOS. See https://stackoverflow.com/q/56496296/110915 for details and a potential workaround.`);return de||(de=!0,setTimeout((()=>{throw e}),0)),e}}return e}class me{constructor(e,t){this.asyncQueue=e,this.X=t,this.task=null}start(){}stop(){this.task&&(this.task.cancel(),this.task=null)}get started(){return null!==this.task}Z(e){g("IndexBackiller",`Scheduled in ${e}ms`),this.task=this.asyncQueue.enqueueAfterDelay("index_backfill",e,(async()=>{this.task=null;try{g("IndexBackiller",`Documents written: ${await this.X.tt()}`)}catch(e){ce(e)?g("IndexBackiller","Ignoring IndexedDB error during index backfill: ",e):await re(e)}await this.Z(1)}))}}class ge{constructor(e,t){this.localStore=e,this.persistence=t}async tt(e=50){return this.persistence.runTransaction("Backfill Indexes","readwrite-primary",(t=>this.et(t,e)))}et(e,t){const n=new Set;let r=t,s=!0;return se.doWhile((()=>!0===s&&r>0),(()=>this.localStore.indexManager.getNextCollectionGroupToUpdate(e).next((t=>{if(null!==t&&!n.has(t))return g("IndexBackiller",`Processing collection: ${t}`),this.nt(e,t,r).next((e=>{r-=e,n.add(t)}));s=!1})))).next((()=>t-r))}nt(e,t,n){return this.localStore.indexManager.getMinOffsetFromCollectionGroup(e,t).next((r=>this.localStore.localDocuments.getNextDocuments(e,t,r,n).next((n=>{const s=n.changes;return this.localStore.indexManager.updateIndexEntries(e,s).next((()=>this.st(r,n))).next((n=>(g("IndexBackiller",`Updating offset: ${n}`),this.localStore.indexManager.updateCollectionGroup(e,t,n)))).next((()=>s.size))}))))}st(e,t){let n=e;return t.changes.forEach(((e,t)=>{const r=X(t);ee(r,n)>0&&(n=r)})),new Z(n.readTime,n.documentKey,Math.max(t.batchId,e.largestBatchId))}}class pe{constructor(e,t){this.previousValue=e,t&&(t.sequenceNumberHandler=e=>this.it(e),this.rt=e=>t.writeSequenceNumber(e))}it(e){return this.previousValue=Math.max(e,this.previousValue),this.previousValue}next(){const e=++this.previousValue;return this.rt&&this.rt(e),e}}function ye(e){let t=0;for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t++;return t}function we(e,t){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t(n,e[n])}function ve(e){for(const t in e)if(Object.prototype.hasOwnProperty.call(e,t))return!1;return!0}pe.ot=-1;class Ie{constructor(e,t){this.comparator=e,this.root=t||Ee.EMPTY}insert(e,t){return new Ie(this.comparator,this.root.insert(e,t,this.comparator).copy(null,null,Ee.BLACK,null,null))}remove(e){return new Ie(this.comparator,this.root.remove(e,this.comparator).copy(null,null,Ee.BLACK,null,null))}get(e){let t=this.root;for(;!t.isEmpty();){const n=this.comparator(e,t.key);if(0===n)return t.value;n<0?t=t.left:n>0&&(t=t.right)}return null}indexOf(e){let t=0,n=this.root;for(;!n.isEmpty();){const r=this.comparator(e,n.key);if(0===r)return t+n.left.size;r<0?n=n.left:(t+=n.left.size+1,n=n.right)}return-1}isEmpty(){return this.root.isEmpty()}get size(){return this.root.size}minKey(){return this.root.minKey()}maxKey(){return this.root.maxKey()}inorderTraversal(e){return this.root.inorderTraversal(e)}forEach(e){this.inorderTraversal(((t,n)=>(e(t,n),!1)))}toString(){const e=[];return this.inorderTraversal(((t,n)=>(e.push(`${t}:${n}`),!1))),`{${e.join(", ")}}`}reverseTraversal(e){return this.root.reverseTraversal(e)}getIterator(){return new be(this.root,null,this.comparator,!1)}getIteratorFrom(e){return new be(this.root,e,this.comparator,!1)}getReverseIterator(){return new be(this.root,null,this.comparator,!0)}getReverseIteratorFrom(e){return new be(this.root,e,this.comparator,!0)}}class be{constructor(e,t,n,r){this.isReverse=r,this.nodeStack=[];let s=1;for(;!e.isEmpty();)if(s=t?n(e.key,t):1,t&&r&&(s*=-1),s<0)e=this.isReverse?e.left:e.right;else{if(0===s){this.nodeStack.push(e);break}this.nodeStack.push(e),e=this.isReverse?e.right:e.left}}getNext(){let e=this.nodeStack.pop();const t={key:e.key,value:e.value};if(this.isReverse)for(e=e.left;!e.isEmpty();)this.nodeStack.push(e),e=e.right;else for(e=e.right;!e.isEmpty();)this.nodeStack.push(e),e=e.left;return t}hasNext(){return this.nodeStack.length>0}peek(){if(0===this.nodeStack.length)return null;const e=this.nodeStack[this.nodeStack.length-1];return{key:e.key,value:e.value}}}class Ee{constructor(e,t,n,r,s){this.key=e,this.value=t,this.color=null!=n?n:Ee.RED,this.left=null!=r?r:Ee.EMPTY,this.right=null!=s?s:Ee.EMPTY,this.size=this.left.size+1+this.right.size}copy(e,t,n,r,s){return new Ee(null!=e?e:this.key,null!=t?t:this.value,null!=n?n:this.color,null!=r?r:this.left,null!=s?s:this.right)}isEmpty(){return!1}inorderTraversal(e){return this.left.inorderTraversal(e)||e(this.key,this.value)||this.right.inorderTraversal(e)}reverseTraversal(e){return this.right.reverseTraversal(e)||e(this.key,this.value)||this.left.reverseTraversal(e)}min(){return this.left.isEmpty()?this:this.left.min()}minKey(){return this.min().key}maxKey(){return this.right.isEmpty()?this.key:this.right.maxKey()}insert(e,t,n){let r=this;const s=n(e,r.key);return r=s<0?r.copy(null,null,null,r.left.insert(e,t,n),null):0===s?r.copy(null,t,null,null,null):r.copy(null,null,null,null,r.right.insert(e,t,n)),r.fixUp()}removeMin(){if(this.left.isEmpty())return Ee.EMPTY;let e=this;return e.left.isRed()||e.left.left.isRed()||(e=e.moveRedLeft()),e=e.copy(null,null,null,e.left.removeMin(),null),e.fixUp()}remove(e,t){let n,r=this;if(t(e,r.key)<0)r.left.isEmpty()||r.left.isRed()||r.left.left.isRed()||(r=r.moveRedLeft()),r=r.copy(null,null,null,r.left.remove(e,t),null);else{if(r.left.isRed()&&(r=r.rotateRight()),r.right.isEmpty()||r.right.isRed()||r.right.left.isRed()||(r=r.moveRedRight()),0===t(e,r.key)){if(r.right.isEmpty())return Ee.EMPTY;n=r.right.min(),r=r.copy(n.key,n.value,null,null,r.right.removeMin())}r=r.copy(null,null,null,null,r.right.remove(e,t))}return r.fixUp()}isRed(){return this.color}fixUp(){let e=this;return e.right.isRed()&&!e.left.isRed()&&(e=e.rotateLeft()),e.left.isRed()&&e.left.left.isRed()&&(e=e.rotateRight()),e.left.isRed()&&e.right.isRed()&&(e=e.colorFlip()),e}moveRedLeft(){let e=this.colorFlip();return e.right.left.isRed()&&(e=e.copy(null,null,null,null,e.right.rotateRight()),e=e.rotateLeft(),e=e.colorFlip()),e}moveRedRight(){let e=this.colorFlip();return e.left.left.isRed()&&(e=e.rotateRight(),e=e.colorFlip()),e}rotateLeft(){const e=this.copy(null,null,Ee.RED,null,this.right.left);return this.right.copy(null,null,this.color,e,null)}rotateRight(){const e=this.copy(null,null,Ee.RED,this.left.right,null);return this.left.copy(null,null,this.color,null,e)}colorFlip(){const e=this.left.copy(null,null,!this.left.color,null,null),t=this.right.copy(null,null,!this.right.color,null,null);return this.copy(null,null,!this.color,e,t)}checkMaxDepth(){const e=this.check();return Math.pow(2,e)<=this.size+1}check(){if(this.isRed()&&this.left.isRed())throw v();if(this.right.isRed())throw v();const e=this.left.check();if(e!==this.right.check())throw v();return e+(this.isRed()?0:1)}}Ee.EMPTY=null,Ee.RED=!0,Ee.BLACK=!1,Ee.EMPTY=new class{constructor(){this.size=0}get key(){throw v()}get value(){throw v()}get color(){throw v()}get left(){throw v()}get right(){throw v()}copy(e,t,n,r,s){return this}insert(e,t,n){return new Ee(e,t)}remove(e,t){return this}isEmpty(){return!0}inorderTraversal(e){return!1}reverseTraversal(e){return!1}minKey(){return null}maxKey(){return null}isRed(){return!1}checkMaxDepth(){return!0}check(){return 0}};class Te{constructor(e){this.comparator=e,this.data=new Ie(this.comparator)}has(e){return null!==this.data.get(e)}first(){return this.data.minKey()}last(){return this.data.maxKey()}get size(){return this.data.size}indexOf(e){return this.data.indexOf(e)}forEach(e){this.data.inorderTraversal(((t,n)=>(e(t),!1)))}forEachInRange(e,t){const n=this.data.getIteratorFrom(e[0]);for(;n.hasNext();){const r=n.getNext();if(this.comparator(r.key,e[1])>=0)return;t(r.key)}}forEachWhile(e,t){let n;for(n=void 0!==t?this.data.getIteratorFrom(t):this.data.getIterator();n.hasNext();)if(!e(n.getNext().key))return}firstAfterOrEqual(e){const t=this.data.getIteratorFrom(e);return t.hasNext()?t.getNext().key:null}getIterator(){return new Se(this.data.getIterator())}getIteratorFrom(e){return new Se(this.data.getIteratorFrom(e))}add(e){return this.copy(this.data.remove(e).insert(e,!0))}delete(e){return this.has(e)?this.copy(this.data.remove(e)):this}isEmpty(){return this.data.isEmpty()}unionWith(e){let t=this;return t.size<e.size&&(t=e,e=this),e.forEach((e=>{t=t.add(e)})),t}isEqual(e){if(!(e instanceof Te))return!1;if(this.size!==e.size)return!1;const t=this.data.getIterator(),n=e.data.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(0!==this.comparator(e,r))return!1}return!0}toArray(){const e=[];return this.forEach((t=>{e.push(t)})),e}toString(){const e=[];return this.forEach((t=>e.push(t))),"SortedSet("+e.toString()+")"}copy(e){const t=new Te(this.comparator);return t.data=e,t}}class Se{constructor(e){this.iter=e}getNext(){return this.iter.getNext().key}hasNext(){return this.iter.hasNext()}}function xe(e){return e.hasNext()?e.getNext():void 0}class De{constructor(e){this.fields=e,e.sort($.comparator)}static empty(){return new De([])}unionWith(e){let t=new Te($.comparator);for(const n of this.fields)t=t.add(n);for(const n of e)t=t.add(n);return new De(t.toArray())}covers(e){for(const t of this.fields)if(t.isPrefixOf(e))return!0;return!1}isEqual(e){return O(this.fields,e.fields,((e,t)=>e.isEqual(t)))}}function _e(){return"undefined"!=typeof atob}class Ne{constructor(e){this.binaryString=e}static fromBase64String(e){const t=atob(e);return new Ne(t)}static fromUint8Array(e){const t=function(e){let t="";for(let n=0;n<e.length;++n)t+=String.fromCharCode(e[n]);return t}(e);return new Ne(t)}[Symbol.iterator](){let e=0;return{next:()=>e<this.binaryString.length?{value:this.binaryString.charCodeAt(e++),done:!1}:{value:void 0,done:!0}}}toBase64(){return e=this.binaryString,btoa(e);var e}toUint8Array(){return function(e){const t=new Uint8Array(e.length);for(let n=0;n<e.length;n++)t[n]=e.charCodeAt(n);return t}(this.binaryString)}approximateByteSize(){return 2*this.binaryString.length}compareTo(e){return F(this.binaryString,e.binaryString)}isEqual(e){return this.binaryString===e.binaryString}}Ne.EMPTY_BYTE_STRING=new Ne("");const Ae=new RegExp(/^\d{4}-\d\d-\d\dT\d\d:\d\d:\d\d(?:\.(\d+))?Z$/);function ke(e){if(I(!!e),"string"==typeof e){let t=0;const n=Ae.exec(e);if(I(!!n),n[1]){let e=n[1];e=(e+"000000000").substr(0,9),t=Number(e)}const r=new Date(e);return{seconds:Math.floor(r.getTime()/1e3),nanos:t}}return{seconds:Ce(e.seconds),nanos:Ce(e.nanos)}}function Ce(e){return"number"==typeof e?e:"string"==typeof e?Number(e):0}function Ve(e){return"string"==typeof e?Ne.fromBase64String(e):Ne.fromUint8Array(e)}function Me(e){var t,n;return"server_timestamp"===(null===(n=((null===(t=null==e?void 0:e.mapValue)||void 0===t?void 0:t.fields)||{}).__type__)||void 0===n?void 0:n.stringValue)}function Re(e){const t=e.mapValue.fields.__previous_value__;return Me(t)?Re(t):t}function Le(e){const t=ke(e.mapValue.fields.__local_write_time__.timestampValue);return new q(t.seconds,t.nanos)}class Fe{constructor(e,t,n,r,s,i,o,a){this.databaseId=e,this.appId=t,this.persistenceKey=n,this.host=r,this.ssl=s,this.forceLongPolling=i,this.autoDetectLongPolling=o,this.useFetchStreams=a}}class Oe{constructor(e,t){this.projectId=e,this.database=t||"(default)"}static empty(){return new Oe("","")}get isDefaultDatabase(){return"(default)"===this.database}isEqual(e){return e instanceof Oe&&e.projectId===this.projectId&&e.database===this.database}}function Pe(e){return null==e}function qe(e){return 0===e&&1/e==-1/0}function Ue(e){return"number"==typeof e&&Number.isInteger(e)&&!qe(e)&&e<=Number.MAX_SAFE_INTEGER&&e>=Number.MIN_SAFE_INTEGER}const Be={mapValue:{fields:{__type__:{stringValue:"__max__"}}}},Ke={nullValue:"NULL_VALUE"};function Ge(e){return"nullValue"in e?0:"booleanValue"in e?1:"integerValue"in e||"doubleValue"in e?2:"timestampValue"in e?3:"stringValue"in e?5:"bytesValue"in e?6:"referenceValue"in e?7:"geoPointValue"in e?8:"arrayValue"in e?9:"mapValue"in e?Me(e)?4:rt(e)?9007199254740991:10:v()}function $e(e,t){if(e===t)return!0;const n=Ge(e);if(n!==Ge(t))return!1;switch(n){case 0:case 9007199254740991:return!0;case 1:return e.booleanValue===t.booleanValue;case 4:return Le(e).isEqual(Le(t));case 3:return function(e,t){if("string"==typeof e.timestampValue&&"string"==typeof t.timestampValue&&e.timestampValue.length===t.timestampValue.length)return e.timestampValue===t.timestampValue;const n=ke(e.timestampValue),r=ke(t.timestampValue);return n.seconds===r.seconds&&n.nanos===r.nanos}(e,t);case 5:return e.stringValue===t.stringValue;case 6:return function(e,t){return Ve(e.bytesValue).isEqual(Ve(t.bytesValue))}(e,t);case 7:return e.referenceValue===t.referenceValue;case 8:return function(e,t){return Ce(e.geoPointValue.latitude)===Ce(t.geoPointValue.latitude)&&Ce(e.geoPointValue.longitude)===Ce(t.geoPointValue.longitude)}(e,t);case 2:return function(e,t){if("integerValue"in e&&"integerValue"in t)return Ce(e.integerValue)===Ce(t.integerValue);if("doubleValue"in e&&"doubleValue"in t){const n=Ce(e.doubleValue),r=Ce(t.doubleValue);return n===r?qe(n)===qe(r):isNaN(n)&&isNaN(r)}return!1}(e,t);case 9:return O(e.arrayValue.values||[],t.arrayValue.values||[],$e);case 10:return function(e,t){const n=e.mapValue.fields||{},r=t.mapValue.fields||{};if(ye(n)!==ye(r))return!1;for(const s in n)if(n.hasOwnProperty(s)&&(void 0===r[s]||!$e(n[s],r[s])))return!1;return!0}(e,t);default:return v()}}function ze(e,t){return void 0!==(e.values||[]).find((e=>$e(e,t)))}function je(e,t){if(e===t)return 0;const n=Ge(e),r=Ge(t);if(n!==r)return F(n,r);switch(n){case 0:case 9007199254740991:return 0;case 1:return F(e.booleanValue,t.booleanValue);case 2:return function(e,t){const n=Ce(e.integerValue||e.doubleValue),r=Ce(t.integerValue||t.doubleValue);return n<r?-1:n>r?1:n===r?0:isNaN(n)?isNaN(r)?0:-1:1}(e,t);case 3:return Qe(e.timestampValue,t.timestampValue);case 4:return Qe(Le(e),Le(t));case 5:return F(e.stringValue,t.stringValue);case 6:return function(e,t){const n=Ve(e),r=Ve(t);return n.compareTo(r)}(e.bytesValue,t.bytesValue);case 7:return function(e,t){const n=e.split("/"),r=t.split("/");for(let s=0;s<n.length&&s<r.length;s++){const e=F(n[s],r[s]);if(0!==e)return e}return F(n.length,r.length)}(e.referenceValue,t.referenceValue);case 8:return function(e,t){const n=F(Ce(e.latitude),Ce(t.latitude));return 0!==n?n:F(Ce(e.longitude),Ce(t.longitude))}(e.geoPointValue,t.geoPointValue);case 9:return function(e,t){const n=e.values||[],r=t.values||[];for(let s=0;s<n.length&&s<r.length;++s){const e=je(n[s],r[s]);if(e)return e}return F(n.length,r.length)}(e.arrayValue,t.arrayValue);case 10:return function(e,t){if(e===Be.mapValue&&t===Be.mapValue)return 0;if(e===Be.mapValue)return 1;if(t===Be.mapValue)return-1;const n=e.fields||{},r=Object.keys(n),s=t.fields||{},i=Object.keys(s);r.sort(),i.sort();for(let o=0;o<r.length&&o<i.length;++o){const e=F(r[o],i[o]);if(0!==e)return e;const t=je(n[r[o]],s[i[o]]);if(0!==t)return t}return F(r.length,i.length)}(e.mapValue,t.mapValue);default:throw v()}}function Qe(e,t){if("string"==typeof e&&"string"==typeof t&&e.length===t.length)return F(e,t);const n=ke(e),r=ke(t),s=F(n.seconds,r.seconds);return 0!==s?s:F(n.nanos,r.nanos)}function We(e){return He(e)}function He(e){return"nullValue"in e?"null":"booleanValue"in e?""+e.booleanValue:"integerValue"in e?""+e.integerValue:"doubleValue"in e?""+e.doubleValue:"timestampValue"in e?function(e){const t=ke(e);return`time(${t.seconds},${t.nanos})`}(e.timestampValue):"stringValue"in e?e.stringValue:"bytesValue"in e?Ve(e.bytesValue).toBase64():"referenceValue"in e?(n=e.referenceValue,z.fromName(n).toString()):"geoPointValue"in e?`geo(${(t=e.geoPointValue).latitude},${t.longitude})`:"arrayValue"in e?function(e){let t="[",n=!0;for(const r of e.values||[])n?n=!1:t+=",",t+=He(r);return t+"]"}(e.arrayValue):"mapValue"in e?function(e){const t=Object.keys(e.fields||{}).sort();let n="{",r=!0;for(const s of t)r?r=!1:n+=",",n+=`${s}:${He(e.fields[s])}`;return n+"}"}(e.mapValue):v();var t,n}function Je(e,t){return{referenceValue:`projects/${e.projectId}/databases/${e.database}/documents/${t.path.canonicalString()}`}}function Ye(e){return!!e&&"integerValue"in e}function Xe(e){return!!e&&"arrayValue"in e}function Ze(e){return!!e&&"nullValue"in e}function et(e){return!!e&&"doubleValue"in e&&isNaN(Number(e.doubleValue))}function tt(e){return!!e&&"mapValue"in e}function nt(e){if(e.geoPointValue)return{geoPointValue:Object.assign({},e.geoPointValue)};if(e.timestampValue&&"object"==typeof e.timestampValue)return{timestampValue:Object.assign({},e.timestampValue)};if(e.mapValue){const t={mapValue:{fields:{}}};return we(e.mapValue.fields,((e,n)=>t.mapValue.fields[e]=nt(n))),t}if(e.arrayValue){const t={arrayValue:{values:[]}};for(let n=0;n<(e.arrayValue.values||[]).length;++n)t.arrayValue.values[n]=nt(e.arrayValue.values[n]);return t}return Object.assign({},e)}function rt(e){return"__max__"===(((e.mapValue||{}).fields||{}).__type__||{}).stringValue}function st(e){return"nullValue"in e?Ke:"booleanValue"in e?{booleanValue:!1}:"integerValue"in e||"doubleValue"in e?{doubleValue:NaN}:"timestampValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"stringValue"in e?{stringValue:""}:"bytesValue"in e?{bytesValue:""}:"referenceValue"in e?Je(Oe.empty(),z.empty()):"geoPointValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"arrayValue"in e?{arrayValue:{}}:"mapValue"in e?{mapValue:{}}:v()}function it(e){return"nullValue"in e?{booleanValue:!1}:"booleanValue"in e?{doubleValue:NaN}:"integerValue"in e||"doubleValue"in e?{timestampValue:{seconds:Number.MIN_SAFE_INTEGER}}:"timestampValue"in e?{stringValue:""}:"stringValue"in e?{bytesValue:""}:"bytesValue"in e?Je(Oe.empty(),z.empty()):"referenceValue"in e?{geoPointValue:{latitude:-90,longitude:-180}}:"geoPointValue"in e?{arrayValue:{}}:"arrayValue"in e?{mapValue:{}}:"mapValue"in e?Be:v()}function ot(e,t){const n=je(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?-1:!e.inclusive&&t.inclusive?1:0}function at(e,t){const n=je(e.value,t.value);return 0!==n?n:e.inclusive&&!t.inclusive?1:!e.inclusive&&t.inclusive?-1:0}class ut{constructor(e){this.value=e}static empty(){return new ut({mapValue:{}})}field(e){if(e.isEmpty())return this.value;{let t=this.value;for(let n=0;n<e.length-1;++n)if(t=(t.mapValue.fields||{})[e.get(n)],!tt(t))return null;return t=(t.mapValue.fields||{})[e.lastSegment()],t||null}}set(e,t){this.getFieldsMap(e.popLast())[e.lastSegment()]=nt(t)}setAll(e){let t=$.emptyPath(),n={},r=[];e.forEach(((e,s)=>{if(!t.isImmediateParentOf(s)){const e=this.getFieldsMap(t);this.applyChanges(e,n,r),n={},r=[],t=s.popLast()}e?n[s.lastSegment()]=nt(e):r.push(s.lastSegment())}));const s=this.getFieldsMap(t);this.applyChanges(s,n,r)}delete(e){const t=this.field(e.popLast());tt(t)&&t.mapValue.fields&&delete t.mapValue.fields[e.lastSegment()]}isEqual(e){return $e(this.value,e.value)}getFieldsMap(e){let t=this.value;t.mapValue.fields||(t.mapValue={fields:{}});for(let n=0;n<e.length;++n){let r=t.mapValue.fields[e.get(n)];tt(r)&&r.mapValue.fields||(r={mapValue:{fields:{}}},t.mapValue.fields[e.get(n)]=r),t=r}return t.mapValue.fields}applyChanges(e,t,n){we(t,((t,n)=>e[t]=n));for(const r of n)delete e[r]}clone(){return new ut(nt(this.value))}}function ct(e){const t=[];return we(e.fields,((e,n)=>{const r=new $([e]);if(tt(n)){const e=ct(n.mapValue).fields;if(0===e.length)t.push(r);else for(const n of e)t.push(r.child(n))}else t.push(r)})),new De(t)}class lt{constructor(e,t,n,r,s,i){this.key=e,this.documentType=t,this.version=n,this.readTime=r,this.data=s,this.documentState=i}static newInvalidDocument(e){return new lt(e,0,U.min(),U.min(),ut.empty(),0)}static newFoundDocument(e,t,n){return new lt(e,1,t,U.min(),n,0)}static newNoDocument(e,t){return new lt(e,2,t,U.min(),ut.empty(),0)}static newUnknownDocument(e,t){return new lt(e,3,t,U.min(),ut.empty(),2)}convertToFoundDocument(e,t){return this.version=e,this.documentType=1,this.data=t,this.documentState=0,this}convertToNoDocument(e){return this.version=e,this.documentType=2,this.data=ut.empty(),this.documentState=0,this}convertToUnknownDocument(e){return this.version=e,this.documentType=3,this.data=ut.empty(),this.documentState=2,this}setHasCommittedMutations(){return this.documentState=2,this}setHasLocalMutations(){return this.documentState=1,this.version=U.min(),this}setReadTime(e){return this.readTime=e,this}get hasLocalMutations(){return 1===this.documentState}get hasCommittedMutations(){return 2===this.documentState}get hasPendingWrites(){return this.hasLocalMutations||this.hasCommittedMutations}isValidDocument(){return 0!==this.documentType}isFoundDocument(){return 1===this.documentType}isNoDocument(){return 2===this.documentType}isUnknownDocument(){return 3===this.documentType}isEqual(e){return e instanceof lt&&this.key.isEqual(e.key)&&this.version.isEqual(e.version)&&this.documentType===e.documentType&&this.documentState===e.documentState&&this.data.isEqual(e.data)}mutableCopy(){return new lt(this.key,this.documentType,this.version,this.readTime,this.data.clone(),this.documentState)}toString(){return`Document(${this.key}, ${this.version}, ${JSON.stringify(this.data.value)}, {documentType: ${this.documentType}}), {documentState: ${this.documentState}})`}}class ht{constructor(e,t=null,n=[],r=[],s=null,i=null,o=null){this.path=e,this.collectionGroup=t,this.orderBy=n,this.filters=r,this.limit=s,this.startAt=i,this.endAt=o,this.ut=null}}function dt(e,t=null,n=[],r=[],s=null,i=null,o=null){return new ht(e,t,n,r,s,i,o)}function ft(e){const t=E(e);if(null===t.ut){let e=t.path.canonicalString();null!==t.collectionGroup&&(e+="|cg:"+t.collectionGroup),e+="|f:",e+=t.filters.map((e=>{return(t=e).field.canonicalString()+t.op.toString()+We(t.value);var t})).join(","),e+="|ob:",e+=t.orderBy.map((e=>function(e){return e.field.canonicalString()+e.dir}(e))).join(","),Pe(t.limit)||(e+="|l:",e+=t.limit),t.startAt&&(e+="|lb:",e+=t.startAt.inclusive?"b:":"a:",e+=t.startAt.position.map((e=>We(e))).join(",")),t.endAt&&(e+="|ub:",e+=t.endAt.inclusive?"a:":"b:",e+=t.endAt.position.map((e=>We(e))).join(",")),t.ut=e}return t.ut}function mt(e,t){if(e.limit!==t.limit)return!1;if(e.orderBy.length!==t.orderBy.length)return!1;for(let s=0;s<e.orderBy.length;s++)if(!kt(e.orderBy[s],t.orderBy[s]))return!1;if(e.filters.length!==t.filters.length)return!1;for(let s=0;s<e.filters.length;s++)if(n=e.filters[s],r=t.filters[s],n.op!==r.op||!n.field.isEqual(r.field)||!$e(n.value,r.value))return!1;var n,r;return e.collectionGroup===t.collectionGroup&&!!e.path.isEqual(t.path)&&!!Vt(e.startAt,t.startAt)&&Vt(e.endAt,t.endAt)}function gt(e){return z.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}function pt(e,t){return e.filters.filter((e=>e instanceof vt&&e.field.isEqual(t)))}function yt(e,t,n){let r=Ke,s=!0;for(const i of pt(e,t)){let e=Ke,t=!0;switch(i.op){case"<":case"<=":e=st(i.value);break;case"==":case"in":case">=":e=i.value;break;case">":e=i.value,t=!1;break;case"!=":case"not-in":e=Ke}ot({value:r,inclusive:s},{value:e,inclusive:t})<0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];ot({value:r,inclusive:s},{value:e,inclusive:n.inclusive})<0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}function wt(e,t,n){let r=Be,s=!0;for(const i of pt(e,t)){let e=Be,t=!0;switch(i.op){case">=":case">":e=it(i.value),t=!1;break;case"==":case"in":case"<=":e=i.value;break;case"<":e=i.value,t=!1;break;case"!=":case"not-in":e=Be}at({value:r,inclusive:s},{value:e,inclusive:t})>0&&(r=e,s=t)}if(null!==n)for(let i=0;i<e.orderBy.length;++i)if(e.orderBy[i].field.isEqual(t)){const e=n.position[i];at({value:r,inclusive:s},{value:e,inclusive:n.inclusive})>0&&(r=e,s=n.inclusive);break}return{value:r,inclusive:s}}class vt extends class{}{constructor(e,t,n){super(),this.field=e,this.op=t,this.value=n}static create(e,t,n){return e.isKeyField()?"in"===t||"not-in"===t?this.ct(e,t,n):new It(e,t,n):"array-contains"===t?new St(e,n):"in"===t?new xt(e,n):"not-in"===t?new Dt(e,n):"array-contains-any"===t?new _t(e,n):new vt(e,t,n)}static ct(e,t,n){return"in"===t?new bt(e,n):new Et(e,n)}matches(e){const t=e.data.field(this.field);return"!="===this.op?null!==t&&this.at(je(t,this.value)):null!==t&&Ge(this.value)===Ge(t)&&this.at(je(t,this.value))}at(e){switch(this.op){case"<":return e<0;case"<=":return e<=0;case"==":return 0===e;case"!=":return 0!==e;case">":return e>0;case">=":return e>=0;default:return v()}}ht(){return["<","<=",">",">=","!=","not-in"].indexOf(this.op)>=0}}class It extends vt{constructor(e,t,n){super(e,t,n),this.key=z.fromName(n.referenceValue)}matches(e){const t=z.comparator(e.key,this.key);return this.at(t)}}class bt extends vt{constructor(e,t){super(e,"in",t),this.keys=Tt("in",t)}matches(e){return this.keys.some((t=>t.isEqual(e.key)))}}class Et extends vt{constructor(e,t){super(e,"not-in",t),this.keys=Tt("not-in",t)}matches(e){return!this.keys.some((t=>t.isEqual(e.key)))}}function Tt(e,t){var n;return((null===(n=t.arrayValue)||void 0===n?void 0:n.values)||[]).map((e=>z.fromName(e.referenceValue)))}class St extends vt{constructor(e,t){super(e,"array-contains",t)}matches(e){const t=e.data.field(this.field);return Xe(t)&&ze(t.arrayValue,this.value)}}class xt extends vt{constructor(e,t){super(e,"in",t)}matches(e){const t=e.data.field(this.field);return null!==t&&ze(this.value.arrayValue,t)}}class Dt extends vt{constructor(e,t){super(e,"not-in",t)}matches(e){if(ze(this.value.arrayValue,{nullValue:"NULL_VALUE"}))return!1;const t=e.data.field(this.field);return null!==t&&!ze(this.value.arrayValue,t)}}class _t extends vt{constructor(e,t){super(e,"array-contains-any",t)}matches(e){const t=e.data.field(this.field);return!(!Xe(t)||!t.arrayValue.values)&&t.arrayValue.values.some((e=>ze(this.value.arrayValue,e)))}}class Nt{constructor(e,t){this.position=e,this.inclusive=t}}class At{constructor(e,t="asc"){this.field=e,this.dir=t}}function kt(e,t){return e.dir===t.dir&&e.field.isEqual(t.field)}function Ct(e,t,n){let r=0;for(let s=0;s<e.position.length;s++){const i=t[s],o=e.position[s];if(r=i.field.isKeyField()?z.comparator(z.fromName(o.referenceValue),n.key):je(o,n.data.field(i.field)),"desc"===i.dir&&(r*=-1),0!==r)break}return r}function Vt(e,t){if(null===e)return null===t;if(null===t)return!1;if(e.inclusive!==t.inclusive||e.position.length!==t.position.length)return!1;for(let n=0;n<e.position.length;n++)if(!$e(e.position[n],t.position[n]))return!1;return!0}class Mt{constructor(e,t=null,n=[],r=[],s=null,i="F",o=null,a=null){this.path=e,this.collectionGroup=t,this.explicitOrderBy=n,this.filters=r,this.limit=s,this.limitType=i,this.startAt=o,this.endAt=a,this.lt=null,this.ft=null,this.startAt,this.endAt}}function Rt(e,t,n,r,s,i,o,a){return new Mt(e,t,n,r,s,i,o,a)}function Lt(e){return new Mt(e)}function Ft(e){return e.explicitOrderBy.length>0?e.explicitOrderBy[0].field:null}function Ot(e){for(const t of e.filters)if(t.ht())return t.field;return null}function Pt(e){return null!==e.collectionGroup}function qt(e){const t=E(e);if(null===t.lt){t.lt=[];const e=Ot(t),n=Ft(t);if(null!==e&&null===n)e.isKeyField()||t.lt.push(new At(e)),t.lt.push(new At($.keyField(),"asc"));else{let e=!1;for(const n of t.explicitOrderBy)t.lt.push(n),n.field.isKeyField()&&(e=!0);if(!e){const e=t.explicitOrderBy.length>0?t.explicitOrderBy[t.explicitOrderBy.length-1].dir:"asc";t.lt.push(new At($.keyField(),e))}}}return t.lt}function Ut(e){const t=E(e);if(!t.ft)if("F"===t.limitType)t.ft=dt(t.path,t.collectionGroup,qt(t),t.filters,t.limit,t.startAt,t.endAt);else{const e=[];for(const s of qt(t)){const t="desc"===s.dir?"asc":"desc";e.push(new At(s.field,t))}const n=t.endAt?new Nt(t.endAt.position,t.endAt.inclusive):null,r=t.startAt?new Nt(t.startAt.position,t.startAt.inclusive):null;t.ft=dt(t.path,t.collectionGroup,e,t.filters,t.limit,n,r)}return t.ft}function Bt(e,t,n){return new Mt(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),t,n,e.startAt,e.endAt)}function Kt(e,t){return mt(Ut(e),Ut(t))&&e.limitType===t.limitType}function Gt(e){return`${ft(Ut(e))}|lt:${e.limitType}`}function $t(e){return`Query(target=${function(e){let t=e.path.canonicalString();return null!==e.collectionGroup&&(t+=" collectionGroup="+e.collectionGroup),e.filters.length>0&&(t+=`, filters: [${e.filters.map((e=>{return`${(t=e).field.canonicalString()} ${t.op} ${We(t.value)}`;var t})).join(", ")}]`),Pe(e.limit)||(t+=", limit: "+e.limit),e.orderBy.length>0&&(t+=`, orderBy: [${e.orderBy.map((e=>function(e){return`${e.field.canonicalString()} (${e.dir})`}(e))).join(", ")}]`),e.startAt&&(t+=", startAt: ",t+=e.startAt.inclusive?"b:":"a:",t+=e.startAt.position.map((e=>We(e))).join(",")),e.endAt&&(t+=", endAt: ",t+=e.endAt.inclusive?"a:":"b:",t+=e.endAt.position.map((e=>We(e))).join(",")),`Target(${t})`}(Ut(e))}; limitType=${e.limitType})`}function zt(e,t){return t.isFoundDocument()&&function(e,t){const n=t.key.path;return null!==e.collectionGroup?t.key.hasCollectionId(e.collectionGroup)&&e.path.isPrefixOf(n):z.isDocumentKey(e.path)?e.path.isEqual(n):e.path.isImmediateParentOf(n)}(e,t)&&function(e,t){for(const n of e.explicitOrderBy)if(!n.field.isKeyField()&&null===t.data.field(n.field))return!1;return!0}(e,t)&&function(e,t){for(const n of e.filters)if(!n.matches(t))return!1;return!0}(e,t)&&function(e,t){return!(e.startAt&&!function(e,t,n){const r=Ct(e,t,n);return e.inclusive?r<=0:r<0}(e.startAt,qt(e),t))&&!(e.endAt&&!function(e,t,n){const r=Ct(e,t,n);return e.inclusive?r>=0:r>0}(e.endAt,qt(e),t))}(e,t)}function jt(e){return e.collectionGroup||(e.path.length%2==1?e.path.lastSegment():e.path.get(e.path.length-2))}function Qt(e){return(t,n)=>{let r=!1;for(const s of qt(e)){const e=Wt(s,t,n);if(0!==e)return e;r=r||s.field.isKeyField()}return 0}}function Wt(e,t,n){const r=e.field.isKeyField()?z.comparator(t.key,n.key):function(e,t,n){const r=t.data.field(e),s=n.data.field(e);return null!==r&&null!==s?je(r,s):v()}(e.field,t,n);switch(e.dir){case"asc":return r;case"desc":return-1*r;default:return v()}}function Ht(e,t){if(e.dt){if(isNaN(t))return{doubleValue:"NaN"};if(t===1/0)return{doubleValue:"Infinity"};if(t===-1/0)return{doubleValue:"-Infinity"}}return{doubleValue:qe(t)?"-0":t}}function Jt(e){return{integerValue:""+e}}function Yt(e,t){return Ue(t)?Jt(t):Ht(e,t)}class Xt{constructor(){this._=void 0}}function Zt(e,t,n){return e instanceof nn?function(e,t){const n={fields:{__type__:{stringValue:"server_timestamp"},__local_write_time__:{timestampValue:{seconds:e.seconds,nanos:e.nanoseconds}}}};return t&&(n.fields.__previous_value__=t),{mapValue:n}}(n,t):e instanceof rn?sn(e,t):e instanceof on?an(e,t):function(e,t){const n=tn(e,t),r=cn(n)+cn(e._t);return Ye(n)&&Ye(e._t)?Jt(r):Ht(e.wt,r)}(e,t)}function en(e,t,n){return e instanceof rn?sn(e,t):e instanceof on?an(e,t):n}function tn(e,t){return e instanceof un?Ye(n=t)||function(e){return!!e&&"doubleValue"in e}(n)?t:{integerValue:0}:null;var n}class nn extends Xt{}class rn extends Xt{constructor(e){super(),this.elements=e}}function sn(e,t){const n=ln(t);for(const r of e.elements)n.some((e=>$e(e,r)))||n.push(r);return{arrayValue:{values:n}}}class on extends Xt{constructor(e){super(),this.elements=e}}function an(e,t){let n=ln(t);for(const r of e.elements)n=n.filter((e=>!$e(e,r)));return{arrayValue:{values:n}}}class un extends Xt{constructor(e,t){super(),this.wt=e,this._t=t}}function cn(e){return Ce(e.integerValue||e.doubleValue)}function ln(e){return Xe(e)&&e.arrayValue.values?e.arrayValue.values.slice():[]}class hn{constructor(e,t){this.field=e,this.transform=t}}class dn{constructor(e,t){this.version=e,this.transformResults=t}}class fn{constructor(e,t){this.updateTime=e,this.exists=t}static none(){return new fn}static exists(e){return new fn(void 0,e)}static updateTime(e){return new fn(e)}get isNone(){return void 0===this.updateTime&&void 0===this.exists}isEqual(e){return this.exists===e.exists&&(this.updateTime?!!e.updateTime&&this.updateTime.isEqual(e.updateTime):!e.updateTime)}}function mn(e,t){return void 0!==e.updateTime?t.isFoundDocument()&&t.version.isEqual(e.updateTime):void 0===e.exists||e.exists===t.isFoundDocument()}class gn{}function pn(e,t){if(!e.hasLocalMutations||t&&0===t.fields.length)return null;if(null===t)return e.isNoDocument()?new Dn(e.key,fn.none()):new bn(e.key,e.data,fn.none());{const n=e.data,r=ut.empty();let s=new Te($.comparator);for(let e of t.fields)if(!s.has(e)){let t=n.field(e);null===t&&e.length>1&&(e=e.popLast(),t=n.field(e)),null===t?r.delete(e):r.set(e,t),s=s.add(e)}return new En(e.key,r,new De(s.toArray()),fn.none())}}function yn(e,t,n){e instanceof bn?function(e,t,n){const r=e.value.clone(),s=Sn(e.fieldTransforms,t,n.transformResults);r.setAll(s),t.convertToFoundDocument(n.version,r).setHasCommittedMutations()}(e,t,n):e instanceof En?function(e,t,n){if(!mn(e.precondition,t))return void t.convertToUnknownDocument(n.version);const r=Sn(e.fieldTransforms,t,n.transformResults),s=t.data;s.setAll(Tn(e)),s.setAll(r),t.convertToFoundDocument(n.version,s).setHasCommittedMutations()}(e,t,n):function(e,t,n){t.convertToNoDocument(n.version).setHasCommittedMutations()}(0,t,n)}function wn(e,t,n,r){return e instanceof bn?function(e,t,n,r){if(!mn(e.precondition,t))return n;const s=e.value.clone(),i=xn(e.fieldTransforms,r,t);return s.setAll(i),t.convertToFoundDocument(t.version,s).setHasLocalMutations(),null}(e,t,n,r):e instanceof En?function(e,t,n,r){if(!mn(e.precondition,t))return n;const s=xn(e.fieldTransforms,r,t),i=t.data;return i.setAll(Tn(e)),i.setAll(s),t.convertToFoundDocument(t.version,i).setHasLocalMutations(),null===n?null:n.unionWith(e.fieldMask.fields).unionWith(e.fieldTransforms.map((e=>e.field)))}(e,t,n,r):function(e,t,n){return mn(e.precondition,t)?(t.convertToNoDocument(t.version).setHasLocalMutations(),null):n}(e,t,n)}function vn(e,t){let n=null;for(const r of e.fieldTransforms){const e=t.data.field(r.field),s=tn(r.transform,e||null);null!=s&&(null===n&&(n=ut.empty()),n.set(r.field,s))}return n||null}function In(e,t){return e.type===t.type&&!!e.key.isEqual(t.key)&&!!e.precondition.isEqual(t.precondition)&&!!function(e,t){return void 0===e&&void 0===t||!(!e||!t)&&O(e,t,((e,t)=>function(e,t){return e.field.isEqual(t.field)&&function(e,t){return e instanceof rn&&t instanceof rn||e instanceof on&&t instanceof on?O(e.elements,t.elements,$e):e instanceof un&&t instanceof un?$e(e._t,t._t):e instanceof nn&&t instanceof nn}(e.transform,t.transform)}(e,t)))}(e.fieldTransforms,t.fieldTransforms)&&(0===e.type?e.value.isEqual(t.value):1!==e.type||e.data.isEqual(t.data)&&e.fieldMask.isEqual(t.fieldMask))}class bn extends gn{constructor(e,t,n,r=[]){super(),this.key=e,this.value=t,this.precondition=n,this.fieldTransforms=r,this.type=0}getFieldMask(){return null}}class En extends gn{constructor(e,t,n,r,s=[]){super(),this.key=e,this.data=t,this.fieldMask=n,this.precondition=r,this.fieldTransforms=s,this.type=1}getFieldMask(){return this.fieldMask}}function Tn(e){const t=new Map;return e.fieldMask.fields.forEach((n=>{if(!n.isEmpty()){const r=e.data.field(n);t.set(n,r)}})),t}function Sn(e,t,n){const r=new Map;I(e.length===n.length);for(let s=0;s<n.length;s++){const i=e[s],o=i.transform,a=t.data.field(i.field);r.set(i.field,en(o,a,n[s]))}return r}function xn(e,t,n){const r=new Map;for(const s of e){const e=s.transform,i=n.data.field(s.field);r.set(s.field,Zt(e,i,t))}return r}class Dn extends gn{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=2,this.fieldTransforms=[]}getFieldMask(){return null}}class _n extends gn{constructor(e,t){super(),this.key=e,this.precondition=t,this.type=3,this.fieldTransforms=[]}getFieldMask(){return null}}class Nn{constructor(e){this.count=e}}var An,kn;function Cn(e){switch(e){default:return v();case T.CANCELLED:case T.UNKNOWN:case T.DEADLINE_EXCEEDED:case T.RESOURCE_EXHAUSTED:case T.INTERNAL:case T.UNAVAILABLE:case T.UNAUTHENTICATED:return!1;case T.INVALID_ARGUMENT:case T.NOT_FOUND:case T.ALREADY_EXISTS:case T.PERMISSION_DENIED:case T.FAILED_PRECONDITION:case T.ABORTED:case T.OUT_OF_RANGE:case T.UNIMPLEMENTED:case T.DATA_LOSS:return!0}}function Vn(e){if(void 0===e)return p("GRPC error has no .code"),T.UNKNOWN;switch(e){case An.OK:return T.OK;case An.CANCELLED:return T.CANCELLED;case An.UNKNOWN:return T.UNKNOWN;case An.DEADLINE_EXCEEDED:return T.DEADLINE_EXCEEDED;case An.RESOURCE_EXHAUSTED:return T.RESOURCE_EXHAUSTED;case An.INTERNAL:return T.INTERNAL;case An.UNAVAILABLE:return T.UNAVAILABLE;case An.UNAUTHENTICATED:return T.UNAUTHENTICATED;case An.INVALID_ARGUMENT:return T.INVALID_ARGUMENT;case An.NOT_FOUND:return T.NOT_FOUND;case An.ALREADY_EXISTS:return T.ALREADY_EXISTS;case An.PERMISSION_DENIED:return T.PERMISSION_DENIED;case An.FAILED_PRECONDITION:return T.FAILED_PRECONDITION;case An.ABORTED:return T.ABORTED;case An.OUT_OF_RANGE:return T.OUT_OF_RANGE;case An.UNIMPLEMENTED:return T.UNIMPLEMENTED;case An.DATA_LOSS:return T.DATA_LOSS;default:return v()}}(kn=An||(An={}))[kn.OK=0]="OK",kn[kn.CANCELLED=1]="CANCELLED",kn[kn.UNKNOWN=2]="UNKNOWN",kn[kn.INVALID_ARGUMENT=3]="INVALID_ARGUMENT",kn[kn.DEADLINE_EXCEEDED=4]="DEADLINE_EXCEEDED",kn[kn.NOT_FOUND=5]="NOT_FOUND",kn[kn.ALREADY_EXISTS=6]="ALREADY_EXISTS",kn[kn.PERMISSION_DENIED=7]="PERMISSION_DENIED",kn[kn.UNAUTHENTICATED=16]="UNAUTHENTICATED",kn[kn.RESOURCE_EXHAUSTED=8]="RESOURCE_EXHAUSTED",kn[kn.FAILED_PRECONDITION=9]="FAILED_PRECONDITION",kn[kn.ABORTED=10]="ABORTED",kn[kn.OUT_OF_RANGE=11]="OUT_OF_RANGE",kn[kn.UNIMPLEMENTED=12]="UNIMPLEMENTED",kn[kn.INTERNAL=13]="INTERNAL",kn[kn.UNAVAILABLE=14]="UNAVAILABLE",kn[kn.DATA_LOSS=15]="DATA_LOSS";class Mn{constructor(e,t){this.mapKeyFn=e,this.equalsFn=t,this.inner={},this.innerSize=0}get(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0!==n)for(const[r,s]of n)if(this.equalsFn(r,e))return s}has(e){return void 0!==this.get(e)}set(e,t){const n=this.mapKeyFn(e),r=this.inner[n];if(void 0===r)return this.inner[n]=[[e,t]],void this.innerSize++;for(let s=0;s<r.length;s++)if(this.equalsFn(r[s][0],e))return void(r[s]=[e,t]);r.push([e,t]),this.innerSize++}delete(e){const t=this.mapKeyFn(e),n=this.inner[t];if(void 0===n)return!1;for(let r=0;r<n.length;r++)if(this.equalsFn(n[r][0],e))return 1===n.length?delete this.inner[t]:n.splice(r,1),this.innerSize--,!0;return!1}forEach(e){we(this.inner,((t,n)=>{for(const[r,s]of n)e(r,s)}))}isEmpty(){return ve(this.inner)}size(){return this.innerSize}}const Rn=new Ie(z.comparator);function Ln(){return Rn}const Fn=new Ie(z.comparator);function On(...e){let t=Fn;for(const n of e)t=t.insert(n.key,n);return t}function Pn(e){let t=Fn;return e.forEach(((e,n)=>t=t.insert(e,n.overlayedDocument))),t}function qn(){return Bn()}function Un(){return Bn()}function Bn(){return new Mn((e=>e.toString()),((e,t)=>e.isEqual(t)))}const Kn=new Ie(z.comparator),Gn=new Te(z.comparator);function $n(...e){let t=Gn;for(const n of e)t=t.add(n);return t}const zn=new Te(F);function jn(){return zn}class Qn{constructor(e,t,n,r,s){this.snapshotVersion=e,this.targetChanges=t,this.targetMismatches=n,this.documentUpdates=r,this.resolvedLimboDocuments=s}static createSynthesizedRemoteEventForCurrentChange(e,t){const n=new Map;return n.set(e,Wn.createSynthesizedTargetChangeForCurrentChange(e,t)),new Qn(U.min(),n,jn(),Ln(),$n())}}class Wn{constructor(e,t,n,r,s){this.resumeToken=e,this.current=t,this.addedDocuments=n,this.modifiedDocuments=r,this.removedDocuments=s}static createSynthesizedTargetChangeForCurrentChange(e,t){return new Wn(Ne.EMPTY_BYTE_STRING,t,$n(),$n(),$n())}}class Hn{constructor(e,t,n,r){this.gt=e,this.removedTargetIds=t,this.key=n,this.yt=r}}class Jn{constructor(e,t){this.targetId=e,this.It=t}}class Yn{constructor(e,t,n=Ne.EMPTY_BYTE_STRING,r=null){this.state=e,this.targetIds=t,this.resumeToken=n,this.cause=r}}class Xn{constructor(){this.Tt=0,this.Et=tr(),this.At=Ne.EMPTY_BYTE_STRING,this.Rt=!1,this.bt=!0}get current(){return this.Rt}get resumeToken(){return this.At}get Pt(){return 0!==this.Tt}get vt(){return this.bt}Vt(e){e.approximateByteSize()>0&&(this.bt=!0,this.At=e)}St(){let e=$n(),t=$n(),n=$n();return this.Et.forEach(((r,s)=>{switch(s){case 0:e=e.add(r);break;case 2:t=t.add(r);break;case 1:n=n.add(r);break;default:v()}})),new Wn(this.At,this.Rt,e,t,n)}Dt(){this.bt=!1,this.Et=tr()}Ct(e,t){this.bt=!0,this.Et=this.Et.insert(e,t)}xt(e){this.bt=!0,this.Et=this.Et.remove(e)}Nt(){this.Tt+=1}kt(){this.Tt-=1}Ot(){this.bt=!0,this.Rt=!0}}class Zn{constructor(e){this.Mt=e,this.Ft=new Map,this.$t=Ln(),this.Bt=er(),this.Lt=new Te(F)}Ut(e){for(const t of e.gt)e.yt&&e.yt.isFoundDocument()?this.qt(t,e.yt):this.Kt(t,e.key,e.yt);for(const t of e.removedTargetIds)this.Kt(t,e.key,e.yt)}Gt(e){this.forEachTarget(e,(t=>{const n=this.Qt(t);switch(e.state){case 0:this.jt(t)&&n.Vt(e.resumeToken);break;case 1:n.kt(),n.Pt||n.Dt(),n.Vt(e.resumeToken);break;case 2:n.kt(),n.Pt||this.removeTarget(t);break;case 3:this.jt(t)&&(n.Ot(),n.Vt(e.resumeToken));break;case 4:this.jt(t)&&(this.Wt(t),n.Vt(e.resumeToken));break;default:v()}}))}forEachTarget(e,t){e.targetIds.length>0?e.targetIds.forEach(t):this.Ft.forEach(((e,n)=>{this.jt(n)&&t(n)}))}zt(e){const t=e.targetId,n=e.It.count,r=this.Ht(t);if(r){const e=r.target;if(gt(e))if(0===n){const n=new z(e.path);this.Kt(t,n,lt.newNoDocument(n,U.min()))}else I(1===n);else this.Jt(t)!==n&&(this.Wt(t),this.Lt=this.Lt.add(t))}}Yt(e){const t=new Map;this.Ft.forEach(((n,r)=>{const s=this.Ht(r);if(s){if(n.current&&gt(s.target)){const t=new z(s.target.path);null!==this.$t.get(t)||this.Xt(r,t)||this.Kt(r,t,lt.newNoDocument(t,e))}n.vt&&(t.set(r,n.St()),n.Dt())}}));let n=$n();this.Bt.forEach(((e,t)=>{let r=!0;t.forEachWhile((e=>{const t=this.Ht(e);return!t||2===t.purpose||(r=!1,!1)})),r&&(n=n.add(e))})),this.$t.forEach(((t,n)=>n.setReadTime(e)));const r=new Qn(e,t,this.Lt,this.$t,n);return this.$t=Ln(),this.Bt=er(),this.Lt=new Te(F),r}qt(e,t){if(!this.jt(e))return;const n=this.Xt(e,t.key)?2:0;this.Qt(e).Ct(t.key,n),this.$t=this.$t.insert(t.key,t),this.Bt=this.Bt.insert(t.key,this.Zt(t.key).add(e))}Kt(e,t,n){if(!this.jt(e))return;const r=this.Qt(e);this.Xt(e,t)?r.Ct(t,1):r.xt(t),this.Bt=this.Bt.insert(t,this.Zt(t).delete(e)),n&&(this.$t=this.$t.insert(t,n))}removeTarget(e){this.Ft.delete(e)}Jt(e){const t=this.Qt(e).St();return this.Mt.getRemoteKeysForTarget(e).size+t.addedDocuments.size-t.removedDocuments.size}Nt(e){this.Qt(e).Nt()}Qt(e){let t=this.Ft.get(e);return t||(t=new Xn,this.Ft.set(e,t)),t}Zt(e){let t=this.Bt.get(e);return t||(t=new Te(F),this.Bt=this.Bt.insert(e,t)),t}jt(e){const t=null!==this.Ht(e);return t||g("WatchChangeAggregator","Detected inactive target",e),t}Ht(e){const t=this.Ft.get(e);return t&&t.Pt?null:this.Mt.te(e)}Wt(e){this.Ft.set(e,new Xn),this.Mt.getRemoteKeysForTarget(e).forEach((t=>{this.Kt(e,t,null)}))}Xt(e,t){return this.Mt.getRemoteKeysForTarget(e).has(t)}}function er(){return new Ie(z.comparator)}function tr(){return new Ie(z.comparator)}const nr={asc:"ASCENDING",desc:"DESCENDING"},rr={"<":"LESS_THAN","<=":"LESS_THAN_OR_EQUAL",">":"GREATER_THAN",">=":"GREATER_THAN_OR_EQUAL","==":"EQUAL","!=":"NOT_EQUAL","array-contains":"ARRAY_CONTAINS",in:"IN","not-in":"NOT_IN","array-contains-any":"ARRAY_CONTAINS_ANY"};class sr{constructor(e,t){this.databaseId=e,this.dt=t}}function ir(e,t){return e.dt?`${new Date(1e3*t.seconds).toISOString().replace(/\.\d*/,"").replace("Z","")}.${("000000000"+t.nanoseconds).slice(-9)}Z`:{seconds:""+t.seconds,nanos:t.nanoseconds}}function or(e,t){return e.dt?t.toBase64():t.toUint8Array()}function ar(e,t){return ir(e,t.toTimestamp())}function ur(e){return I(!!e),U.fromTimestamp(function(e){const t=ke(e);return new q(t.seconds,t.nanos)}(e))}function cr(e,t){return function(e){return new K(["projects",e.projectId,"databases",e.database])}(e).child("documents").child(t).canonicalString()}function lr(e){const t=K.fromString(e);return I(Vr(t)),t}function hr(e,t){return cr(e.databaseId,t.path)}function dr(e,t){const n=lr(t);if(n.get(1)!==e.databaseId.projectId)throw new S(T.INVALID_ARGUMENT,"Tried to deserialize key from different project: "+n.get(1)+" vs "+e.databaseId.projectId);if(n.get(3)!==e.databaseId.database)throw new S(T.INVALID_ARGUMENT,"Tried to deserialize key from different database: "+n.get(3)+" vs "+e.databaseId.database);return new z(pr(n))}function fr(e,t){return cr(e.databaseId,t)}function mr(e){const t=lr(e);return 4===t.length?K.emptyPath():pr(t)}function gr(e){return new K(["projects",e.databaseId.projectId,"databases",e.databaseId.database]).canonicalString()}function pr(e){return I(e.length>4&&"documents"===e.get(4)),e.popFirst(5)}function yr(e,t,n){return{name:hr(e,t),fields:n.value.mapValue.fields}}function wr(e,t,n){const r=dr(e,t.name),s=ur(t.updateTime),i=new ut({mapValue:{fields:t.fields}}),o=lt.newFoundDocument(r,s,i);return n&&o.setHasCommittedMutations(),n?o.setHasCommittedMutations():o}function vr(e,t){let n;if(t instanceof bn)n={update:yr(e,t.key,t.value)};else if(t instanceof Dn)n={delete:hr(e,t.key)};else if(t instanceof En)n={update:yr(e,t.key,t.data),updateMask:Cr(t.fieldMask)};else{if(!(t instanceof _n))return v();n={verify:hr(e,t.key)}}return t.fieldTransforms.length>0&&(n.updateTransforms=t.fieldTransforms.map((e=>function(e,t){const n=t.transform;if(n instanceof nn)return{fieldPath:t.field.canonicalString(),setToServerValue:"REQUEST_TIME"};if(n instanceof rn)return{fieldPath:t.field.canonicalString(),appendMissingElements:{values:n.elements}};if(n instanceof on)return{fieldPath:t.field.canonicalString(),removeAllFromArray:{values:n.elements}};if(n instanceof un)return{fieldPath:t.field.canonicalString(),increment:n._t};throw v()}(0,e)))),t.precondition.isNone||(n.currentDocument=function(e,t){return void 0!==t.updateTime?{updateTime:ar(e,t.updateTime)}:void 0!==t.exists?{exists:t.exists}:v()}(e,t.precondition)),n}function Ir(e,t){const n=t.currentDocument?function(e){return void 0!==e.updateTime?fn.updateTime(ur(e.updateTime)):void 0!==e.exists?fn.exists(e.exists):fn.none()}(t.currentDocument):fn.none(),r=t.updateTransforms?t.updateTransforms.map((t=>function(e,t){let n=null;if("setToServerValue"in t)I("REQUEST_TIME"===t.setToServerValue),n=new nn;else if("appendMissingElements"in t){const e=t.appendMissingElements.values||[];n=new rn(e)}else if("removeAllFromArray"in t){const e=t.removeAllFromArray.values||[];n=new on(e)}else"increment"in t?n=new un(e,t.increment):v();const r=$.fromServerFormat(t.fieldPath);return new hn(r,n)}(e,t))):[];if(t.update){t.update.name;const s=dr(e,t.update.name),i=new ut({mapValue:{fields:t.update.fields}});if(t.updateMask){const e=function(e){const t=e.fieldPaths||[];return new De(t.map((e=>$.fromServerFormat(e))))}(t.updateMask);return new En(s,i,e,n,r)}return new bn(s,i,n,r)}if(t.delete){const r=dr(e,t.delete);return new Dn(r,n)}if(t.verify){const r=dr(e,t.verify);return new _n(r,n)}return v()}function br(e,t){return{documents:[fr(e,t.path)]}}function Er(e,t){const n={structuredQuery:{}},r=t.path;null!==t.collectionGroup?(n.parent=fr(e,r),n.structuredQuery.from=[{collectionId:t.collectionGroup,allDescendants:!0}]):(n.parent=fr(e,r.popLast()),n.structuredQuery.from=[{collectionId:r.lastSegment()}]);const s=function(e){if(0===e.length)return;const t=e.map((e=>function(e){if("=="===e.op){if(et(e.value))return{unaryFilter:{field:_r(e.field),op:"IS_NAN"}};if(Ze(e.value))return{unaryFilter:{field:_r(e.field),op:"IS_NULL"}}}else if("!="===e.op){if(et(e.value))return{unaryFilter:{field:_r(e.field),op:"IS_NOT_NAN"}};if(Ze(e.value))return{unaryFilter:{field:_r(e.field),op:"IS_NOT_NULL"}}}return{fieldFilter:{field:_r(e.field),op:Dr(e.op),value:e.value}}}(e)));return 1===t.length?t[0]:{compositeFilter:{op:"AND",filters:t}}}(t.filters);s&&(n.structuredQuery.where=s);const i=function(e){if(0!==e.length)return e.map((e=>function(e){return{field:_r(e.field),direction:xr(e.dir)}}(e)))}(t.orderBy);i&&(n.structuredQuery.orderBy=i);const o=function(e,t){return e.dt||Pe(t)?t:{value:t}}(e,t.limit);var a;return null!==o&&(n.structuredQuery.limit=o),t.startAt&&(n.structuredQuery.startAt={before:(a=t.startAt).inclusive,values:a.position}),t.endAt&&(n.structuredQuery.endAt=function(e){return{before:!e.inclusive,values:e.position}}(t.endAt)),n}function Tr(e){let t=mr(e.parent);const n=e.structuredQuery,r=n.from?n.from.length:0;let s=null;if(r>0){I(1===r);const e=n.from[0];e.allDescendants?s=e.collectionId:t=t.child(e.collectionId)}let i=[];n.where&&(i=Sr(n.where));let o=[];n.orderBy&&(o=n.orderBy.map((e=>function(e){return new At(Nr(e.field),function(e){switch(e){case"ASCENDING":return"asc";case"DESCENDING":return"desc";default:return}}(e.direction))}(e))));let a=null;n.limit&&(a=function(e){let t;return t="object"==typeof e?e.value:e,Pe(t)?null:t}(n.limit));let u=null;n.startAt&&(u=function(e){const t=!!e.before,n=e.values||[];return new Nt(n,t)}(n.startAt));let c=null;return n.endAt&&(c=function(e){const t=!e.before,n=e.values||[];return new Nt(n,t)}(n.endAt)),Rt(t,s,o,i,a,"F",u,c)}function Sr(e){return e?void 0!==e.unaryFilter?[kr(e)]:void 0!==e.fieldFilter?[Ar(e)]:void 0!==e.compositeFilter?e.compositeFilter.filters.map((e=>Sr(e))).reduce(((e,t)=>e.concat(t))):v():[]}function xr(e){return nr[e]}function Dr(e){return rr[e]}function _r(e){return{fieldPath:e.canonicalString()}}function Nr(e){return $.fromServerFormat(e.fieldPath)}function Ar(e){return vt.create(Nr(e.fieldFilter.field),function(e){switch(e){case"EQUAL":return"==";case"NOT_EQUAL":return"!=";case"GREATER_THAN":return">";case"GREATER_THAN_OR_EQUAL":return">=";case"LESS_THAN":return"<";case"LESS_THAN_OR_EQUAL":return"<=";case"ARRAY_CONTAINS":return"array-contains";case"IN":return"in";case"NOT_IN":return"not-in";case"ARRAY_CONTAINS_ANY":return"array-contains-any";default:return v()}}(e.fieldFilter.op),e.fieldFilter.value)}function kr(e){switch(e.unaryFilter.op){case"IS_NAN":const t=Nr(e.unaryFilter.field);return vt.create(t,"==",{doubleValue:NaN});case"IS_NULL":const n=Nr(e.unaryFilter.field);return vt.create(n,"==",{nullValue:"NULL_VALUE"});case"IS_NOT_NAN":const r=Nr(e.unaryFilter.field);return vt.create(r,"!=",{doubleValue:NaN});case"IS_NOT_NULL":const s=Nr(e.unaryFilter.field);return vt.create(s,"!=",{nullValue:"NULL_VALUE"});default:return v()}}function Cr(e){const t=[];return e.fields.forEach((e=>t.push(e.canonicalString()))),{fieldPaths:t}}function Vr(e){return e.length>=4&&"projects"===e.get(0)&&"databases"===e.get(2)}function Mr(e){let t="";for(let n=0;n<e.length;n++)t.length>0&&(t=Lr(t)),t=Rr(e.get(n),t);return Lr(t)}function Rr(e,t){let n=t;const r=e.length;for(let s=0;s<r;s++){const t=e.charAt(s);switch(t){case"\0":n+="\x01\x10";break;case"\x01":n+="\x01\x11";break;default:n+=t}}return n}function Lr(e){return e+"\x01\x01"}function Fr(e){const t=e.length;if(I(t>=2),2===t)return I("\x01"===e.charAt(0)&&"\x01"===e.charAt(1)),K.emptyPath();const n=t-2,r=[];let s="";for(let i=0;i<t;){const t=e.indexOf("\x01",i);switch((t<0||t>n)&&v(),e.charAt(t+1)){case"\x01":const n=e.substring(i,t);let o;0===s.length?o=n:(s+=n,o=s,s=""),r.push(o);break;case"\x10":s+=e.substring(i,t),s+="\0";break;case"\x11":s+=e.substring(i,t+1);break;default:v()}i=t+2}return new K(r)}const Or=["userId","batchId"];function Pr(e,t){return[e,Mr(t)]}function qr(e,t,n){return[e,Mr(t),n]}const Ur={},Br=["prefixPath","collectionGroup","readTime","documentId"],Kr=["prefixPath","collectionGroup","documentId"],Gr=["collectionGroup","readTime","prefixPath","documentId"],$r=["canonicalId","targetId"],zr=["targetId","path"],jr=["path","targetId"],Qr=["collectionId","parent"],Wr=["indexId","uid"],Hr=["uid","sequenceNumber"],Jr=["indexId","uid","arrayValue","directionalValue","orderedDocumentKey","documentKey"],Yr=["indexId","uid","orderedDocumentKey"],Xr=["userId","collectionPath","documentId"],Zr=["userId","collectionPath","largestBatchId"],es=["userId","collectionGroup","largestBatchId"],ts=["mutationQueues","mutations","documentMutations","remoteDocuments","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries"],ns=[...ts,"documentOverlays"],rs=["mutationQueues","mutations","documentMutations","remoteDocumentsV14","targets","owner","targetGlobal","targetDocuments","clientMetadata","remoteDocumentGlobal","collectionParents","bundles","namedQueries","documentOverlays"],ss=rs,is=[...ss,"indexConfiguration","indexState","indexEntries"];class os extends ne{constructor(e,t){super(),this.ee=e,this.currentSequenceNumber=t}}function as(e,t){const n=E(e);return oe.N(n.ee,t)}class us{constructor(e,t,n,r){this.batchId=e,this.localWriteTime=t,this.baseMutations=n,this.mutations=r}applyToRemoteDocument(e,t){const n=t.mutationResults;for(let r=0;r<this.mutations.length;r++){const t=this.mutations[r];t.key.isEqual(e.key)&&yn(t,e,n[r])}}applyToLocalView(e,t){for(const n of this.baseMutations)n.key.isEqual(e.key)&&(t=wn(n,e,t,this.localWriteTime));for(const n of this.mutations)n.key.isEqual(e.key)&&(t=wn(n,e,t,this.localWriteTime));return t}applyToLocalDocumentSet(e,t){const n=Un();return this.mutations.forEach((r=>{const s=e.get(r.key),i=s.overlayedDocument;let o=this.applyToLocalView(i,s.mutatedFields);o=t.has(r.key)?null:o;const a=pn(i,o);null!==a&&n.set(r.key,a),i.isValidDocument()||i.convertToNoDocument(U.min())})),n}keys(){return this.mutations.reduce(((e,t)=>e.add(t.key)),$n())}isEqual(e){return this.batchId===e.batchId&&O(this.mutations,e.mutations,((e,t)=>In(e,t)))&&O(this.baseMutations,e.baseMutations,((e,t)=>In(e,t)))}}class cs{constructor(e,t,n,r){this.batch=e,this.commitVersion=t,this.mutationResults=n,this.docVersions=r}static from(e,t,n){I(e.mutations.length===n.length);let r=Kn;const s=e.mutations;for(let i=0;i<s.length;i++)r=r.insert(s[i].key,n[i].version);return new cs(e,t,n,r)}}class ls{constructor(e,t){this.largestBatchId=e,this.mutation=t}getKey(){return this.mutation.key}isEqual(e){return null!==e&&this.mutation===e.mutation}toString(){return`Overlay{\n      largestBatchId: ${this.largestBatchId},\n      mutation: ${this.mutation.toString()}\n    }`}}class hs{constructor(e,t,n,r,s=U.min(),i=U.min(),o=Ne.EMPTY_BYTE_STRING){this.target=e,this.targetId=t,this.purpose=n,this.sequenceNumber=r,this.snapshotVersion=s,this.lastLimboFreeSnapshotVersion=i,this.resumeToken=o}withSequenceNumber(e){return new hs(this.target,this.targetId,this.purpose,e,this.snapshotVersion,this.lastLimboFreeSnapshotVersion,this.resumeToken)}withResumeToken(e,t){return new hs(this.target,this.targetId,this.purpose,this.sequenceNumber,t,this.lastLimboFreeSnapshotVersion,e)}withLastLimboFreeSnapshotVersion(e){return new hs(this.target,this.targetId,this.purpose,this.sequenceNumber,this.snapshotVersion,e,this.resumeToken)}}class ds{constructor(e){this.ne=e}}function fs(e,t){const n=t.key,r={prefixPath:n.getCollectionPath().popLast().toArray(),collectionGroup:n.collectionGroup,documentId:n.path.lastSegment(),readTime:ms(t.readTime),hasCommittedMutations:t.hasCommittedMutations};if(t.isFoundDocument())r.document=function(e,t){return{name:hr(e,t.key),fields:t.data.value.mapValue.fields,updateTime:ir(e,t.version.toTimestamp())}}(e.ne,t);else if(t.isNoDocument())r.noDocument={path:n.path.toArray(),readTime:gs(t.version)};else{if(!t.isUnknownDocument())return v();r.unknownDocument={path:n.path.toArray(),version:gs(t.version)}}return r}function ms(e){const t=e.toTimestamp();return[t.seconds,t.nanoseconds]}function gs(e){const t=e.toTimestamp();return{seconds:t.seconds,nanoseconds:t.nanoseconds}}function ps(e){const t=new q(e.seconds,e.nanoseconds);return U.fromTimestamp(t)}function ys(e,t){const n=(t.baseMutations||[]).map((t=>Ir(e.ne,t)));for(let i=0;i<t.mutations.length-1;++i){const e=t.mutations[i];if(i+1<t.mutations.length&&void 0!==t.mutations[i+1].transform){const n=t.mutations[i+1];e.updateTransforms=n.transform.fieldTransforms,t.mutations.splice(i+1,1),++i}}const r=t.mutations.map((t=>Ir(e.ne,t))),s=q.fromMillis(t.localWriteTimeMs);return new us(t.batchId,s,n,r)}function ws(e){const t=ps(e.readTime),n=void 0!==e.lastLimboFreeSnapshotVersion?ps(e.lastLimboFreeSnapshotVersion):U.min();let r;var s;return void 0!==e.query.documents?(I(1===(s=e.query).documents.length),r=Ut(Lt(mr(s.documents[0])))):r=function(e){return Ut(Tr(e))}(e.query),new hs(r,e.targetId,0,e.lastListenSequenceNumber,t,n,Ne.fromBase64String(e.resumeToken))}function vs(e,t){const n=gs(t.snapshotVersion),r=gs(t.lastLimboFreeSnapshotVersion);let s;s=gt(t.target)?br(e.ne,t.target):Er(e.ne,t.target);const i=t.resumeToken.toBase64();return{targetId:t.targetId,canonicalId:ft(t.target),readTime:n,resumeToken:i,lastListenSequenceNumber:t.sequenceNumber,lastLimboFreeSnapshotVersion:r,query:s}}function Is(e){const t=Tr({parent:e.parent,structuredQuery:e.structuredQuery});return"LAST"===e.limitType?Bt(t,t.limit,"L"):t}function bs(e,t){return new ls(t.largestBatchId,Ir(e.ne,t.overlayMutation))}function Es(e,t){const n=t.path.lastSegment();return[e,Mr(t.path.popLast()),n]}function Ts(e,t,n,r){return{indexId:e,uid:t.uid||"",sequenceNumber:n,readTime:gs(r.readTime),documentKey:Mr(r.documentKey.path),largestBatchId:r.largestBatchId}}class Ss{getBundleMetadata(e,t){return xs(e).get(t).next((e=>{if(e)return{id:(t=e).bundleId,createTime:ps(t.createTime),version:t.version};var t}))}saveBundleMetadata(e,t){return xs(e).put({bundleId:(n=t).id,createTime:gs(ur(n.createTime)),version:n.version});var n}getNamedQuery(e,t){return Ds(e).get(t).next((e=>{if(e)return{name:(t=e).name,query:Is(t.bundledQuery),readTime:ps(t.readTime)};var t}))}saveNamedQuery(e,t){return Ds(e).put(function(e){return{name:e.name,readTime:gs(ur(e.readTime)),bundledQuery:e.bundledQuery}}(t))}}function xs(e){return as(e,"bundles")}function Ds(e){return as(e,"namedQueries")}class _s{constructor(e,t){this.wt=e,this.userId=t}static se(e,t){const n=t.uid||"";return new _s(e,n)}getOverlay(e,t){return Ns(e).get(Es(this.userId,t)).next((e=>e?bs(this.wt,e):null))}getOverlays(e,t){const n=qn();return se.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){const r=[];return n.forEach(((n,s)=>{const i=new ls(t,s);r.push(this.ie(e,i))})),se.waitFor(r)}removeOverlaysForBatchId(e,t,n){const r=new Set;t.forEach((e=>r.add(Mr(e.getCollectionPath()))));const s=[];return r.forEach((t=>{const r=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,n+1],!1,!0);s.push(Ns(e).W("collectionPathOverlayIndex",r))})),se.waitFor(s)}getOverlaysForCollection(e,t,n){const r=qn(),s=Mr(t),i=IDBKeyRange.bound([this.userId,s,n],[this.userId,s,Number.POSITIVE_INFINITY],!0);return Ns(e).K("collectionPathOverlayIndex",i).next((e=>{for(const t of e){const e=bs(this.wt,t);r.set(e.getKey(),e)}return r}))}getOverlaysForCollectionGroup(e,t,n,r){const s=qn();let i;const o=IDBKeyRange.bound([this.userId,t,n],[this.userId,t,Number.POSITIVE_INFINITY],!0);return Ns(e).J({index:"collectionGroupOverlayIndex",range:o},((e,t,n)=>{const o=bs(this.wt,t);s.size()<r||o.largestBatchId===i?(s.set(o.getKey(),o),i=o.largestBatchId):n.done()})).next((()=>s))}ie(e,t){return Ns(e).put(function(e,t,n){const[r,s,i]=Es(t,n.mutation.key);return{userId:t,collectionPath:s,documentId:i,collectionGroup:n.mutation.key.getCollectionGroup(),largestBatchId:n.largestBatchId,overlayMutation:vr(e.ne,n.mutation)}}(this.wt,this.userId,t))}}function Ns(e){return as(e,"documentOverlays")}class As{constructor(){}re(e,t){this.oe(e,t),t.ue()}oe(e,t){if("nullValue"in e)this.ce(t,5);else if("booleanValue"in e)this.ce(t,10),t.ae(e.booleanValue?1:0);else if("integerValue"in e)this.ce(t,15),t.ae(Ce(e.integerValue));else if("doubleValue"in e){const n=Ce(e.doubleValue);isNaN(n)?this.ce(t,13):(this.ce(t,15),qe(n)?t.ae(0):t.ae(n))}else if("timestampValue"in e){const n=e.timestampValue;this.ce(t,20),"string"==typeof n?t.he(n):(t.he(`${n.seconds||""}`),t.ae(n.nanos||0))}else if("stringValue"in e)this.le(e.stringValue,t),this.fe(t);else if("bytesValue"in e)this.ce(t,30),t.de(Ve(e.bytesValue)),this.fe(t);else if("referenceValue"in e)this._e(e.referenceValue,t);else if("geoPointValue"in e){const n=e.geoPointValue;this.ce(t,45),t.ae(n.latitude||0),t.ae(n.longitude||0)}else"mapValue"in e?rt(e)?this.ce(t,Number.MAX_SAFE_INTEGER):(this.we(e.mapValue,t),this.fe(t)):"arrayValue"in e?(this.me(e.arrayValue,t),this.fe(t)):v()}le(e,t){this.ce(t,25),this.ge(e,t)}ge(e,t){t.he(e)}we(e,t){const n=e.fields||{};this.ce(t,55);for(const r of Object.keys(n))this.le(r,t),this.oe(n[r],t)}me(e,t){const n=e.values||[];this.ce(t,50);for(const r of n)this.oe(r,t)}_e(e,t){this.ce(t,37),z.fromName(e).path.forEach((e=>{this.ce(t,60),this.ge(e,t)}))}ce(e,t){e.ae(t)}fe(e){e.ae(2)}}function ks(e){if(0===e)return 8;let t=0;return e>>4==0&&(t+=4,e<<=4),e>>6==0&&(t+=2,e<<=2),e>>7==0&&(t+=1),t}function Cs(e){const t=64-function(e){let t=0;for(let n=0;n<8;++n){const r=ks(255&e[n]);if(t+=r,8!==r)break}return t}(e);return Math.ceil(t/8)}As.ye=new As;class Vs{constructor(){this.buffer=new Uint8Array(1024),this.position=0}pe(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ie(n.value),n=t.next();this.Te()}Ee(e){const t=e[Symbol.iterator]();let n=t.next();for(;!n.done;)this.Ae(n.value),n=t.next();this.Re()}be(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ie(e);else if(e<2048)this.Ie(960|e>>>6),this.Ie(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ie(480|e>>>12),this.Ie(128|63&e>>>6),this.Ie(128|63&e);else{const e=t.codePointAt(0);this.Ie(240|e>>>18),this.Ie(128|63&e>>>12),this.Ie(128|63&e>>>6),this.Ie(128|63&e)}}this.Te()}Pe(e){for(const t of e){const e=t.charCodeAt(0);if(e<128)this.Ae(e);else if(e<2048)this.Ae(960|e>>>6),this.Ae(128|63&e);else if(t<"\ud800"||"\udbff"<t)this.Ae(480|e>>>12),this.Ae(128|63&e>>>6),this.Ae(128|63&e);else{const e=t.codePointAt(0);this.Ae(240|e>>>18),this.Ae(128|63&e>>>12),this.Ae(128|63&e>>>6),this.Ae(128|63&e)}}this.Re()}ve(e){const t=this.Ve(e),n=Cs(t);this.Se(1+n),this.buffer[this.position++]=255&n;for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=255&t[r]}De(e){const t=this.Ve(e),n=Cs(t);this.Se(1+n),this.buffer[this.position++]=~(255&n);for(let r=t.length-n;r<t.length;++r)this.buffer[this.position++]=~(255&t[r])}Ce(){this.xe(255),this.xe(255)}Ne(){this.ke(255),this.ke(255)}reset(){this.position=0}seed(e){this.Se(e.length),this.buffer.set(e,this.position),this.position+=e.length}Oe(){return this.buffer.slice(0,this.position)}Ve(e){const t=function(e){const t=new DataView(new ArrayBuffer(8));return t.setFloat64(0,e,!1),new Uint8Array(t.buffer)}(e),n=0!=(128&t[0]);t[0]^=n?255:128;for(let r=1;r<t.length;++r)t[r]^=n?255:0;return t}Ie(e){const t=255&e;0===t?(this.xe(0),this.xe(255)):255===t?(this.xe(255),this.xe(0)):this.xe(t)}Ae(e){const t=255&e;0===t?(this.ke(0),this.ke(255)):255===t?(this.ke(255),this.ke(0)):this.ke(e)}Te(){this.xe(0),this.xe(1)}Re(){this.ke(0),this.ke(1)}xe(e){this.Se(1),this.buffer[this.position++]=e}ke(e){this.Se(1),this.buffer[this.position++]=~e}Se(e){const t=e+this.position;if(t<=this.buffer.length)return;let n=2*this.buffer.length;n<t&&(n=t);const r=new Uint8Array(n);r.set(this.buffer),this.buffer=r}}class Ms{constructor(e){this.Me=e}de(e){this.Me.pe(e)}he(e){this.Me.be(e)}ae(e){this.Me.ve(e)}ue(){this.Me.Ce()}}class Rs{constructor(e){this.Me=e}de(e){this.Me.Ee(e)}he(e){this.Me.Pe(e)}ae(e){this.Me.De(e)}ue(){this.Me.Ne()}}class Ls{constructor(){this.Me=new Vs,this.Fe=new Ms(this.Me),this.$e=new Rs(this.Me)}seed(e){this.Me.seed(e)}Be(e){return 0===e?this.Fe:this.$e}Oe(){return this.Me.Oe()}reset(){this.Me.reset()}}class Fs{constructor(e,t,n,r){this.indexId=e,this.documentKey=t,this.arrayValue=n,this.directionalValue=r}Le(){const e=this.directionalValue.length,t=0===e||255===this.directionalValue[e-1]?e+1:e,n=new Uint8Array(t);return n.set(this.directionalValue,0),t!==e?n.set([0],this.directionalValue.length):++n[n.length-1],new Fs(this.indexId,this.documentKey,this.arrayValue,n)}}function Os(e,t){let n=e.indexId-t.indexId;return 0!==n?n:(n=Ps(e.arrayValue,t.arrayValue),0!==n?n:(n=Ps(e.directionalValue,t.directionalValue),0!==n?n:z.comparator(e.documentKey,t.documentKey)))}function Ps(e,t){for(let n=0;n<e.length&&n<t.length;++n){const r=e[n]-t[n];if(0!==r)return r}return e.length-t.length}class qs{constructor(e){this.collectionId=null!=e.collectionGroup?e.collectionGroup:e.path.lastSegment(),this.Ue=e.orderBy,this.qe=[];for(const t of e.filters){const e=t;e.ht()?this.Ke=e:this.qe.push(e)}}Ge(e){const t=Q(e);if(void 0!==t&&!this.Qe(t))return!1;const n=W(e);let r=0,s=0;for(;r<n.length&&this.Qe(n[r]);++r);if(r===n.length)return!0;if(void 0!==this.Ke){const e=n[r];if(!this.je(this.Ke,e)||!this.We(this.Ue[s++],e))return!1;++r}for(;r<n.length;++r){const e=n[r];if(s>=this.Ue.length||!this.We(this.Ue[s++],e))return!1}return!0}Qe(e){for(const t of this.qe)if(this.je(t,e))return!0;return!1}je(e,t){if(void 0===e||!e.field.isEqual(t.fieldPath))return!1;const n="array-contains"===e.op||"array-contains-any"===e.op;return 2===t.kind===n}We(e,t){return!!e.field.isEqual(t.fieldPath)&&(0===t.kind&&"asc"===e.dir||1===t.kind&&"desc"===e.dir)}}class Us{constructor(){this.ze=new Bs}addToCollectionParentIndex(e,t){return this.ze.add(t),se.resolve()}getCollectionParents(e,t){return se.resolve(this.ze.getEntries(t))}addFieldIndex(e,t){return se.resolve()}deleteFieldIndex(e,t){return se.resolve()}getDocumentsMatchingTarget(e,t){return se.resolve(null)}getIndexType(e,t){return se.resolve(0)}getFieldIndexes(e,t){return se.resolve([])}getNextCollectionGroupToUpdate(e){return se.resolve(null)}getMinOffset(e,t){return se.resolve(Z.min())}getMinOffsetFromCollectionGroup(e,t){return se.resolve(Z.min())}updateCollectionGroup(e,t,n){return se.resolve()}updateIndexEntries(e,t){return se.resolve()}}class Bs{constructor(){this.index={}}add(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t]||new Te(K.comparator),s=!r.has(n);return this.index[t]=r.add(n),s}has(e){const t=e.lastSegment(),n=e.popLast(),r=this.index[t];return r&&r.has(n)}getEntries(e){return(this.index[e]||new Te(K.comparator)).toArray()}}const Ks=new Uint8Array(0);class Gs{constructor(e,t){this.user=e,this.databaseId=t,this.He=new Bs,this.Je=new Mn((e=>ft(e)),((e,t)=>mt(e,t))),this.uid=e.uid||""}addToCollectionParentIndex(e,t){if(!this.He.has(t)){const n=t.lastSegment(),r=t.popLast();e.addOnCommittedListener((()=>{this.He.add(t)}));const s={collectionId:n,parent:Mr(r)};return $s(e).put(s)}return se.resolve()}getCollectionParents(e,t){const n=[],r=IDBKeyRange.bound([t,""],[P(t),""],!1,!0);return $s(e).K(r).next((e=>{for(const r of e){if(r.collectionId!==t)break;n.push(Fr(r.parent))}return n}))}addFieldIndex(e,t){const n=js(e),r=function(e){return{indexId:e.indexId,collectionGroup:e.collectionGroup,fields:e.fields.map((e=>[e.fieldPath.canonicalString(),e.kind]))}}(t);delete r.indexId;const s=n.add(r);if(t.indexState){const n=Qs(e);return s.next((e=>{n.put(Ts(e,this.user,t.indexState.sequenceNumber,t.indexState.offset))}))}return s.next()}deleteFieldIndex(e,t){const n=js(e),r=Qs(e),s=zs(e);return n.delete(t.indexId).next((()=>r.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0)))).next((()=>s.delete(IDBKeyRange.bound([t.indexId],[t.indexId+1],!1,!0))))}getDocumentsMatchingTarget(e,t){const n=zs(e);let r=!0;const s=new Map;return se.forEach(this.Ye(t),(t=>this.Xe(e,t).next((e=>{r&&(r=!!e),s.set(t,e)})))).next((()=>{if(r){let e=$n();const r=[];return se.forEach(s,((s,i)=>{var o;g("IndexedDbIndexManager",`Using index ${o=s,`id=${o.indexId}|cg=${o.collectionGroup}|f=${o.fields.map((e=>`${e.fieldPath}:${e.kind}`)).join(",")}`} to execute ${ft(t)}`);const a=function(e,t){const n=Q(t);if(void 0===n)return null;for(const r of pt(e,n.fieldPath))switch(r.op){case"array-contains-any":return r.value.arrayValue.values||[];case"array-contains":return[r.value]}return null}(i,s),u=function(e,t){const n=new Map;for(const r of W(t))for(const t of pt(e,r.fieldPath))switch(t.op){case"==":case"in":n.set(r.fieldPath.canonicalString(),t.value);break;case"not-in":case"!=":return n.set(r.fieldPath.canonicalString(),t.value),Array.from(n.values())}return null}(i,s),c=function(e,t){const n=[];let r=!0;for(const s of W(t)){const t=0===s.kind?yt(e,s.fieldPath,e.startAt):wt(e,s.fieldPath,e.startAt);n.push(t.value),r&&(r=t.inclusive)}return new Nt(n,r)}(i,s),l=function(e,t){const n=[];let r=!0;for(const s of W(t)){const t=0===s.kind?wt(e,s.fieldPath,e.endAt):yt(e,s.fieldPath,e.endAt);n.push(t.value),r&&(r=t.inclusive)}return new Nt(n,r)}(i,s),h=this.Ze(s,i,c),d=this.Ze(s,i,l),f=this.tn(s,i,u),m=this.en(s.indexId,a,h,c.inclusive,d,l.inclusive,f);return se.forEach(m,(s=>n.j(s,t.limit).next((t=>{t.forEach((t=>{const n=z.fromSegments(t.documentKey);e.has(n)||(e=e.add(n),r.push(n))}))}))))})).next((()=>r))}return se.resolve(null)}))}Ye(e){let t=this.Je.get(e);return t||(t=[e],this.Je.set(e,t),t)}en(e,t,n,r,s,i,o){const a=(null!=t?t.length:1)*Math.max(n.length,s.length),u=a/(null!=t?t.length:1),c=[];for(let l=0;l<a;++l){const a=t?this.nn(t[l/u]):Ks,h=this.sn(e,a,n[l%u],r),d=this.rn(e,a,s[l%u],i),f=o.map((t=>this.sn(e,a,t,!0)));c.push(...this.createRange(h,d,f))}return c}sn(e,t,n,r){const s=new Fs(e,z.empty(),t,n);return r?s:s.Le()}rn(e,t,n,r){const s=new Fs(e,z.empty(),t,n);return r?s.Le():s}Xe(e,t){const n=new qs(t),r=null!=t.collectionGroup?t.collectionGroup:t.path.lastSegment();return this.getFieldIndexes(e,r).next((e=>{let t=null;for(const r of e)n.Ge(r)&&(!t||r.fields.length>t.fields.length)&&(t=r);return t}))}getIndexType(e,t){let n=2;return se.forEach(this.Ye(t),(t=>this.Xe(e,t).next((e=>{e?0!==n&&e.fields.length<function(e){let t=new Te($.comparator),n=!1;for(const r of e.filters){const e=r;e.field.isKeyField()||("array-contains"===e.op||"array-contains-any"===e.op?n=!0:t=t.add(e.field))}for(const r of e.orderBy)r.field.isKeyField()||(t=t.add(r.field));return t.size+(n?1:0)}(t)&&(n=1):n=0})))).next((()=>n))}on(e,t){const n=new Ls;for(const r of W(e)){const e=t.data.field(r.fieldPath);if(null==e)return null;const s=n.Be(r.kind);As.ye.re(e,s)}return n.Oe()}nn(e){const t=new Ls;return As.ye.re(e,t.Be(0)),t.Oe()}un(e,t){const n=new Ls;return As.ye.re(Je(this.databaseId,t),n.Be(function(e){const t=W(e);return 0===t.length?0:t[t.length-1].kind}(e))),n.Oe()}tn(e,t,n){if(null===n)return[];let r=[];r.push(new Ls);let s=0;for(const i of W(e)){const e=n[s++];for(const n of r)if(this.cn(t,i.fieldPath)&&Xe(e))r=this.an(r,i,e);else{const t=n.Be(i.kind);As.ye.re(e,t)}}return this.hn(r)}Ze(e,t,n){return this.tn(e,t,n.position)}hn(e){const t=[];for(let n=0;n<e.length;++n)t[n]=e[n].Oe();return t}an(e,t,n){const r=[...e],s=[];for(const i of n.arrayValue.values||[])for(const e of r){const n=new Ls;n.seed(e.Oe()),As.ye.re(i,n.Be(t.kind)),s.push(n)}return s}cn(e,t){return!!e.filters.find((e=>e instanceof vt&&e.field.isEqual(t)&&("in"===e.op||"not-in"===e.op)))}getFieldIndexes(e,t){const n=js(e),r=Qs(e);return(t?n.K("collectionGroupIndex",IDBKeyRange.bound(t,t)):n.K()).next((e=>{const t=[];return se.forEach(e,(e=>r.get([e.indexId,this.uid]).next((n=>{t.push(function(e,t){const n=t?new J(t.sequenceNumber,new Z(ps(t.readTime),new z(Fr(t.documentKey)),t.largestBatchId)):J.empty(),r=e.fields.map((([e,t])=>new H($.fromServerFormat(e),t)));return new j(e.indexId,e.collectionGroup,r,n)}(e,n))})))).next((()=>t))}))}getNextCollectionGroupToUpdate(e){return this.getFieldIndexes(e).next((e=>0===e.length?null:(e.sort(((e,t)=>{const n=e.indexState.sequenceNumber-t.indexState.sequenceNumber;return 0!==n?n:F(e.collectionGroup,t.collectionGroup)})),e[0].collectionGroup)))}updateCollectionGroup(e,t,n){const r=js(e),s=Qs(e);return this.ln(e).next((e=>r.K("collectionGroupIndex",IDBKeyRange.bound(t,t)).next((t=>se.forEach(t,(t=>s.put(Ts(t.indexId,this.user,e,n))))))))}updateIndexEntries(e,t){const n=new Map;return se.forEach(t,((t,r)=>{const s=n.get(t.collectionGroup);return(s?se.resolve(s):this.getFieldIndexes(e,t.collectionGroup)).next((s=>(n.set(t.collectionGroup,s),se.forEach(s,(n=>this.fn(e,t,n).next((t=>{const s=this.dn(r,n);return t.isEqual(s)?se.resolve():this._n(e,r,n,t,s)})))))))}))}wn(e,t,n,r){return zs(e).put({indexId:r.indexId,uid:this.uid,arrayValue:r.arrayValue,directionalValue:r.directionalValue,orderedDocumentKey:this.un(n,t.key),documentKey:t.key.path.toArray()})}mn(e,t,n,r){return zs(e).delete([r.indexId,this.uid,r.arrayValue,r.directionalValue,this.un(n,t.key),t.key.path.toArray()])}fn(e,t,n){const r=zs(e);let s=new Te(Os);return r.J({index:"documentKeyIndex",range:IDBKeyRange.only([n.indexId,this.uid,this.un(n,t)])},((e,r)=>{s=s.add(new Fs(n.indexId,t,r.arrayValue,r.directionalValue))})).next((()=>s))}dn(e,t){let n=new Te(Os);const r=this.on(t,e);if(null==r)return n;const s=Q(t);if(null!=s){const i=e.data.field(s.fieldPath);if(Xe(i))for(const s of i.arrayValue.values||[])n=n.add(new Fs(t.indexId,e.key,this.nn(s),r))}else n=n.add(new Fs(t.indexId,e.key,Ks,r));return n}_n(e,t,n,r,s){g("IndexedDbIndexManager","Updating index entries for document '%s'",t.key);const i=[];return function(e,t,n,r,s){const i=e.getIterator(),o=t.getIterator();let a=xe(i),u=xe(o);for(;a||u;){let e=!1,t=!1;if(a&&u){const r=n(a,u);r<0?t=!0:r>0&&(e=!0)}else null!=a?t=!0:e=!0;e?(r(u),u=xe(o)):t?(s(a),a=xe(i)):(a=xe(i),u=xe(o))}}(r,s,Os,(r=>{i.push(this.wn(e,t,n,r))}),(r=>{i.push(this.mn(e,t,n,r))})),se.waitFor(i)}ln(e){let t=1;return Qs(e).J({index:"sequenceNumberIndex",reverse:!0,range:IDBKeyRange.upperBound([this.uid,Number.MAX_SAFE_INTEGER])},((e,n,r)=>{r.done(),t=n.sequenceNumber+1})).next((()=>t))}createRange(e,t,n){n=n.sort(((e,t)=>Os(e,t))).filter(((e,t,n)=>!t||0!==Os(e,n[t-1])));const r=[];r.push(e);for(const i of n){const n=Os(i,e),s=Os(i,t);if(0===n)r[0]=e.Le();else if(n>0&&s<0)r.push(i),r.push(i.Le());else if(s>0)break}r.push(t);const s=[];for(let i=0;i<r.length;i+=2)s.push(IDBKeyRange.bound([r[i].indexId,this.uid,r[i].arrayValue,r[i].directionalValue,Ks,[]],[r[i+1].indexId,this.uid,r[i+1].arrayValue,r[i+1].directionalValue,Ks,[]]));return s}getMinOffsetFromCollectionGroup(e,t){return this.getFieldIndexes(e,t).next(Ws)}getMinOffset(e,t){return se.mapArray(this.Ye(t),(t=>this.Xe(e,t).next((e=>e||v())))).next(Ws)}}function $s(e){return as(e,"collectionParents")}function zs(e){return as(e,"indexEntries")}function js(e){return as(e,"indexConfiguration")}function Qs(e){return as(e,"indexState")}function Ws(e){I(0!==e.length);let t=e[0].indexState.offset,n=t.largestBatchId;for(let r=1;r<e.length;r++){const s=e[r].indexState.offset;ee(s,t)<0&&(t=s),n<s.largestBatchId&&(n=s.largestBatchId)}return new Z(t.readTime,t.documentKey,n)}const Hs={didRun:!1,sequenceNumbersCollected:0,targetsRemoved:0,documentsRemoved:0};class Js{constructor(e,t,n){this.cacheSizeCollectionThreshold=e,this.percentileToCollect=t,this.maximumSequenceNumbersToCollect=n}static withCacheSize(e){return new Js(e,Js.DEFAULT_COLLECTION_PERCENTILE,Js.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT)}}function Ys(e,t,n){const r=e.store("mutations"),s=e.store("documentMutations"),i=[],o=IDBKeyRange.only(n.batchId);let a=0;const u=r.J({range:o},((e,t,n)=>(a++,n.delete())));i.push(u.next((()=>{I(1===a)})));const c=[];for(const l of n.mutations){const e=qr(t,l.key.path,n.batchId);i.push(s.delete(e)),c.push(l.key)}return se.waitFor(i).next((()=>c))}function Xs(e){if(!e)return 0;let t;if(e.document)t=e.document;else if(e.unknownDocument)t=e.unknownDocument;else{if(!e.noDocument)throw v();t=e.noDocument}return JSON.stringify(t).length}Js.DEFAULT_COLLECTION_PERCENTILE=10,Js.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT=1e3,Js.DEFAULT=new Js(41943040,Js.DEFAULT_COLLECTION_PERCENTILE,Js.DEFAULT_MAX_SEQUENCE_NUMBERS_TO_COLLECT),Js.DISABLED=new Js(-1,0,0);class Zs{constructor(e,t,n,r){this.userId=e,this.wt=t,this.indexManager=n,this.referenceDelegate=r,this.gn={}}static se(e,t,n,r){I(""!==e.uid);const s=e.isAuthenticated()?e.uid:"";return new Zs(s,t,n,r)}checkEmpty(e){let t=!0;const n=IDBKeyRange.bound([this.userId,Number.NEGATIVE_INFINITY],[this.userId,Number.POSITIVE_INFINITY]);return ti(e).J({index:"userMutationsIndex",range:n},((e,n,r)=>{t=!1,r.done()})).next((()=>t))}addMutationBatch(e,t,n,r){const s=ni(e),i=ti(e);return i.add({}).next((o=>{I("number"==typeof o);const a=new us(o,t,n,r),u=function(e,t,n){const r=n.baseMutations.map((t=>vr(e.ne,t))),s=n.mutations.map((t=>vr(e.ne,t)));return{userId:t,batchId:n.batchId,localWriteTimeMs:n.localWriteTime.toMillis(),baseMutations:r,mutations:s}}(this.wt,this.userId,a),c=[];let l=new Te(((e,t)=>F(e.canonicalString(),t.canonicalString())));for(const e of r){const t=qr(this.userId,e.key.path,o);l=l.add(e.key.path.popLast()),c.push(i.put(u)),c.push(s.put(t,Ur))}return l.forEach((t=>{c.push(this.indexManager.addToCollectionParentIndex(e,t))})),e.addOnCommittedListener((()=>{this.gn[o]=a.keys()})),se.waitFor(c).next((()=>a))}))}lookupMutationBatch(e,t){return ti(e).get(t).next((e=>e?(I(e.userId===this.userId),ys(this.wt,e)):null))}yn(e,t){return this.gn[t]?se.resolve(this.gn[t]):this.lookupMutationBatch(e,t).next((e=>{if(e){const n=e.keys();return this.gn[t]=n,n}return null}))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=IDBKeyRange.lowerBound([this.userId,n]);let s=null;return ti(e).J({index:"userMutationsIndex",range:r},((e,t,r)=>{t.userId===this.userId&&(I(t.batchId>=n),s=ys(this.wt,t)),r.done()})).next((()=>s))}getHighestUnacknowledgedBatchId(e){const t=IDBKeyRange.upperBound([this.userId,Number.POSITIVE_INFINITY]);let n=-1;return ti(e).J({index:"userMutationsIndex",range:t,reverse:!0},((e,t,r)=>{n=t.batchId,r.done()})).next((()=>n))}getAllMutationBatches(e){const t=IDBKeyRange.bound([this.userId,-1],[this.userId,Number.POSITIVE_INFINITY]);return ti(e).K("userMutationsIndex",t).next((e=>e.map((e=>ys(this.wt,e)))))}getAllMutationBatchesAffectingDocumentKey(e,t){const n=Pr(this.userId,t.path),r=IDBKeyRange.lowerBound(n),s=[];return ni(e).J({range:r},((n,r,i)=>{const[o,a,u]=n,c=Fr(a);if(o===this.userId&&t.path.isEqual(c))return ti(e).get(u).next((e=>{if(!e)throw v();I(e.userId===this.userId),s.push(ys(this.wt,e))}));i.done()})).next((()=>s))}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new Te(F);const r=[];return t.forEach((t=>{const s=Pr(this.userId,t.path),i=IDBKeyRange.lowerBound(s),o=ni(e).J({range:i},((e,r,s)=>{const[i,o,a]=e,u=Fr(o);i===this.userId&&t.path.isEqual(u)?n=n.add(a):s.done()}));r.push(o)})),se.waitFor(r).next((()=>this.pn(e,n)))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1,s=Pr(this.userId,n),i=IDBKeyRange.lowerBound(s);let o=new Te(F);return ni(e).J({range:i},((e,t,s)=>{const[i,a,u]=e,c=Fr(a);i===this.userId&&n.isPrefixOf(c)?c.length===r&&(o=o.add(u)):s.done()})).next((()=>this.pn(e,o)))}pn(e,t){const n=[],r=[];return t.forEach((t=>{r.push(ti(e).get(t).next((e=>{if(null===e)throw v();I(e.userId===this.userId),n.push(ys(this.wt,e))})))})),se.waitFor(r).next((()=>n))}removeMutationBatch(e,t){return Ys(e.ee,this.userId,t).next((n=>(e.addOnCommittedListener((()=>{this.In(t.batchId)})),se.forEach(n,(t=>this.referenceDelegate.markPotentiallyOrphaned(e,t))))))}In(e){delete this.gn[e]}performConsistencyCheck(e){return this.checkEmpty(e).next((t=>{if(!t)return se.resolve();const n=IDBKeyRange.lowerBound([this.userId]),r=[];return ni(e).J({range:n},((e,t,n)=>{if(e[0]===this.userId){const t=Fr(e[1]);r.push(t)}else n.done()})).next((()=>{I(0===r.length)}))}))}containsKey(e,t){return ei(e,this.userId,t)}Tn(e){return ri(e).get(this.userId).next((e=>e||{userId:this.userId,lastAcknowledgedBatchId:-1,lastStreamToken:""}))}}function ei(e,t,n){const r=Pr(t,n.path),s=r[1],i=IDBKeyRange.lowerBound(r);let o=!1;return ni(e).J({range:i,H:!0},((e,n,r)=>{const[i,a,u]=e;i===t&&a===s&&(o=!0),r.done()})).next((()=>o))}function ti(e){return as(e,"mutations")}function ni(e){return as(e,"documentMutations")}function ri(e){return as(e,"mutationQueues")}class si{constructor(e){this.En=e}next(){return this.En+=2,this.En}static An(){return new si(0)}static Rn(){return new si(-1)}}class ii{constructor(e,t){this.referenceDelegate=e,this.wt=t}allocateTargetId(e){return this.bn(e).next((t=>{const n=new si(t.highestTargetId);return t.highestTargetId=n.next(),this.Pn(e,t).next((()=>t.highestTargetId))}))}getLastRemoteSnapshotVersion(e){return this.bn(e).next((e=>U.fromTimestamp(new q(e.lastRemoteSnapshotVersion.seconds,e.lastRemoteSnapshotVersion.nanoseconds))))}getHighestSequenceNumber(e){return this.bn(e).next((e=>e.highestListenSequenceNumber))}setTargetsMetadata(e,t,n){return this.bn(e).next((r=>(r.highestListenSequenceNumber=t,n&&(r.lastRemoteSnapshotVersion=n.toTimestamp()),t>r.highestListenSequenceNumber&&(r.highestListenSequenceNumber=t),this.Pn(e,r))))}addTargetData(e,t){return this.vn(e,t).next((()=>this.bn(e).next((n=>(n.targetCount+=1,this.Vn(t,n),this.Pn(e,n))))))}updateTargetData(e,t){return this.vn(e,t)}removeTargetData(e,t){return this.removeMatchingKeysForTargetId(e,t.targetId).next((()=>oi(e).delete(t.targetId))).next((()=>this.bn(e))).next((t=>(I(t.targetCount>0),t.targetCount-=1,this.Pn(e,t))))}removeTargets(e,t,n){let r=0;const s=[];return oi(e).J(((i,o)=>{const a=ws(o);a.sequenceNumber<=t&&null===n.get(a.targetId)&&(r++,s.push(this.removeTargetData(e,a)))})).next((()=>se.waitFor(s))).next((()=>r))}forEachTarget(e,t){return oi(e).J(((e,n)=>{const r=ws(n);t(r)}))}bn(e){return ai(e).get("targetGlobalKey").next((e=>(I(null!==e),e)))}Pn(e,t){return ai(e).put("targetGlobalKey",t)}vn(e,t){return oi(e).put(vs(this.wt,t))}Vn(e,t){let n=!1;return e.targetId>t.highestTargetId&&(t.highestTargetId=e.targetId,n=!0),e.sequenceNumber>t.highestListenSequenceNumber&&(t.highestListenSequenceNumber=e.sequenceNumber,n=!0),n}getTargetCount(e){return this.bn(e).next((e=>e.targetCount))}getTargetData(e,t){const n=ft(t),r=IDBKeyRange.bound([n,Number.NEGATIVE_INFINITY],[n,Number.POSITIVE_INFINITY]);let s=null;return oi(e).J({range:r,index:"queryTargetsIndex"},((e,n,r)=>{const i=ws(n);mt(t,i.target)&&(s=i,r.done())})).next((()=>s))}addMatchingKeys(e,t,n){const r=[],s=ui(e);return t.forEach((t=>{const i=Mr(t.path);r.push(s.put({targetId:n,path:i})),r.push(this.referenceDelegate.addReference(e,n,t))})),se.waitFor(r)}removeMatchingKeys(e,t,n){const r=ui(e);return se.forEach(t,(t=>{const s=Mr(t.path);return se.waitFor([r.delete([n,s]),this.referenceDelegate.removeReference(e,n,t)])}))}removeMatchingKeysForTargetId(e,t){const n=ui(e),r=IDBKeyRange.bound([t],[t+1],!1,!0);return n.delete(r)}getMatchingKeysForTargetId(e,t){const n=IDBKeyRange.bound([t],[t+1],!1,!0),r=ui(e);let s=$n();return r.J({range:n,H:!0},((e,t,n)=>{const r=Fr(e[1]),i=new z(r);s=s.add(i)})).next((()=>s))}containsKey(e,t){const n=Mr(t.path),r=IDBKeyRange.bound([n],[P(n)],!1,!0);let s=0;return ui(e).J({index:"documentTargetsIndex",H:!0,range:r},(([e,t],n,r)=>{0!==e&&(s++,r.done())})).next((()=>s>0))}te(e,t){return oi(e).get(t).next((e=>e?ws(e):null))}}function oi(e){return as(e,"targets")}function ai(e){return as(e,"targetGlobal")}function ui(e){return as(e,"targetDocuments")}function ci([e,t],[n,r]){const s=F(e,n);return 0===s?F(t,r):s}class li{constructor(e){this.Sn=e,this.buffer=new Te(ci),this.Dn=0}Cn(){return++this.Dn}xn(e){const t=[e,this.Cn()];if(this.buffer.size<this.Sn)this.buffer=this.buffer.add(t);else{const e=this.buffer.last();ci(t,e)<0&&(this.buffer=this.buffer.delete(e).add(t))}}get maxValue(){return this.buffer.last()[0]}}class hi{constructor(e,t,n){this.garbageCollector=e,this.asyncQueue=t,this.localStore=n,this.Nn=null}start(){-1!==this.garbageCollector.params.cacheSizeCollectionThreshold&&this.kn(6e4)}stop(){this.Nn&&(this.Nn.cancel(),this.Nn=null)}get started(){return null!==this.Nn}kn(e){g("LruGarbageCollector",`Garbage collection scheduled in ${e}ms`),this.Nn=this.asyncQueue.enqueueAfterDelay("lru_garbage_collection",e,(async()=>{this.Nn=null;try{await this.localStore.collectGarbage(this.garbageCollector)}catch(e){ce(e)?g("LruGarbageCollector","Ignoring IndexedDB error during garbage collection: ",e):await re(e)}await this.kn(3e5)}))}}class di{constructor(e,t){this.On=e,this.params=t}calculateTargetCount(e,t){return this.On.Mn(e).next((e=>Math.floor(t/100*e)))}nthSequenceNumber(e,t){if(0===t)return se.resolve(pe.ot);const n=new li(t);return this.On.forEachTarget(e,(e=>n.xn(e.sequenceNumber))).next((()=>this.On.Fn(e,(e=>n.xn(e))))).next((()=>n.maxValue))}removeTargets(e,t,n){return this.On.removeTargets(e,t,n)}removeOrphanedDocuments(e,t){return this.On.removeOrphanedDocuments(e,t)}collect(e,t){return-1===this.params.cacheSizeCollectionThreshold?(g("LruGarbageCollector","Garbage collection skipped; disabled"),se.resolve(Hs)):this.getCacheSize(e).next((n=>n<this.params.cacheSizeCollectionThreshold?(g("LruGarbageCollector",`Garbage collection skipped; Cache size ${n} is lower than threshold ${this.params.cacheSizeCollectionThreshold}`),Hs):this.$n(e,t)))}getCacheSize(e){return this.On.getCacheSize(e)}$n(e,t){let n,r,s,o,a,u,c;const l=Date.now();return this.calculateTargetCount(e,this.params.percentileToCollect).next((t=>(t>this.params.maximumSequenceNumbersToCollect?(g("LruGarbageCollector",`Capping sequence numbers to collect down to the maximum of ${this.params.maximumSequenceNumbersToCollect} from ${t}`),r=this.params.maximumSequenceNumbersToCollect):r=t,o=Date.now(),this.nthSequenceNumber(e,r)))).next((r=>(n=r,a=Date.now(),this.removeTargets(e,n,t)))).next((t=>(s=t,u=Date.now(),this.removeOrphanedDocuments(e,n)))).next((e=>(c=Date.now(),f()<=i.in.DEBUG&&g("LruGarbageCollector",`LRU Garbage Collection\n\tCounted targets in ${o-l}ms\n\tDetermined least recently used ${r} in `+(a-o)+"ms\n"+`\tRemoved ${s} targets in `+(u-a)+"ms\n"+`\tRemoved ${e} documents in `+(c-u)+"ms\n"+`Total Duration: ${c-l}ms`),se.resolve({didRun:!0,sequenceNumbersCollected:r,targetsRemoved:s,documentsRemoved:e}))))}}class fi{constructor(e,t){this.db=e,this.garbageCollector=function(e,t){return new di(e,t)}(this,t)}Mn(e){const t=this.Bn(e);return this.db.getTargetCache().getTargetCount(e).next((e=>t.next((t=>e+t))))}Bn(e){let t=0;return this.Fn(e,(e=>{t++})).next((()=>t))}forEachTarget(e,t){return this.db.getTargetCache().forEachTarget(e,t)}Fn(e,t){return this.Ln(e,((e,n)=>t(n)))}addReference(e,t,n){return mi(e,n)}removeReference(e,t,n){return mi(e,n)}removeTargets(e,t,n){return this.db.getTargetCache().removeTargets(e,t,n)}markPotentiallyOrphaned(e,t){return mi(e,t)}Un(e,t){return function(e,t){let n=!1;return ri(e).Y((r=>ei(e,r,t).next((e=>(e&&(n=!0),se.resolve(!e)))))).next((()=>n))}(e,t)}removeOrphanedDocuments(e,t){const n=this.db.getRemoteDocumentCache().newChangeBuffer(),r=[];let s=0;return this.Ln(e,((i,o)=>{if(o<=t){const t=this.Un(e,i).next((t=>{if(!t)return s++,n.getEntry(e,i).next((()=>(n.removeEntry(i,U.min()),ui(e).delete([0,Mr(i.path)]))))}));r.push(t)}})).next((()=>se.waitFor(r))).next((()=>n.apply(e))).next((()=>s))}removeTarget(e,t){const n=t.withSequenceNumber(e.currentSequenceNumber);return this.db.getTargetCache().updateTargetData(e,n)}updateLimboDocument(e,t){return mi(e,t)}Ln(e,t){const n=ui(e);let r,s=pe.ot;return n.J({index:"documentTargetsIndex"},(([e,n],{path:i,sequenceNumber:o})=>{0===e?(s!==pe.ot&&t(new z(Fr(r)),s),s=o,r=i):s=pe.ot})).next((()=>{s!==pe.ot&&t(new z(Fr(r)),s)}))}getCacheSize(e){return this.db.getRemoteDocumentCache().getSize(e)}}function mi(e,t){return ui(e).put(function(e,t){return{targetId:0,path:Mr(e.path),sequenceNumber:t}}(t,e.currentSequenceNumber))}class gi{constructor(){this.changes=new Mn((e=>e.toString()),((e,t)=>e.isEqual(t))),this.changesApplied=!1}addEntry(e){this.assertNotApplied(),this.changes.set(e.key,e)}removeEntry(e,t){this.assertNotApplied(),this.changes.set(e,lt.newInvalidDocument(e).setReadTime(t))}getEntry(e,t){this.assertNotApplied();const n=this.changes.get(t);return void 0!==n?se.resolve(n):this.getFromCache(e,t)}getEntries(e,t){return this.getAllFromCache(e,t)}apply(e){return this.assertNotApplied(),this.changesApplied=!0,this.applyChanges(e)}assertNotApplied(){}}class pi{constructor(e){this.wt=e}setIndexManager(e){this.indexManager=e}addEntry(e,t,n){return Ii(e).put(n)}removeEntry(e,t,n){return Ii(e).delete(function(e,t){const n=e.path.toArray();return[n.slice(0,n.length-2),n[n.length-2],ms(t),n[n.length-1]]}(t,n))}updateMetadata(e,t){return this.getMetadata(e).next((n=>(n.byteSize+=t,this.qn(e,n))))}getEntry(e,t){let n=lt.newInvalidDocument(t);return Ii(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(bi(t))},((e,r)=>{n=this.Kn(t,r)})).next((()=>n))}Gn(e,t){let n={size:0,document:lt.newInvalidDocument(t)};return Ii(e).J({index:"documentKeyIndex",range:IDBKeyRange.only(bi(t))},((e,r)=>{n={document:this.Kn(t,r),size:Xs(r)}})).next((()=>n))}getEntries(e,t){let n=Ln();return this.Qn(e,t,((e,t)=>{const r=this.Kn(e,t);n=n.insert(e,r)})).next((()=>n))}jn(e,t){let n=Ln(),r=new Ie(z.comparator);return this.Qn(e,t,((e,t)=>{const s=this.Kn(e,t);n=n.insert(e,s),r=r.insert(e,Xs(t))})).next((()=>({documents:n,Wn:r})))}Qn(e,t,n){if(t.isEmpty())return se.resolve();let r=new Te(Ti);t.forEach((e=>r=r.add(e)));const s=IDBKeyRange.bound(bi(r.first()),bi(r.last())),i=r.getIterator();let o=i.getNext();return Ii(e).J({index:"documentKeyIndex",range:s},((e,t,r)=>{const s=z.fromSegments([...t.prefixPath,t.collectionGroup,t.documentId]);for(;o&&Ti(o,s)<0;)n(o,null),o=i.getNext();o&&o.isEqual(s)&&(n(o,t),o=i.hasNext()?i.getNext():null),o?r.q(bi(o)):r.done()})).next((()=>{for(;o;)n(o,null),o=i.hasNext()?i.getNext():null}))}getAllFromCollection(e,t,n){const r=[t.popLast().toArray(),t.lastSegment(),ms(n.readTime),n.documentKey.path.isEmpty()?"":n.documentKey.path.lastSegment()],s=[t.popLast().toArray(),t.lastSegment(),[Number.MAX_SAFE_INTEGER,Number.MAX_SAFE_INTEGER],""];return Ii(e).K(IDBKeyRange.bound(r,s,!0)).next((e=>{let t=Ln();for(const n of e){const e=this.Kn(z.fromSegments(n.prefixPath.concat(n.collectionGroup,n.documentId)),n);t=t.insert(e.key,e)}return t}))}getAllFromCollectionGroup(e,t,n,r){let s=Ln();const i=Ei(t,n),o=Ei(t,Z.max());return Ii(e).J({index:"collectionGroupIndex",range:IDBKeyRange.bound(i,o,!0)},((e,t,n)=>{const i=this.Kn(z.fromSegments(t.prefixPath.concat(t.collectionGroup,t.documentId)),t);s=s.insert(i.key,i),s.size===r&&n.done()})).next((()=>s))}newChangeBuffer(e){return new wi(this,!!e&&e.trackRemovals)}getSize(e){return this.getMetadata(e).next((e=>e.byteSize))}getMetadata(e){return vi(e).get("remoteDocumentGlobalKey").next((e=>(I(!!e),e)))}qn(e,t){return vi(e).put("remoteDocumentGlobalKey",t)}Kn(e,t){if(t){const e=function(e,t){let n;if(t.document)n=wr(e.ne,t.document,!!t.hasCommittedMutations);else if(t.noDocument){const e=z.fromSegments(t.noDocument.path),r=ps(t.noDocument.readTime);n=lt.newNoDocument(e,r),t.hasCommittedMutations&&n.setHasCommittedMutations()}else{if(!t.unknownDocument)return v();{const e=z.fromSegments(t.unknownDocument.path),r=ps(t.unknownDocument.version);n=lt.newUnknownDocument(e,r)}}return t.readTime&&n.setReadTime(function(e){const t=new q(e[0],e[1]);return U.fromTimestamp(t)}(t.readTime)),n}(this.wt,t);if(!e.isNoDocument()||!e.version.isEqual(U.min()))return e}return lt.newInvalidDocument(e)}}function yi(e){return new pi(e)}class wi extends gi{constructor(e,t){super(),this.zn=e,this.trackRemovals=t,this.Hn=new Mn((e=>e.toString()),((e,t)=>e.isEqual(t)))}applyChanges(e){const t=[];let n=0,r=new Te(((e,t)=>F(e.canonicalString(),t.canonicalString())));return this.changes.forEach(((s,i)=>{const o=this.Hn.get(s);if(t.push(this.zn.removeEntry(e,s,o.readTime)),i.isValidDocument()){const a=fs(this.zn.wt,i);r=r.add(s.path.popLast());const u=Xs(a);n+=u-o.size,t.push(this.zn.addEntry(e,s,a))}else if(n-=o.size,this.trackRemovals){const n=fs(this.zn.wt,i.convertToNoDocument(U.min()));t.push(this.zn.addEntry(e,s,n))}})),r.forEach((n=>{t.push(this.zn.indexManager.addToCollectionParentIndex(e,n))})),t.push(this.zn.updateMetadata(e,n)),se.waitFor(t)}getFromCache(e,t){return this.zn.Gn(e,t).next((e=>(this.Hn.set(t,{size:e.size,readTime:e.document.readTime}),e.document)))}getAllFromCache(e,t){return this.zn.jn(e,t).next((({documents:e,Wn:t})=>(t.forEach(((t,n)=>{this.Hn.set(t,{size:n,readTime:e.get(t).readTime})})),e)))}}function vi(e){return as(e,"remoteDocumentGlobal")}function Ii(e){return as(e,"remoteDocumentsV14")}function bi(e){const t=e.path.toArray();return[t.slice(0,t.length-2),t[t.length-2],t[t.length-1]]}function Ei(e,t){const n=t.documentKey.path.toArray();return[e,ms(t.readTime),n.slice(0,n.length-2),n.length>0?n[n.length-1]:""]}function Ti(e,t){const n=e.path.toArray(),r=t.path.toArray();let s=0;for(let i=0;i<n.length-2&&i<r.length-2;++i)if(s=F(n[i],r[i]),s)return s;return s=F(n.length,r.length),s||(s=F(n[n.length-2],r[r.length-2]),s||F(n[n.length-1],r[r.length-1]))}class Si{constructor(e,t){this.overlayedDocument=e,this.mutatedFields=t}}class xi{constructor(e,t,n,r){this.remoteDocumentCache=e,this.mutationQueue=t,this.documentOverlayCache=n,this.indexManager=r}getDocument(e,t){let n=null;return this.documentOverlayCache.getOverlay(e,t).next((r=>(n=r,this.getBaseDocument(e,t,n)))).next((e=>(null!==n&&wn(n.mutation,e,De.empty(),q.now()),e)))}getDocuments(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.getLocalViewOfDocuments(e,t,$n()).next((()=>t))))}getLocalViewOfDocuments(e,t,n=$n()){const r=qn();return this.populateOverlays(e,r,t).next((()=>this.computeViews(e,t,r,n).next((e=>{let t=On();return e.forEach(((e,n)=>{t=t.insert(e,n.overlayedDocument)})),t}))))}getOverlayedDocuments(e,t){const n=qn();return this.populateOverlays(e,n,t).next((()=>this.computeViews(e,t,n,$n())))}populateOverlays(e,t,n){const r=[];return n.forEach((e=>{t.has(e)||r.push(e)})),this.documentOverlayCache.getOverlays(e,r).next((e=>{e.forEach(((e,n)=>{t.set(e,n)}))}))}computeViews(e,t,n,r){let s=Ln();const i=Bn(),o=Bn();return t.forEach(((e,t)=>{const o=n.get(t.key);r.has(t.key)&&(void 0===o||o.mutation instanceof En)?s=s.insert(t.key,t):void 0!==o&&(i.set(t.key,o.mutation.getFieldMask()),wn(o.mutation,t,o.mutation.getFieldMask(),q.now()))})),this.recalculateAndSaveOverlays(e,s).next((e=>(e.forEach(((e,t)=>i.set(e,t))),t.forEach(((e,t)=>{var n;return o.set(e,new Si(t,null!==(n=i.get(e))&&void 0!==n?n:null))})),o)))}recalculateAndSaveOverlays(e,t){const n=Bn();let r=new Ie(((e,t)=>e-t)),s=$n();return this.mutationQueue.getAllMutationBatchesAffectingDocumentKeys(e,t).next((e=>{for(const s of e)s.keys().forEach((e=>{const i=t.get(e);if(null===i)return;let o=n.get(e)||De.empty();o=s.applyToLocalView(i,o),n.set(e,o);const a=(r.get(s.batchId)||$n()).add(e);r=r.insert(s.batchId,a)}))})).next((()=>{const i=[],o=r.getReverseIterator();for(;o.hasNext();){const r=o.getNext(),a=r.key,u=r.value,c=Un();u.forEach((e=>{if(!s.has(e)){const r=pn(t.get(e),n.get(e));null!==r&&c.set(e,r),s=s.add(e)}})),i.push(this.documentOverlayCache.saveOverlays(e,a,c))}return se.waitFor(i)})).next((()=>n))}recalculateAndSaveOverlaysForDocumentKeys(e,t){return this.remoteDocumentCache.getEntries(e,t).next((t=>this.recalculateAndSaveOverlays(e,t)))}getDocumentsMatchingQuery(e,t,n){return function(e){return z.isDocumentKey(e.path)&&null===e.collectionGroup&&0===e.filters.length}(t)?this.getDocumentsMatchingDocumentQuery(e,t.path):Pt(t)?this.getDocumentsMatchingCollectionGroupQuery(e,t,n):this.getDocumentsMatchingCollectionQuery(e,t,n)}getNextDocuments(e,t,n,r){return this.remoteDocumentCache.getAllFromCollectionGroup(e,t,n,r).next((s=>{const i=r-s.size>0?this.documentOverlayCache.getOverlaysForCollectionGroup(e,t,n.largestBatchId,r-s.size):se.resolve(qn());let o=-1,a=s;return i.next((t=>se.forEach(t,((t,n)=>(o<n.largestBatchId&&(o=n.largestBatchId),s.get(t)?se.resolve():this.getBaseDocument(e,t,n).next((e=>{a=a.insert(t,e)}))))).next((()=>this.populateOverlays(e,t,s))).next((()=>this.computeViews(e,a,t,$n()))).next((e=>({batchId:o,changes:Pn(e)})))))}))}getDocumentsMatchingDocumentQuery(e,t){return this.getDocument(e,new z(t)).next((e=>{let t=On();return e.isFoundDocument()&&(t=t.insert(e.key,e)),t}))}getDocumentsMatchingCollectionGroupQuery(e,t,n){const r=t.collectionGroup;let s=On();return this.indexManager.getCollectionParents(e,r).next((i=>se.forEach(i,(i=>{const o=function(e,t){return new Mt(t,null,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(t,i.child(r));return this.getDocumentsMatchingCollectionQuery(e,o,n).next((e=>{e.forEach(((e,t)=>{s=s.insert(e,t)}))}))})).next((()=>s))))}getDocumentsMatchingCollectionQuery(e,t,n){let r;return this.remoteDocumentCache.getAllFromCollection(e,t.path,n).next((s=>(r=s,this.documentOverlayCache.getOverlaysForCollection(e,t.path,n.largestBatchId)))).next((e=>{e.forEach(((e,t)=>{const n=t.getKey();null===r.get(n)&&(r=r.insert(n,lt.newInvalidDocument(n)))}));let n=On();return r.forEach(((r,s)=>{const i=e.get(r);void 0!==i&&wn(i.mutation,s,De.empty(),q.now()),zt(t,s)&&(n=n.insert(r,s))})),n}))}getBaseDocument(e,t,n){return null===n||1===n.mutation.type?this.remoteDocumentCache.getEntry(e,t):se.resolve(lt.newInvalidDocument(t))}}class Di{constructor(e){this.wt=e,this.Jn=new Map,this.Yn=new Map}getBundleMetadata(e,t){return se.resolve(this.Jn.get(t))}saveBundleMetadata(e,t){var n;return this.Jn.set(t.id,{id:(n=t).id,version:n.version,createTime:ur(n.createTime)}),se.resolve()}getNamedQuery(e,t){return se.resolve(this.Yn.get(t))}saveNamedQuery(e,t){return this.Yn.set(t.name,function(e){return{name:e.name,query:Is(e.bundledQuery),readTime:ur(e.readTime)}}(t)),se.resolve()}}class _i{constructor(){this.overlays=new Ie(z.comparator),this.Xn=new Map}getOverlay(e,t){return se.resolve(this.overlays.get(t))}getOverlays(e,t){const n=qn();return se.forEach(t,(t=>this.getOverlay(e,t).next((e=>{null!==e&&n.set(t,e)})))).next((()=>n))}saveOverlays(e,t,n){return n.forEach(((n,r)=>{this.ie(e,t,r)})),se.resolve()}removeOverlaysForBatchId(e,t,n){const r=this.Xn.get(n);return void 0!==r&&(r.forEach((e=>this.overlays=this.overlays.remove(e))),this.Xn.delete(n)),se.resolve()}getOverlaysForCollection(e,t,n){const r=qn(),s=t.length+1,i=new z(t.child("")),o=this.overlays.getIteratorFrom(i);for(;o.hasNext();){const e=o.getNext().value,i=e.getKey();if(!t.isPrefixOf(i.path))break;i.path.length===s&&e.largestBatchId>n&&r.set(e.getKey(),e)}return se.resolve(r)}getOverlaysForCollectionGroup(e,t,n,r){let s=new Ie(((e,t)=>e-t));const i=this.overlays.getIterator();for(;i.hasNext();){const e=i.getNext().value;if(e.getKey().getCollectionGroup()===t&&e.largestBatchId>n){let t=s.get(e.largestBatchId);null===t&&(t=qn(),s=s.insert(e.largestBatchId,t)),t.set(e.getKey(),e)}}const o=qn(),a=s.getIterator();for(;a.hasNext()&&(a.getNext().value.forEach(((e,t)=>o.set(e,t))),!(o.size()>=r)););return se.resolve(o)}ie(e,t,n){const r=this.overlays.get(n.key);if(null!==r){const e=this.Xn.get(r.largestBatchId).delete(n.key);this.Xn.set(r.largestBatchId,e)}this.overlays=this.overlays.insert(n.key,new ls(t,n));let s=this.Xn.get(t);void 0===s&&(s=$n(),this.Xn.set(t,s)),this.Xn.set(t,s.add(n.key))}}class Ni{constructor(){this.Zn=new Te(Ai.ts),this.es=new Te(Ai.ns)}isEmpty(){return this.Zn.isEmpty()}addReference(e,t){const n=new Ai(e,t);this.Zn=this.Zn.add(n),this.es=this.es.add(n)}ss(e,t){e.forEach((e=>this.addReference(e,t)))}removeReference(e,t){this.rs(new Ai(e,t))}os(e,t){e.forEach((e=>this.removeReference(e,t)))}us(e){const t=new z(new K([])),n=new Ai(t,e),r=new Ai(t,e+1),s=[];return this.es.forEachInRange([n,r],(e=>{this.rs(e),s.push(e.key)})),s}cs(){this.Zn.forEach((e=>this.rs(e)))}rs(e){this.Zn=this.Zn.delete(e),this.es=this.es.delete(e)}hs(e){const t=new z(new K([])),n=new Ai(t,e),r=new Ai(t,e+1);let s=$n();return this.es.forEachInRange([n,r],(e=>{s=s.add(e.key)})),s}containsKey(e){const t=new Ai(e,0),n=this.Zn.firstAfterOrEqual(t);return null!==n&&e.isEqual(n.key)}}class Ai{constructor(e,t){this.key=e,this.ls=t}static ts(e,t){return z.comparator(e.key,t.key)||F(e.ls,t.ls)}static ns(e,t){return F(e.ls,t.ls)||z.comparator(e.key,t.key)}}class ki{constructor(e,t){this.indexManager=e,this.referenceDelegate=t,this.mutationQueue=[],this.fs=1,this.ds=new Te(Ai.ts)}checkEmpty(e){return se.resolve(0===this.mutationQueue.length)}addMutationBatch(e,t,n,r){const s=this.fs;this.fs++,this.mutationQueue.length>0&&this.mutationQueue[this.mutationQueue.length-1];const i=new us(s,t,n,r);this.mutationQueue.push(i);for(const o of r)this.ds=this.ds.add(new Ai(o.key,s)),this.indexManager.addToCollectionParentIndex(e,o.key.path.popLast());return se.resolve(i)}lookupMutationBatch(e,t){return se.resolve(this._s(t))}getNextMutationBatchAfterBatchId(e,t){const n=t+1,r=this.ws(n),s=r<0?0:r;return se.resolve(this.mutationQueue.length>s?this.mutationQueue[s]:null)}getHighestUnacknowledgedBatchId(){return se.resolve(0===this.mutationQueue.length?-1:this.fs-1)}getAllMutationBatches(e){return se.resolve(this.mutationQueue.slice())}getAllMutationBatchesAffectingDocumentKey(e,t){const n=new Ai(t,0),r=new Ai(t,Number.POSITIVE_INFINITY),s=[];return this.ds.forEachInRange([n,r],(e=>{const t=this._s(e.ls);s.push(t)})),se.resolve(s)}getAllMutationBatchesAffectingDocumentKeys(e,t){let n=new Te(F);return t.forEach((e=>{const t=new Ai(e,0),r=new Ai(e,Number.POSITIVE_INFINITY);this.ds.forEachInRange([t,r],(e=>{n=n.add(e.ls)}))})),se.resolve(this.gs(n))}getAllMutationBatchesAffectingQuery(e,t){const n=t.path,r=n.length+1;let s=n;z.isDocumentKey(s)||(s=s.child(""));const i=new Ai(new z(s),0);let o=new Te(F);return this.ds.forEachWhile((e=>{const t=e.key.path;return!!n.isPrefixOf(t)&&(t.length===r&&(o=o.add(e.ls)),!0)}),i),se.resolve(this.gs(o))}gs(e){const t=[];return e.forEach((e=>{const n=this._s(e);null!==n&&t.push(n)})),t}removeMutationBatch(e,t){I(0===this.ys(t.batchId,"removed")),this.mutationQueue.shift();let n=this.ds;return se.forEach(t.mutations,(r=>{const s=new Ai(r.key,t.batchId);return n=n.delete(s),this.referenceDelegate.markPotentiallyOrphaned(e,r.key)})).next((()=>{this.ds=n}))}In(e){}containsKey(e,t){const n=new Ai(t,0),r=this.ds.firstAfterOrEqual(n);return se.resolve(t.isEqual(r&&r.key))}performConsistencyCheck(e){return this.mutationQueue.length,se.resolve()}ys(e,t){return this.ws(e)}ws(e){return 0===this.mutationQueue.length?0:e-this.mutationQueue[0].batchId}_s(e){const t=this.ws(e);return t<0||t>=this.mutationQueue.length?null:this.mutationQueue[t]}}class Ci{constructor(e){this.ps=e,this.docs=new Ie(z.comparator),this.size=0}setIndexManager(e){this.indexManager=e}addEntry(e,t){const n=t.key,r=this.docs.get(n),s=r?r.size:0,i=this.ps(t);return this.docs=this.docs.insert(n,{document:t.mutableCopy(),size:i}),this.size+=i-s,this.indexManager.addToCollectionParentIndex(e,n.path.popLast())}removeEntry(e){const t=this.docs.get(e);t&&(this.docs=this.docs.remove(e),this.size-=t.size)}getEntry(e,t){const n=this.docs.get(t);return se.resolve(n?n.document.mutableCopy():lt.newInvalidDocument(t))}getEntries(e,t){let n=Ln();return t.forEach((e=>{const t=this.docs.get(e);n=n.insert(e,t?t.document.mutableCopy():lt.newInvalidDocument(e))})),se.resolve(n)}getAllFromCollection(e,t,n){let r=Ln();const s=new z(t.child("")),i=this.docs.getIteratorFrom(s);for(;i.hasNext();){const{key:e,value:{document:s}}=i.getNext();if(!t.isPrefixOf(e.path))break;e.path.length>t.length+1||ee(X(s),n)<=0||(r=r.insert(s.key,s.mutableCopy()))}return se.resolve(r)}getAllFromCollectionGroup(e,t,n,r){v()}Is(e,t){return se.forEach(this.docs,(e=>t(e)))}newChangeBuffer(e){return new Vi(this)}getSize(e){return se.resolve(this.size)}}class Vi extends gi{constructor(e){super(),this.zn=e}applyChanges(e){const t=[];return this.changes.forEach(((n,r)=>{r.isValidDocument()?t.push(this.zn.addEntry(e,r)):this.zn.removeEntry(n)})),se.waitFor(t)}getFromCache(e,t){return this.zn.getEntry(e,t)}getAllFromCache(e,t){return this.zn.getEntries(e,t)}}class Mi{constructor(e){this.persistence=e,this.Ts=new Mn((e=>ft(e)),mt),this.lastRemoteSnapshotVersion=U.min(),this.highestTargetId=0,this.Es=0,this.As=new Ni,this.targetCount=0,this.Rs=si.An()}forEachTarget(e,t){return this.Ts.forEach(((e,n)=>t(n))),se.resolve()}getLastRemoteSnapshotVersion(e){return se.resolve(this.lastRemoteSnapshotVersion)}getHighestSequenceNumber(e){return se.resolve(this.Es)}allocateTargetId(e){return this.highestTargetId=this.Rs.next(),se.resolve(this.highestTargetId)}setTargetsMetadata(e,t,n){return n&&(this.lastRemoteSnapshotVersion=n),t>this.Es&&(this.Es=t),se.resolve()}vn(e){this.Ts.set(e.target,e);const t=e.targetId;t>this.highestTargetId&&(this.Rs=new si(t),this.highestTargetId=t),e.sequenceNumber>this.Es&&(this.Es=e.sequenceNumber)}addTargetData(e,t){return this.vn(t),this.targetCount+=1,se.resolve()}updateTargetData(e,t){return this.vn(t),se.resolve()}removeTargetData(e,t){return this.Ts.delete(t.target),this.As.us(t.targetId),this.targetCount-=1,se.resolve()}removeTargets(e,t,n){let r=0;const s=[];return this.Ts.forEach(((i,o)=>{o.sequenceNumber<=t&&null===n.get(o.targetId)&&(this.Ts.delete(i),s.push(this.removeMatchingKeysForTargetId(e,o.targetId)),r++)})),se.waitFor(s).next((()=>r))}getTargetCount(e){return se.resolve(this.targetCount)}getTargetData(e,t){const n=this.Ts.get(t)||null;return se.resolve(n)}addMatchingKeys(e,t,n){return this.As.ss(t,n),se.resolve()}removeMatchingKeys(e,t,n){this.As.os(t,n);const r=this.persistence.referenceDelegate,s=[];return r&&t.forEach((t=>{s.push(r.markPotentiallyOrphaned(e,t))})),se.waitFor(s)}removeMatchingKeysForTargetId(e,t){return this.As.us(t),se.resolve()}getMatchingKeysForTargetId(e,t){const n=this.As.hs(t);return se.resolve(n)}containsKey(e,t){return se.resolve(this.As.containsKey(t))}}class Ri{constructor(e,t){this.bs={},this.overlays={},this.Ps=new pe(0),this.vs=!1,this.vs=!0,this.referenceDelegate=e(this),this.Vs=new Mi(this),this.indexManager=new Us,this.remoteDocumentCache=function(e){return new Ci(e)}((e=>this.referenceDelegate.Ss(e))),this.wt=new ds(t),this.Ds=new Di(this.wt)}start(){return Promise.resolve()}shutdown(){return this.vs=!1,Promise.resolve()}get started(){return this.vs}setDatabaseDeletedListener(){}setNetworkEnabled(){}getIndexManager(e){return this.indexManager}getDocumentOverlayCache(e){let t=this.overlays[e.toKey()];return t||(t=new _i,this.overlays[e.toKey()]=t),t}getMutationQueue(e,t){let n=this.bs[e.toKey()];return n||(n=new ki(t,this.referenceDelegate),this.bs[e.toKey()]=n),n}getTargetCache(){return this.Vs}getRemoteDocumentCache(){return this.remoteDocumentCache}getBundleCache(){return this.Ds}runTransaction(e,t,n){g("MemoryPersistence","Starting transaction:",e);const r=new Li(this.Ps.next());return this.referenceDelegate.Cs(),n(r).next((e=>this.referenceDelegate.xs(r).next((()=>e)))).toPromise().then((e=>(r.raiseOnCommittedEvent(),e)))}Ns(e,t){return se.or(Object.values(this.bs).map((n=>()=>n.containsKey(e,t))))}}class Li extends ne{constructor(e){super(),this.currentSequenceNumber=e}}class Fi{constructor(e){this.persistence=e,this.ks=new Ni,this.Os=null}static Ms(e){return new Fi(e)}get Fs(){if(this.Os)return this.Os;throw v()}addReference(e,t,n){return this.ks.addReference(n,t),this.Fs.delete(n.toString()),se.resolve()}removeReference(e,t,n){return this.ks.removeReference(n,t),this.Fs.add(n.toString()),se.resolve()}markPotentiallyOrphaned(e,t){return this.Fs.add(t.toString()),se.resolve()}removeTarget(e,t){this.ks.us(t.targetId).forEach((e=>this.Fs.add(e.toString())));const n=this.persistence.getTargetCache();return n.getMatchingKeysForTargetId(e,t.targetId).next((e=>{e.forEach((e=>this.Fs.add(e.toString())))})).next((()=>n.removeTargetData(e,t)))}Cs(){this.Os=new Set}xs(e){const t=this.persistence.getRemoteDocumentCache().newChangeBuffer();return se.forEach(this.Fs,(n=>{const r=z.fromPath(n);return this.$s(e,r).next((e=>{e||t.removeEntry(r,U.min())}))})).next((()=>(this.Os=null,t.apply(e))))}updateLimboDocument(e,t){return this.$s(e,t).next((e=>{e?this.Fs.delete(t.toString()):this.Fs.add(t.toString())}))}Ss(e){return 0}$s(e,t){return se.or([()=>se.resolve(this.ks.containsKey(t)),()=>this.persistence.getTargetCache().containsKey(e,t),()=>this.persistence.Ns(e,t)])}}class Oi{constructor(e){this.wt=e}O(e,t,n,r){const s=new ie("createOrUpgrade",t);n<1&&r>=1&&(function(e){e.createObjectStore("owner")}(e),function(e){e.createObjectStore("mutationQueues",{keyPath:"userId"}),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Or,{unique:!0}),e.createObjectStore("documentMutations")}(e),Pi(e),function(e){e.createObjectStore("remoteDocuments")}(e));let i=se.resolve();return n<3&&r>=3&&(0!==n&&(function(e){e.deleteObjectStore("targetDocuments"),e.deleteObjectStore("targets"),e.deleteObjectStore("targetGlobal")}(e),Pi(e)),i=i.next((()=>function(e){const t=e.store("targetGlobal"),n={highestTargetId:0,highestListenSequenceNumber:0,lastRemoteSnapshotVersion:U.min().toTimestamp(),targetCount:0};return t.put("targetGlobalKey",n)}(s)))),n<4&&r>=4&&(0!==n&&(i=i.next((()=>function(e,t){return t.store("mutations").K().next((n=>{e.deleteObjectStore("mutations"),e.createObjectStore("mutations",{keyPath:"batchId",autoIncrement:!0}).createIndex("userMutationsIndex",Or,{unique:!0});const r=t.store("mutations"),s=n.map((e=>r.put(e)));return se.waitFor(s)}))}(e,s)))),i=i.next((()=>{!function(e){e.createObjectStore("clientMetadata",{keyPath:"clientId"})}(e)}))),n<5&&r>=5&&(i=i.next((()=>this.Bs(s)))),n<6&&r>=6&&(i=i.next((()=>(function(e){e.createObjectStore("remoteDocumentGlobal")}(e),this.Ls(s))))),n<7&&r>=7&&(i=i.next((()=>this.Us(s)))),n<8&&r>=8&&(i=i.next((()=>this.qs(e,s)))),n<9&&r>=9&&(i=i.next((()=>{!function(e){e.objectStoreNames.contains("remoteDocumentChanges")&&e.deleteObjectStore("remoteDocumentChanges")}(e)}))),n<10&&r>=10&&(i=i.next((()=>this.Ks(s)))),n<11&&r>=11&&(i=i.next((()=>{!function(e){e.createObjectStore("bundles",{keyPath:"bundleId"})}(e),function(e){e.createObjectStore("namedQueries",{keyPath:"name"})}(e)}))),n<12&&r>=12&&(i=i.next((()=>{!function(e){const t=e.createObjectStore("documentOverlays",{keyPath:Xr});t.createIndex("collectionPathOverlayIndex",Zr,{unique:!1}),t.createIndex("collectionGroupOverlayIndex",es,{unique:!1})}(e)}))),n<13&&r>=13&&(i=i.next((()=>function(e){const t=e.createObjectStore("remoteDocumentsV14",{keyPath:Br});t.createIndex("documentKeyIndex",Kr),t.createIndex("collectionGroupIndex",Gr)}(e))).next((()=>this.Gs(e,s))).next((()=>e.deleteObjectStore("remoteDocuments")))),n<14&&r>=14&&(i=i.next((()=>this.Qs(e,s)))),n<15&&r>=15&&(i=i.next((()=>function(e){e.createObjectStore("indexConfiguration",{keyPath:"indexId",autoIncrement:!0}).createIndex("collectionGroupIndex","collectionGroup",{unique:!1}),e.createObjectStore("indexState",{keyPath:Wr}).createIndex("sequenceNumberIndex",Hr,{unique:!1}),e.createObjectStore("indexEntries",{keyPath:Jr}).createIndex("documentKeyIndex",Yr,{unique:!1})}(e)))),i}Ls(e){let t=0;return e.store("remoteDocuments").J(((e,n)=>{t+=Xs(n)})).next((()=>{const n={byteSize:t};return e.store("remoteDocumentGlobal").put("remoteDocumentGlobalKey",n)}))}Bs(e){const t=e.store("mutationQueues"),n=e.store("mutations");return t.K().next((t=>se.forEach(t,(t=>{const r=IDBKeyRange.bound([t.userId,-1],[t.userId,t.lastAcknowledgedBatchId]);return n.K("userMutationsIndex",r).next((n=>se.forEach(n,(n=>{I(n.userId===t.userId);const r=ys(this.wt,n);return Ys(e,t.userId,r).next((()=>{}))}))))}))))}Us(e){const t=e.store("targetDocuments"),n=e.store("remoteDocuments");return e.store("targetGlobal").get("targetGlobalKey").next((e=>{const r=[];return n.J(((n,s)=>{const i=new K(n),o=function(e){return[0,Mr(e)]}(i);r.push(t.get(o).next((n=>n?se.resolve():(n=>t.put({targetId:0,path:Mr(n),sequenceNumber:e.highestListenSequenceNumber}))(i))))})).next((()=>se.waitFor(r)))}))}qs(e,t){e.createObjectStore("collectionParents",{keyPath:Qr});const n=t.store("collectionParents"),r=new Bs,s=e=>{if(r.add(e)){const t=e.lastSegment(),r=e.popLast();return n.put({collectionId:t,parent:Mr(r)})}};return t.store("remoteDocuments").J({H:!0},((e,t)=>{const n=new K(e);return s(n.popLast())})).next((()=>t.store("documentMutations").J({H:!0},(([e,t,n],r)=>{const i=Fr(t);return s(i.popLast())}))))}Ks(e){const t=e.store("targets");return t.J(((e,n)=>{const r=ws(n),s=vs(this.wt,r);return t.put(s)}))}Gs(e,t){const n=t.store("remoteDocuments"),r=[];return n.J(((e,n)=>{const s=t.store("remoteDocumentsV14"),i=(o=n,o.document?new z(K.fromString(o.document.name).popFirst(5)):o.noDocument?z.fromSegments(o.noDocument.path):o.unknownDocument?z.fromSegments(o.unknownDocument.path):v()).path.toArray();var o;const a={prefixPath:i.slice(0,i.length-2),collectionGroup:i[i.length-2],documentId:i[i.length-1],readTime:n.readTime||[0,0],unknownDocument:n.unknownDocument,noDocument:n.noDocument,document:n.document,hasCommittedMutations:!!n.hasCommittedMutations};r.push(s.put(a))})).next((()=>se.waitFor(r)))}Qs(e,t){const n=t.store("mutations"),r=yi(this.wt),s=new Ri(Fi.Ms,this.wt.ne);return n.K().next((e=>{const n=new Map;return e.forEach((e=>{var t;let r=null!==(t=n.get(e.userId))&&void 0!==t?t:$n();ys(this.wt,e).keys().forEach((e=>r=r.add(e))),n.set(e.userId,r)})),se.forEach(n,((e,n)=>{const i=new l(n),o=_s.se(this.wt,i),a=s.getIndexManager(i),u=Zs.se(i,this.wt,a,s.referenceDelegate);return new xi(r,u,o,a).recalculateAndSaveOverlaysForDocumentKeys(new os(t,pe.ot),e).next()}))}))}}function Pi(e){e.createObjectStore("targetDocuments",{keyPath:zr}).createIndex("documentTargetsIndex",jr,{unique:!0}),e.createObjectStore("targets",{keyPath:"targetId"}).createIndex("queryTargetsIndex",$r,{unique:!0}),e.createObjectStore("targetGlobal")}const qi="Failed to obtain exclusive access to the persistence layer. To allow shared access, multi-tab synchronization has to be enabled in all tabs. If you are using `experimentalForceOwningTab:true`, make sure that only one tab has persistence enabled at any given time.";class Ui{constructor(e,t,n,r,s,i,o,a,u,c,l=14){if(this.allowTabSynchronization=e,this.persistenceKey=t,this.clientId=n,this.js=s,this.window=i,this.document=o,this.Ws=u,this.zs=c,this.Hs=l,this.Ps=null,this.vs=!1,this.isPrimary=!1,this.networkEnabled=!0,this.Js=null,this.inForeground=!1,this.Ys=null,this.Xs=null,this.Zs=Number.NEGATIVE_INFINITY,this.ti=e=>Promise.resolve(),!Ui.V())throw new S(T.UNIMPLEMENTED,"This platform is either missing IndexedDB or is known to have an incomplete implementation. Offline persistence has been disabled.");this.referenceDelegate=new fi(this,r),this.ei=t+"main",this.wt=new ds(a),this.ni=new oe(this.ei,this.Hs,new Oi(this.wt)),this.Vs=new ii(this.referenceDelegate,this.wt),this.remoteDocumentCache=yi(this.wt),this.Ds=new Ss,this.window&&this.window.localStorage?this.si=this.window.localStorage:(this.si=null,!1===c&&p("IndexedDbPersistence","LocalStorage is unavailable. As a result, persistence may not work reliably. In particular enablePersistence() could fail immediately after refreshing the page."))}start(){return this.ii().then((()=>{if(!this.isPrimary&&!this.allowTabSynchronization)throw new S(T.FAILED_PRECONDITION,qi);return this.ri(),this.oi(),this.ui(),this.runTransaction("getHighestListenSequenceNumber","readonly",(e=>this.Vs.getHighestSequenceNumber(e)))})).then((e=>{this.Ps=new pe(e,this.Ws)})).then((()=>{this.vs=!0})).catch((e=>(this.ni&&this.ni.close(),Promise.reject(e))))}ci(e){return this.ti=async t=>{if(this.started)return e(t)},e(this.isPrimary)}setDatabaseDeletedListener(e){this.ni.F((async t=>{null===t.newVersion&&await e()}))}setNetworkEnabled(e){this.networkEnabled!==e&&(this.networkEnabled=e,this.js.enqueueAndForget((async()=>{this.started&&await this.ii()})))}ii(){return this.runTransaction("updateClientMetadataAndTryBecomePrimary","readwrite",(e=>Ki(e).put({clientId:this.clientId,updateTimeMs:Date.now(),networkEnabled:this.networkEnabled,inForeground:this.inForeground}).next((()=>{if(this.isPrimary)return this.ai(e).next((e=>{e||(this.isPrimary=!1,this.js.enqueueRetryable((()=>this.ti(!1))))}))})).next((()=>this.hi(e))).next((t=>this.isPrimary&&!t?this.li(e).next((()=>!1)):!!t&&this.fi(e).next((()=>!0)))))).catch((e=>{if(ce(e))return g("IndexedDbPersistence","Failed to extend owner lease: ",e),this.isPrimary;if(!this.allowTabSynchronization)throw e;return g("IndexedDbPersistence","Releasing owner lease after error during lease refresh",e),!1})).then((e=>{this.isPrimary!==e&&this.js.enqueueRetryable((()=>this.ti(e))),this.isPrimary=e}))}ai(e){return Bi(e).get("owner").next((e=>se.resolve(this.di(e))))}_i(e){return Ki(e).delete(this.clientId)}async wi(){if(this.isPrimary&&!this.mi(this.Zs,18e5)){this.Zs=Date.now();const e=await this.runTransaction("maybeGarbageCollectMultiClientState","readwrite-primary",(e=>{const t=as(e,"clientMetadata");return t.K().next((e=>{const n=this.gi(e,18e5),r=e.filter((e=>-1===n.indexOf(e)));return se.forEach(r,(e=>t.delete(e.clientId))).next((()=>r))}))})).catch((()=>[]));if(this.si)for(const t of e)this.si.removeItem(this.yi(t.clientId))}}ui(){this.Xs=this.js.enqueueAfterDelay("client_metadata_refresh",4e3,(()=>this.ii().then((()=>this.wi())).then((()=>this.ui()))))}di(e){return!!e&&e.ownerId===this.clientId}hi(e){return this.zs?se.resolve(!0):Bi(e).get("owner").next((t=>{if(null!==t&&this.mi(t.leaseTimestampMs,5e3)&&!this.pi(t.ownerId)){if(this.di(t)&&this.networkEnabled)return!0;if(!this.di(t)){if(!t.allowTabSynchronization)throw new S(T.FAILED_PRECONDITION,qi);return!1}}return!(!this.networkEnabled||!this.inForeground)||Ki(e).K().next((e=>void 0===this.gi(e,5e3).find((e=>{if(this.clientId!==e.clientId){const t=!this.networkEnabled&&e.networkEnabled,n=!this.inForeground&&e.inForeground,r=this.networkEnabled===e.networkEnabled;if(t||n&&r)return!0}return!1}))))})).next((e=>(this.isPrimary!==e&&g("IndexedDbPersistence",`Client ${e?"is":"is not"} eligible for a primary lease.`),e)))}async shutdown(){this.vs=!1,this.Ii(),this.Xs&&(this.Xs.cancel(),this.Xs=null),this.Ti(),this.Ei(),await this.ni.runTransaction("shutdown","readwrite",["owner","clientMetadata"],(e=>{const t=new os(e,pe.ot);return this.li(t).next((()=>this._i(t)))})),this.ni.close(),this.Ai()}gi(e,t){return e.filter((e=>this.mi(e.updateTimeMs,t)&&!this.pi(e.clientId)))}Ri(){return this.runTransaction("getActiveClients","readonly",(e=>Ki(e).K().next((e=>this.gi(e,18e5).map((e=>e.clientId))))))}get started(){return this.vs}getMutationQueue(e,t){return Zs.se(e,this.wt,t,this.referenceDelegate)}getTargetCache(){return this.Vs}getRemoteDocumentCache(){return this.remoteDocumentCache}getIndexManager(e){return new Gs(e,this.wt.ne.databaseId)}getDocumentOverlayCache(e){return _s.se(this.wt,e)}getBundleCache(){return this.Ds}runTransaction(e,t,n){g("IndexedDbPersistence","Starting transaction:",e);const r="readonly"===t?"readonly":"readwrite",s=15===(i=this.Hs)?is:14===i?ss:13===i?rs:12===i?ns:11===i?ts:void v();var i;let o;return this.ni.runTransaction(e,r,s,(r=>(o=new os(r,this.Ps?this.Ps.next():pe.ot),"readwrite-primary"===t?this.ai(o).next((e=>!!e||this.hi(o))).next((t=>{if(!t)throw p(`Failed to obtain primary lease for action '${e}'.`),this.isPrimary=!1,this.js.enqueueRetryable((()=>this.ti(!1))),new S(T.FAILED_PRECONDITION,te);return n(o)})).next((e=>this.fi(o).next((()=>e)))):this.bi(o).next((()=>n(o)))))).then((e=>(o.raiseOnCommittedEvent(),e)))}bi(e){return Bi(e).get("owner").next((e=>{if(null!==e&&this.mi(e.leaseTimestampMs,5e3)&&!this.pi(e.ownerId)&&!this.di(e)&&!(this.zs||this.allowTabSynchronization&&e.allowTabSynchronization))throw new S(T.FAILED_PRECONDITION,qi)}))}fi(e){const t={ownerId:this.clientId,allowTabSynchronization:this.allowTabSynchronization,leaseTimestampMs:Date.now()};return Bi(e).put("owner",t)}static V(){return oe.V()}li(e){const t=Bi(e);return t.get("owner").next((e=>this.di(e)?(g("IndexedDbPersistence","Releasing primary lease."),t.delete("owner")):se.resolve()))}mi(e,t){const n=Date.now();return!(e<n-t)&&(!(e>n)||(p(`Detected an update time that is in the future: ${e} > ${n}`),!1))}ri(){null!==this.document&&"function"==typeof this.document.addEventListener&&(this.Ys=()=>{this.js.enqueueAndForget((()=>(this.inForeground="visible"===this.document.visibilityState,this.ii())))},this.document.addEventListener("visibilitychange",this.Ys),this.inForeground="visible"===this.document.visibilityState)}Ti(){this.Ys&&(this.document.removeEventListener("visibilitychange",this.Ys),this.Ys=null)}oi(){var e;"function"==typeof(null===(e=this.window)||void 0===e?void 0:e.addEventListener)&&(this.Js=()=>{this.Ii(),(0,o.G6)()&&navigator.appVersion.match(/Version\/1[45]/)&&this.js.enterRestrictedMode(!0),this.js.enqueueAndForget((()=>this.shutdown()))},this.window.addEventListener("pagehide",this.Js))}Ei(){this.Js&&(this.window.removeEventListener("pagehide",this.Js),this.Js=null)}pi(e){var t;try{const n=null!==(null===(t=this.si)||void 0===t?void 0:t.getItem(this.yi(e)));return g("IndexedDbPersistence",`Client '${e}' ${n?"is":"is not"} zombied in LocalStorage`),n}catch(e){return p("IndexedDbPersistence","Failed to get zombied client id.",e),!1}}Ii(){if(this.si)try{this.si.setItem(this.yi(this.clientId),String(Date.now()))}catch(e){p("Failed to set zombie client id.",e)}}Ai(){if(this.si)try{this.si.removeItem(this.yi(this.clientId))}catch(e){}}yi(e){return`firestore_zombie_${this.persistenceKey}_${e}`}}function Bi(e){return as(e,"owner")}function Ki(e){return as(e,"clientMetadata")}function Gi(e,t){let n=e.projectId;return e.isDefaultDatabase||(n+="."+e.database),"firestore/"+t+"/"+n+"/"}class $i{constructor(e,t,n,r){this.targetId=e,this.fromCache=t,this.Pi=n,this.vi=r}static Vi(e,t){let n=$n(),r=$n();for(const s of t.docChanges)switch(s.type){case 0:n=n.add(s.doc.key);break;case 1:r=r.add(s.doc.key)}return new $i(e,t.fromCache,n,r)}}class zi{constructor(){this.Si=!1}initialize(e,t){this.Di=e,this.indexManager=t,this.Si=!0}getDocumentsMatchingQuery(e,t,n,r){return this.Ci(e,t).next((s=>s||this.xi(e,t,r,n))).next((n=>n||this.Ni(e,t)))}Ci(e,t){return se.resolve(null)}xi(e,t,n,r){return function(e){return 0===e.filters.length&&null===e.limit&&null==e.startAt&&null==e.endAt&&(0===e.explicitOrderBy.length||1===e.explicitOrderBy.length&&e.explicitOrderBy[0].field.isKeyField())}(t)||r.isEqual(U.min())?this.Ni(e,t):this.Di.getDocuments(e,n).next((s=>{const o=this.ki(t,s);return this.Oi(t,o,n,r)?this.Ni(e,t):(f()<=i.in.DEBUG&&g("QueryEngine","Re-using previous result from %s to execute query: %s",r.toString(),$t(t)),this.Mi(e,o,t,Y(r,-1)))}))}ki(e,t){let n=new Te(Qt(e));return t.forEach(((t,r)=>{zt(e,r)&&(n=n.add(r))})),n}Oi(e,t,n,r){if(null===e.limit)return!1;if(n.size!==t.size)return!0;const s="F"===e.limitType?t.last():t.first();return!!s&&(s.hasPendingWrites||s.version.compareTo(r)>0)}Ni(e,t){return f()<=i.in.DEBUG&&g("QueryEngine","Using full collection scan to execute query:",$t(t)),this.Di.getDocumentsMatchingQuery(e,t,Z.min())}Mi(e,t,n,r){return this.Di.getDocumentsMatchingQuery(e,n,r).next((e=>(t.forEach((t=>{e=e.insert(t.key,t)})),e)))}}class ji{constructor(e,t,n,r){this.persistence=e,this.Fi=t,this.wt=r,this.$i=new Ie(F),this.Bi=new Mn((e=>ft(e)),mt),this.Li=new Map,this.Ui=e.getRemoteDocumentCache(),this.Vs=e.getTargetCache(),this.Ds=e.getBundleCache(),this.qi(n)}qi(e){this.documentOverlayCache=this.persistence.getDocumentOverlayCache(e),this.indexManager=this.persistence.getIndexManager(e),this.mutationQueue=this.persistence.getMutationQueue(e,this.indexManager),this.localDocuments=new xi(this.Ui,this.mutationQueue,this.documentOverlayCache,this.indexManager),this.Ui.setIndexManager(this.indexManager),this.Fi.initialize(this.localDocuments,this.indexManager)}collectGarbage(e){return this.persistence.runTransaction("Collect garbage","readwrite-primary",(t=>e.collect(t,this.$i)))}}function Qi(e,t,n,r){return new ji(e,t,n,r)}async function Wi(e,t){const n=E(e);return await n.persistence.runTransaction("Handle user change","readonly",(e=>{let r;return n.mutationQueue.getAllMutationBatches(e).next((s=>(r=s,n.qi(t),n.mutationQueue.getAllMutationBatches(e)))).next((t=>{const s=[],i=[];let o=$n();for(const e of r){s.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}for(const e of t){i.push(e.batchId);for(const t of e.mutations)o=o.add(t.key)}return n.localDocuments.getDocuments(e,o).next((e=>({Ki:e,removedBatchIds:s,addedBatchIds:i})))}))}))}function Hi(e){const t=E(e);return t.persistence.runTransaction("Get last remote snapshot version","readonly",(e=>t.Vs.getLastRemoteSnapshotVersion(e)))}function Ji(e,t,n){let r=$n(),s=$n();return n.forEach((e=>r=r.add(e))),t.getEntries(e,r).next((e=>{let r=Ln();return n.forEach(((n,i)=>{const o=e.get(n);i.isFoundDocument()!==o.isFoundDocument()&&(s=s.add(n)),i.isNoDocument()&&i.version.isEqual(U.min())?(t.removeEntry(n,i.readTime),r=r.insert(n,i)):!o.isValidDocument()||i.version.compareTo(o.version)>0||0===i.version.compareTo(o.version)&&o.hasPendingWrites?(t.addEntry(i),r=r.insert(n,i)):g("LocalStore","Ignoring outdated watch update for ",n,". Current version:",o.version," Watch version:",i.version)})),{Gi:r,Qi:s}}))}function Yi(e,t){const n=E(e);return n.persistence.runTransaction("Get next mutation batch","readonly",(e=>(void 0===t&&(t=-1),n.mutationQueue.getNextMutationBatchAfterBatchId(e,t))))}function Xi(e,t){const n=E(e);return n.persistence.runTransaction("Allocate target","readwrite",(e=>{let r;return n.Vs.getTargetData(e,t).next((s=>s?(r=s,se.resolve(r)):n.Vs.allocateTargetId(e).next((s=>(r=new hs(t,s,0,e.currentSequenceNumber),n.Vs.addTargetData(e,r).next((()=>r)))))))})).then((e=>{const r=n.$i.get(e.targetId);return(null===r||e.snapshotVersion.compareTo(r.snapshotVersion)>0)&&(n.$i=n.$i.insert(e.targetId,e),n.Bi.set(t,e.targetId)),e}))}async function Zi(e,t,n){const r=E(e),s=r.$i.get(t),i=n?"readwrite":"readwrite-primary";try{n||await r.persistence.runTransaction("Release target",i,(e=>r.persistence.referenceDelegate.removeTarget(e,s)))}catch(e){if(!ce(e))throw e;g("LocalStore",`Failed to update sequence numbers for target ${t}: ${e}`)}r.$i=r.$i.remove(t),r.Bi.delete(s.target)}function eo(e,t,n){const r=E(e);let s=U.min(),i=$n();return r.persistence.runTransaction("Execute query","readonly",(e=>function(e,t,n){const r=E(e),s=r.Bi.get(n);return void 0!==s?se.resolve(r.$i.get(s)):r.Vs.getTargetData(t,n)}(r,e,Ut(t)).next((t=>{if(t)return s=t.lastLimboFreeSnapshotVersion,r.Vs.getMatchingKeysForTargetId(e,t.targetId).next((e=>{i=e}))})).next((()=>r.Fi.getDocumentsMatchingQuery(e,t,n?s:U.min(),n?i:$n()))).next((e=>(ro(r,jt(t),e),{documents:e,ji:i})))))}function to(e,t){const n=E(e),r=E(n.Vs),s=n.$i.get(t);return s?Promise.resolve(s.target):n.persistence.runTransaction("Get target data","readonly",(e=>r.te(e,t).next((e=>e?e.target:null))))}function no(e,t){const n=E(e),r=n.Li.get(t)||U.min();return n.persistence.runTransaction("Get new document changes","readonly",(e=>n.Ui.getAllFromCollectionGroup(e,t,Y(r,-1),Number.MAX_SAFE_INTEGER))).then((e=>(ro(n,t,e),e)))}function ro(e,t,n){let r=U.min();n.forEach(((e,t)=>{t.readTime.compareTo(r)>0&&(r=t.readTime)})),e.Li.set(t,r)}async function so(e,t,n=$n()){const r=await Xi(e,Ut(Is(t.bundledQuery))),s=E(e);return s.persistence.runTransaction("Save named query","readwrite",(e=>{const i=ur(t.readTime);if(r.snapshotVersion.compareTo(i)>=0)return s.Ds.saveNamedQuery(e,t);const o=r.withResumeToken(Ne.EMPTY_BYTE_STRING,i);return s.$i=s.$i.insert(o.targetId,o),s.Vs.updateTargetData(e,o).next((()=>s.Vs.removeMatchingKeysForTargetId(e,r.targetId))).next((()=>s.Vs.addMatchingKeys(e,n,r.targetId))).next((()=>s.Ds.saveNamedQuery(e,t)))}))}function io(e,t){return`firestore_clients_${e}_${t}`}function oo(e,t,n){let r=`firestore_mutations_${e}_${n}`;return t.isAuthenticated()&&(r+=`_${t.uid}`),r}function ao(e,t){return`firestore_targets_${e}_${t}`}class uo{constructor(e,t,n,r){this.user=e,this.batchId=t,this.state=n,this.error=r}static Ji(e,t,n){const r=JSON.parse(n);let s,i="object"==typeof r&&-1!==["pending","acknowledged","rejected"].indexOf(r.state)&&(void 0===r.error||"object"==typeof r.error);return i&&r.error&&(i="string"==typeof r.error.message&&"string"==typeof r.error.code,i&&(s=new S(r.error.code,r.error.message))),i?new uo(e,t,r.state,s):(p("SharedClientState",`Failed to parse mutation state for ID '${t}': ${n}`),null)}Yi(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class co{constructor(e,t,n){this.targetId=e,this.state=t,this.error=n}static Ji(e,t){const n=JSON.parse(t);let r,s="object"==typeof n&&-1!==["not-current","current","rejected"].indexOf(n.state)&&(void 0===n.error||"object"==typeof n.error);return s&&n.error&&(s="string"==typeof n.error.message&&"string"==typeof n.error.code,s&&(r=new S(n.error.code,n.error.message))),s?new co(e,n.state,r):(p("SharedClientState",`Failed to parse target state for ID '${e}': ${t}`),null)}Yi(){const e={state:this.state,updateTimeMs:Date.now()};return this.error&&(e.error={code:this.error.code,message:this.error.message}),JSON.stringify(e)}}class lo{constructor(e,t){this.clientId=e,this.activeTargetIds=t}static Ji(e,t){const n=JSON.parse(t);let r="object"==typeof n&&n.activeTargetIds instanceof Array,s=jn();for(let i=0;r&&i<n.activeTargetIds.length;++i)r=Ue(n.activeTargetIds[i]),s=s.add(n.activeTargetIds[i]);return r?new lo(e,s):(p("SharedClientState",`Failed to parse client data for instance '${e}': ${t}`),null)}}class ho{constructor(e,t){this.clientId=e,this.onlineState=t}static Ji(e){const t=JSON.parse(e);return"object"==typeof t&&-1!==["Unknown","Online","Offline"].indexOf(t.onlineState)&&"string"==typeof t.clientId?new ho(t.clientId,t.onlineState):(p("SharedClientState",`Failed to parse online state: ${e}`),null)}}class fo{constructor(){this.activeTargetIds=jn()}Xi(e){this.activeTargetIds=this.activeTargetIds.add(e)}Zi(e){this.activeTargetIds=this.activeTargetIds.delete(e)}Yi(){const e={activeTargetIds:this.activeTargetIds.toArray(),updateTimeMs:Date.now()};return JSON.stringify(e)}}class mo{constructor(e,t,n,r,s){this.window=e,this.js=t,this.persistenceKey=n,this.tr=r,this.syncEngine=null,this.onlineStateHandler=null,this.sequenceNumberHandler=null,this.er=this.nr.bind(this),this.sr=new Ie(F),this.started=!1,this.ir=[];const i=n.replace(/[.*+?^${}()|[\]\\]/g,"\\$&");this.storage=this.window.localStorage,this.currentUser=s,this.rr=io(this.persistenceKey,this.tr),this.ur=function(e){return`firestore_sequence_number_${e}`}(this.persistenceKey),this.sr=this.sr.insert(this.tr,new fo),this.cr=new RegExp(`^firestore_clients_${i}_([^_]*)$`),this.ar=new RegExp(`^firestore_mutations_${i}_(\\d+)(?:_(.*))?$`),this.hr=new RegExp(`^firestore_targets_${i}_(\\d+)$`),this.lr=function(e){return`firestore_online_state_${e}`}(this.persistenceKey),this.dr=function(e){return`firestore_bundle_loaded_v2_${e}`}(this.persistenceKey),this.window.addEventListener("storage",this.er)}static V(e){return!(!e||!e.localStorage)}async start(){const e=await this.syncEngine.Ri();for(const n of e){if(n===this.tr)continue;const e=this.getItem(io(this.persistenceKey,n));if(e){const t=lo.Ji(n,e);t&&(this.sr=this.sr.insert(t.clientId,t))}}this._r();const t=this.storage.getItem(this.lr);if(t){const e=this.wr(t);e&&this.mr(e)}for(const n of this.ir)this.nr(n);this.ir=[],this.window.addEventListener("pagehide",(()=>this.shutdown())),this.started=!0}writeSequenceNumber(e){this.setItem(this.ur,JSON.stringify(e))}getAllActiveQueryTargets(){return this.gr(this.sr)}isActiveQueryTarget(e){let t=!1;return this.sr.forEach(((n,r)=>{r.activeTargetIds.has(e)&&(t=!0)})),t}addPendingMutation(e){this.yr(e,"pending")}updateMutationState(e,t,n){this.yr(e,t,n),this.pr(e)}addLocalQueryTarget(e){let t="not-current";if(this.isActiveQueryTarget(e)){const n=this.storage.getItem(ao(this.persistenceKey,e));if(n){const r=co.Ji(e,n);r&&(t=r.state)}}return this.Ir.Xi(e),this._r(),t}removeLocalQueryTarget(e){this.Ir.Zi(e),this._r()}isLocalQueryTarget(e){return this.Ir.activeTargetIds.has(e)}clearQueryState(e){this.removeItem(ao(this.persistenceKey,e))}updateQueryState(e,t,n){this.Tr(e,t,n)}handleUserChange(e,t,n){t.forEach((e=>{this.pr(e)})),this.currentUser=e,n.forEach((e=>{this.addPendingMutation(e)}))}setOnlineState(e){this.Er(e)}notifyBundleLoaded(e){this.Ar(e)}shutdown(){this.started&&(this.window.removeEventListener("storage",this.er),this.removeItem(this.rr),this.started=!1)}getItem(e){const t=this.storage.getItem(e);return g("SharedClientState","READ",e,t),t}setItem(e,t){g("SharedClientState","SET",e,t),this.storage.setItem(e,t)}removeItem(e){g("SharedClientState","REMOVE",e),this.storage.removeItem(e)}nr(e){const t=e;if(t.storageArea===this.storage){if(g("SharedClientState","EVENT",t.key,t.newValue),t.key===this.rr)return void p("Received WebStorage notification for local change. Another client might have garbage-collected our state");this.js.enqueueRetryable((async()=>{if(this.started){if(null!==t.key)if(this.cr.test(t.key)){if(null==t.newValue){const e=this.Rr(t.key);return this.br(e,null)}{const e=this.Pr(t.key,t.newValue);if(e)return this.br(e.clientId,e)}}else if(this.ar.test(t.key)){if(null!==t.newValue){const e=this.vr(t.key,t.newValue);if(e)return this.Vr(e)}}else if(this.hr.test(t.key)){if(null!==t.newValue){const e=this.Sr(t.key,t.newValue);if(e)return this.Dr(e)}}else if(t.key===this.lr){if(null!==t.newValue){const e=this.wr(t.newValue);if(e)return this.mr(e)}}else if(t.key===this.ur){const e=function(e){let t=pe.ot;if(null!=e)try{const n=JSON.parse(e);I("number"==typeof n),t=n}catch(e){p("SharedClientState","Failed to read sequence number from WebStorage",e)}return t}(t.newValue);e!==pe.ot&&this.sequenceNumberHandler(e)}else if(t.key===this.dr){const e=this.Cr(t.newValue);await Promise.all(e.map((e=>this.syncEngine.Nr(e))))}}else this.ir.push(t)}))}}get Ir(){return this.sr.get(this.tr)}_r(){this.setItem(this.rr,this.Ir.Yi())}yr(e,t,n){const r=new uo(this.currentUser,e,t,n),s=oo(this.persistenceKey,this.currentUser,e);this.setItem(s,r.Yi())}pr(e){const t=oo(this.persistenceKey,this.currentUser,e);this.removeItem(t)}Er(e){const t={clientId:this.tr,onlineState:e};this.storage.setItem(this.lr,JSON.stringify(t))}Tr(e,t,n){const r=ao(this.persistenceKey,e),s=new co(e,t,n);this.setItem(r,s.Yi())}Ar(e){const t=JSON.stringify(Array.from(e));this.setItem(this.dr,t)}Rr(e){const t=this.cr.exec(e);return t?t[1]:null}Pr(e,t){const n=this.Rr(e);return lo.Ji(n,t)}vr(e,t){const n=this.ar.exec(e),r=Number(n[1]),s=void 0!==n[2]?n[2]:null;return uo.Ji(new l(s),r,t)}Sr(e,t){const n=this.hr.exec(e),r=Number(n[1]);return co.Ji(r,t)}wr(e){return ho.Ji(e)}Cr(e){return JSON.parse(e)}async Vr(e){if(e.user.uid===this.currentUser.uid)return this.syncEngine.kr(e.batchId,e.state,e.error);g("SharedClientState",`Ignoring mutation for non-active user ${e.user.uid}`)}Dr(e){return this.syncEngine.Or(e.targetId,e.state,e.error)}br(e,t){const n=t?this.sr.insert(e,t):this.sr.remove(e),r=this.gr(this.sr),s=this.gr(n),i=[],o=[];return s.forEach((e=>{r.has(e)||i.push(e)})),r.forEach((e=>{s.has(e)||o.push(e)})),this.syncEngine.Mr(i,o).then((()=>{this.sr=n}))}mr(e){this.sr.get(e.clientId)&&this.onlineStateHandler(e.onlineState)}gr(e){let t=jn();return e.forEach(((e,n)=>{t=t.unionWith(n.activeTargetIds)})),t}}class go{constructor(){this.Fr=new fo,this.$r={},this.onlineStateHandler=null,this.sequenceNumberHandler=null}addPendingMutation(e){}updateMutationState(e,t,n){}addLocalQueryTarget(e){return this.Fr.Xi(e),this.$r[e]||"not-current"}updateQueryState(e,t,n){this.$r[e]=t}removeLocalQueryTarget(e){this.Fr.Zi(e)}isLocalQueryTarget(e){return this.Fr.activeTargetIds.has(e)}clearQueryState(e){delete this.$r[e]}getAllActiveQueryTargets(){return this.Fr.activeTargetIds}isActiveQueryTarget(e){return this.Fr.activeTargetIds.has(e)}start(){return this.Fr=new fo,Promise.resolve()}handleUserChange(e,t,n){}setOnlineState(e){}shutdown(){}writeSequenceNumber(e){}notifyBundleLoaded(e){}}class po{Br(e){}shutdown(){}}class yo{constructor(){this.Lr=()=>this.Ur(),this.qr=()=>this.Kr(),this.Gr=[],this.Qr()}Br(e){this.Gr.push(e)}shutdown(){window.removeEventListener("online",this.Lr),window.removeEventListener("offline",this.qr)}Qr(){window.addEventListener("online",this.Lr),window.addEventListener("offline",this.qr)}Ur(){g("ConnectivityMonitor","Network connectivity changed: AVAILABLE");for(const e of this.Gr)e(0)}Kr(){g("ConnectivityMonitor","Network connectivity changed: UNAVAILABLE");for(const e of this.Gr)e(1)}static V(){return"undefined"!=typeof window&&void 0!==window.addEventListener&&void 0!==window.removeEventListener}}const wo={BatchGetDocuments:"batchGet",Commit:"commit",RunQuery:"runQuery"};class vo{constructor(e){this.jr=e.jr,this.Wr=e.Wr}zr(e){this.Hr=e}Jr(e){this.Yr=e}onMessage(e){this.Xr=e}close(){this.Wr()}send(e){this.jr(e)}Zr(){this.Hr()}eo(e){this.Yr(e)}no(e){this.Xr(e)}}class Io extends class{constructor(e){this.databaseInfo=e,this.databaseId=e.databaseId;const t=e.ssl?"https":"http";this.so=t+"://"+e.host,this.io="projects/"+this.databaseId.projectId+"/databases/"+this.databaseId.database+"/documents"}ro(e,t,n,r,s){const i=this.oo(e,t);g("RestConnection","Sending: ",i,n);const o={};return this.uo(o,r,s),this.co(e,i,o,n).then((e=>(g("RestConnection","Received: ",e),e)),(t=>{throw y("RestConnection",`${e} failed with error: `,t,"url: ",i,"request:",n),t}))}ao(e,t,n,r,s,i){return this.ro(e,t,n,r,s)}uo(e,t,n){e["X-Goog-Api-Client"]="gl-js/ fire/"+h,e["Content-Type"]="text/plain",this.databaseInfo.appId&&(e["X-Firebase-GMPID"]=this.databaseInfo.appId),t&&t.headers.forEach(((t,n)=>e[n]=t)),n&&n.headers.forEach(((t,n)=>e[n]=t))}oo(e,t){const n=wo[e];return`${this.so}/v1/${t}:${n}`}}{constructor(e){super(e),this.forceLongPolling=e.forceLongPolling,this.autoDetectLongPolling=e.autoDetectLongPolling,this.useFetchStreams=e.useFetchStreams}co(e,t,n,r){return new Promise(((s,i)=>{const o=new a.JJ;o.listenOnce(a.tw.COMPLETE,(()=>{try{switch(o.getLastErrorCode()){case a.jK.NO_ERROR:const t=o.getResponseJson();g("Connection","XHR received:",JSON.stringify(t)),s(t);break;case a.jK.TIMEOUT:g("Connection",'RPC "'+e+'" timed out'),i(new S(T.DEADLINE_EXCEEDED,"Request time out"));break;case a.jK.HTTP_ERROR:const n=o.getStatus();if(g("Connection",'RPC "'+e+'" failed with status:',n,"response text:",o.getResponseText()),n>0){const e=o.getResponseJson().error;if(e&&e.status&&e.message){const t=function(e){const t=e.toLowerCase().replace(/_/g,"-");return Object.values(T).indexOf(t)>=0?t:T.UNKNOWN}(e.status);i(new S(t,e.message))}else i(new S(T.UNKNOWN,"Server responded with status "+o.getStatus()))}else i(new S(T.UNAVAILABLE,"Connection failed."));break;default:v()}}finally{g("Connection",'RPC "'+e+'" completed.')}}));const u=JSON.stringify(r);o.send(t,"POST",u,n,15)}))}ho(e,t,n){const r=[this.so,"/","google.firestore.v1.Firestore","/",e,"/channel"],s=(0,a.UE)(),i=(0,a.FJ)(),u={httpSessionIdParam:"gsessionid",initMessageHeaders:{},messageUrlParams:{database:`projects/${this.databaseId.projectId}/databases/${this.databaseId.database}`},sendRawJson:!0,supportsCrossDomainXhr:!0,internalChannelParams:{forwardChannelRequestTimeoutMs:6e5},forceLongPolling:this.forceLongPolling,detectBufferingProxy:this.autoDetectLongPolling};this.useFetchStreams&&(u.xmlHttpFactory=new a.zI({})),this.uo(u.initMessageHeaders,t,n),(0,o.uI)()||(0,o.b$)()||(0,o.d)()||(0,o.w1)()||(0,o.Mn)()||(0,o.ru)()||(u.httpHeadersOverwriteParam="$httpHeaders");const c=r.join("");g("Connection","Creating WebChannel: "+c,u);const l=s.createWebChannel(c,u);let h=!1,d=!1;const f=new vo({jr:e=>{d?g("Connection","Not sending because WebChannel is closed:",e):(h||(g("Connection","Opening WebChannel transport."),l.open(),h=!0),g("Connection","WebChannel sending:",e),l.send(e))},Wr:()=>l.close()}),m=(e,t,n)=>{e.listen(t,(e=>{try{n(e)}catch(e){setTimeout((()=>{throw e}),0)}}))};return m(l,a.ii.EventType.OPEN,(()=>{d||g("Connection","WebChannel transport opened.")})),m(l,a.ii.EventType.CLOSE,(()=>{d||(d=!0,g("Connection","WebChannel transport closed"),f.eo())})),m(l,a.ii.EventType.ERROR,(e=>{d||(d=!0,y("Connection","WebChannel transport errored:",e),f.eo(new S(T.UNAVAILABLE,"The operation could not be completed")))})),m(l,a.ii.EventType.MESSAGE,(e=>{var t;if(!d){const n=e.data[0];I(!!n);const r=n,s=r.error||(null===(t=r[0])||void 0===t?void 0:t.error);if(s){g("Connection","WebChannel received error:",s);const e=s.status;let t=function(e){const t=An[e];if(void 0!==t)return Vn(t)}(e),n=s.message;void 0===t&&(t=T.INTERNAL,n="Unknown error status: "+e+" with message "+s.message),d=!0,f.eo(new S(t,n)),l.close()}else g("Connection","WebChannel received:",n),f.no(n)}})),m(i,a.ju.STAT_EVENT,(e=>{e.stat===a.kN.PROXY?g("Connection","Detected buffering proxy"):e.stat===a.kN.NOPROXY&&g("Connection","Detected no buffering proxy")})),setTimeout((()=>{f.Zr()}),0),f}}function bo(){return"undefined"!=typeof window?window:null}function Eo(){return"undefined"!=typeof document?document:null}function To(e){return new sr(e,!0)}class So{constructor(e,t,n=1e3,r=1.5,s=6e4){this.js=e,this.timerId=t,this.lo=n,this.fo=r,this._o=s,this.wo=0,this.mo=null,this.yo=Date.now(),this.reset()}reset(){this.wo=0}po(){this.wo=this._o}Io(e){this.cancel();const t=Math.floor(this.wo+this.To()),n=Math.max(0,Date.now()-this.yo),r=Math.max(0,t-n);r>0&&g("ExponentialBackoff",`Backing off for ${r} ms (base delay: ${this.wo} ms, delay with jitter: ${t} ms, last attempt: ${n} ms ago)`),this.mo=this.js.enqueueAfterDelay(this.timerId,r,(()=>(this.yo=Date.now(),e()))),this.wo*=this.fo,this.wo<this.lo&&(this.wo=this.lo),this.wo>this._o&&(this.wo=this._o)}Eo(){null!==this.mo&&(this.mo.skipDelay(),this.mo=null)}cancel(){null!==this.mo&&(this.mo.cancel(),this.mo=null)}To(){return(Math.random()-.5)*this.wo}}class xo{constructor(e,t,n,r,s,i,o,a){this.js=e,this.Ao=n,this.Ro=r,this.bo=s,this.authCredentialsProvider=i,this.appCheckCredentialsProvider=o,this.listener=a,this.state=0,this.Po=0,this.vo=null,this.Vo=null,this.stream=null,this.So=new So(e,t)}Do(){return 1===this.state||5===this.state||this.Co()}Co(){return 2===this.state||3===this.state}start(){4!==this.state?this.auth():this.xo()}async stop(){this.Do()&&await this.close(0)}No(){this.state=0,this.So.reset()}ko(){this.Co()&&null===this.vo&&(this.vo=this.js.enqueueAfterDelay(this.Ao,6e4,(()=>this.Oo())))}Mo(e){this.Fo(),this.stream.send(e)}async Oo(){if(this.Co())return this.close(0)}Fo(){this.vo&&(this.vo.cancel(),this.vo=null)}$o(){this.Vo&&(this.Vo.cancel(),this.Vo=null)}async close(e,t){this.Fo(),this.$o(),this.So.cancel(),this.Po++,4!==e?this.So.reset():t&&t.code===T.RESOURCE_EXHAUSTED?(p(t.toString()),p("Using maximum backoff delay to prevent overloading the backend."),this.So.po()):t&&t.code===T.UNAUTHENTICATED&&3!==this.state&&(this.authCredentialsProvider.invalidateToken(),this.appCheckCredentialsProvider.invalidateToken()),null!==this.stream&&(this.Bo(),this.stream.close(),this.stream=null),this.state=e,await this.listener.Jr(t)}Bo(){}auth(){this.state=1;const e=this.Lo(this.Po),t=this.Po;Promise.all([this.authCredentialsProvider.getToken(),this.appCheckCredentialsProvider.getToken()]).then((([e,n])=>{this.Po===t&&this.Uo(e,n)}),(t=>{e((()=>{const e=new S(T.UNKNOWN,"Fetching auth token failed: "+t.message);return this.qo(e)}))}))}Uo(e,t){const n=this.Lo(this.Po);this.stream=this.Ko(e,t),this.stream.zr((()=>{n((()=>(this.state=2,this.Vo=this.js.enqueueAfterDelay(this.Ro,1e4,(()=>(this.Co()&&(this.state=3),Promise.resolve()))),this.listener.zr())))})),this.stream.Jr((e=>{n((()=>this.qo(e)))})),this.stream.onMessage((e=>{n((()=>this.onMessage(e)))}))}xo(){this.state=5,this.So.Io((async()=>{this.state=0,this.start()}))}qo(e){return g("PersistentStream",`close with error: ${e}`),this.stream=null,this.close(4,e)}Lo(e){return t=>{this.js.enqueueAndForget((()=>this.Po===e?t():(g("PersistentStream","stream callback skipped by getCloseGuardedDispatcher."),Promise.resolve())))}}}class Do extends xo{constructor(e,t,n,r,s,i){super(e,"listen_stream_connection_backoff","listen_stream_idle","health_check_timeout",t,n,r,i),this.wt=s}Ko(e,t){return this.bo.ho("Listen",e,t)}onMessage(e){this.So.reset();const t=function(e,t){let n;if("targetChange"in t){t.targetChange;const r=function(e){return"NO_CHANGE"===e?0:"ADD"===e?1:"REMOVE"===e?2:"CURRENT"===e?3:"RESET"===e?4:v()}(t.targetChange.targetChangeType||"NO_CHANGE"),s=t.targetChange.targetIds||[],i=function(e,t){return e.dt?(I(void 0===t||"string"==typeof t),Ne.fromBase64String(t||"")):(I(void 0===t||t instanceof Uint8Array),Ne.fromUint8Array(t||new Uint8Array))}(e,t.targetChange.resumeToken),o=t.targetChange.cause,a=o&&function(e){const t=void 0===e.code?T.UNKNOWN:Vn(e.code);return new S(t,e.message||"")}(o);n=new Yn(r,s,i,a||null)}else if("documentChange"in t){t.documentChange;const r=t.documentChange;r.document,r.document.name,r.document.updateTime;const s=dr(e,r.document.name),i=ur(r.document.updateTime),o=new ut({mapValue:{fields:r.document.fields}}),a=lt.newFoundDocument(s,i,o),u=r.targetIds||[],c=r.removedTargetIds||[];n=new Hn(u,c,a.key,a)}else if("documentDelete"in t){t.documentDelete;const r=t.documentDelete;r.document;const s=dr(e,r.document),i=r.readTime?ur(r.readTime):U.min(),o=lt.newNoDocument(s,i),a=r.removedTargetIds||[];n=new Hn([],a,o.key,o)}else if("documentRemove"in t){t.documentRemove;const r=t.documentRemove;r.document;const s=dr(e,r.document),i=r.removedTargetIds||[];n=new Hn([],i,s,null)}else{if(!("filter"in t))return v();{t.filter;const e=t.filter;e.targetId;const r=e.count||0,s=new Nn(r),i=e.targetId;n=new Jn(i,s)}}return n}(this.wt,e),n=function(e){if(!("targetChange"in e))return U.min();const t=e.targetChange;return t.targetIds&&t.targetIds.length?U.min():t.readTime?ur(t.readTime):U.min()}(e);return this.listener.Go(t,n)}Qo(e){const t={};t.database=gr(this.wt),t.addTarget=function(e,t){let n;const r=t.target;return n=gt(r)?{documents:br(e,r)}:{query:Er(e,r)},n.targetId=t.targetId,t.resumeToken.approximateByteSize()>0?n.resumeToken=or(e,t.resumeToken):t.snapshotVersion.compareTo(U.min())>0&&(n.readTime=ir(e,t.snapshotVersion.toTimestamp())),n}(this.wt,e);const n=function(e,t){const n=function(e,t){switch(t){case 0:return null;case 1:return"existence-filter-mismatch";case 2:return"limbo-document";default:return v()}}(0,t.purpose);return null==n?null:{"goog-listen-tags":n}}(this.wt,e);n&&(t.labels=n),this.Mo(t)}jo(e){const t={};t.database=gr(this.wt),t.removeTarget=e,this.Mo(t)}}class _o extends xo{constructor(e,t,n,r,s,i){super(e,"write_stream_connection_backoff","write_stream_idle","health_check_timeout",t,n,r,i),this.wt=s,this.Wo=!1}get zo(){return this.Wo}start(){this.Wo=!1,this.lastStreamToken=void 0,super.start()}Bo(){this.Wo&&this.Ho([])}Ko(e,t){return this.bo.ho("Write",e,t)}onMessage(e){if(I(!!e.streamToken),this.lastStreamToken=e.streamToken,this.Wo){this.So.reset();const t=function(e,t){return e&&e.length>0?(I(void 0!==t),e.map((e=>function(e,t){let n=e.updateTime?ur(e.updateTime):ur(t);return n.isEqual(U.min())&&(n=ur(t)),new dn(n,e.transformResults||[])}(e,t)))):[]}(e.writeResults,e.commitTime),n=ur(e.commitTime);return this.listener.Jo(n,t)}return I(!e.writeResults||0===e.writeResults.length),this.Wo=!0,this.listener.Yo()}Xo(){const e={};e.database=gr(this.wt),this.Mo(e)}Ho(e){const t={streamToken:this.lastStreamToken,writes:e.map((e=>vr(this.wt,e)))};this.Mo(t)}}class No extends class{}{constructor(e,t,n,r){super(),this.authCredentials=e,this.appCheckCredentials=t,this.bo=n,this.wt=r,this.Zo=!1}tu(){if(this.Zo)throw new S(T.FAILED_PRECONDITION,"The client has already been terminated.")}ro(e,t,n){return this.tu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([r,s])=>this.bo.ro(e,t,n,r,s))).catch((e=>{throw"FirebaseError"===e.name?(e.code===T.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new S(T.UNKNOWN,e.toString())}))}ao(e,t,n,r){return this.tu(),Promise.all([this.authCredentials.getToken(),this.appCheckCredentials.getToken()]).then((([s,i])=>this.bo.ao(e,t,n,s,i,r))).catch((e=>{throw"FirebaseError"===e.name?(e.code===T.UNAUTHENTICATED&&(this.authCredentials.invalidateToken(),this.appCheckCredentials.invalidateToken()),e):new S(T.UNKNOWN,e.toString())}))}terminate(){this.Zo=!0}}class Ao{constructor(e,t){this.asyncQueue=e,this.onlineStateHandler=t,this.state="Unknown",this.eu=0,this.nu=null,this.su=!0}iu(){0===this.eu&&(this.ru("Unknown"),this.nu=this.asyncQueue.enqueueAfterDelay("online_state_timeout",1e4,(()=>(this.nu=null,this.ou("Backend didn't respond within 10 seconds."),this.ru("Offline"),Promise.resolve()))))}uu(e){"Online"===this.state?this.ru("Unknown"):(this.eu++,this.eu>=1&&(this.cu(),this.ou(`Connection failed 1 times. Most recent error: ${e.toString()}`),this.ru("Offline")))}set(e){this.cu(),this.eu=0,"Online"===e&&(this.su=!1),this.ru(e)}ru(e){e!==this.state&&(this.state=e,this.onlineStateHandler(e))}ou(e){const t=`Could not reach Cloud Firestore backend. ${e}\nThis typically indicates that your device does not have a healthy Internet connection at the moment. The client will operate in offline mode until it is able to successfully connect to the backend.`;this.su?(p(t),this.su=!1):g("OnlineStateTracker",t)}cu(){null!==this.nu&&(this.nu.cancel(),this.nu=null)}}class ko{constructor(e,t,n,r,s){this.localStore=e,this.datastore=t,this.asyncQueue=n,this.remoteSyncer={},this.au=[],this.hu=new Map,this.lu=new Set,this.fu=[],this.du=s,this.du.Br((e=>{n.enqueueAndForget((async()=>{qo(this)&&(g("RemoteStore","Restarting streams for network reachability change."),await async function(e){const t=E(e);t.lu.add(4),await Vo(t),t._u.set("Unknown"),t.lu.delete(4),await Co(t)}(this))}))})),this._u=new Ao(n,r)}}async function Co(e){if(qo(e))for(const t of e.fu)await t(!0)}async function Vo(e){for(const t of e.fu)await t(!1)}function Mo(e,t){const n=E(e);n.hu.has(t.targetId)||(n.hu.set(t.targetId,t),Po(n)?Oo(n):ra(n).Co()&&Lo(n,t))}function Ro(e,t){const n=E(e),r=ra(n);n.hu.delete(t),r.Co()&&Fo(n,t),0===n.hu.size&&(r.Co()?r.ko():qo(n)&&n._u.set("Unknown"))}function Lo(e,t){e.wu.Nt(t.targetId),ra(e).Qo(t)}function Fo(e,t){e.wu.Nt(t),ra(e).jo(t)}function Oo(e){e.wu=new Zn({getRemoteKeysForTarget:t=>e.remoteSyncer.getRemoteKeysForTarget(t),te:t=>e.hu.get(t)||null}),ra(e).start(),e._u.iu()}function Po(e){return qo(e)&&!ra(e).Do()&&e.hu.size>0}function qo(e){return 0===E(e).lu.size}function Uo(e){e.wu=void 0}async function Bo(e){e.hu.forEach(((t,n)=>{Lo(e,t)}))}async function Ko(e,t){Uo(e),Po(e)?(e._u.uu(t),Oo(e)):e._u.set("Unknown")}async function Go(e,t,n){if(e._u.set("Online"),t instanceof Yn&&2===t.state&&t.cause)try{await async function(e,t){const n=t.cause;for(const r of t.targetIds)e.hu.has(r)&&(await e.remoteSyncer.rejectListen(r,n),e.hu.delete(r),e.wu.removeTarget(r))}(e,t)}catch(n){g("RemoteStore","Failed to remove targets %s: %s ",t.targetIds.join(","),n),await $o(e,n)}else if(t instanceof Hn?e.wu.Ut(t):t instanceof Jn?e.wu.zt(t):e.wu.Gt(t),!n.isEqual(U.min()))try{const t=await Hi(e.localStore);n.compareTo(t)>=0&&await function(e,t){const n=e.wu.Yt(t);return n.targetChanges.forEach(((n,r)=>{if(n.resumeToken.approximateByteSize()>0){const s=e.hu.get(r);s&&e.hu.set(r,s.withResumeToken(n.resumeToken,t))}})),n.targetMismatches.forEach((t=>{const n=e.hu.get(t);if(!n)return;e.hu.set(t,n.withResumeToken(Ne.EMPTY_BYTE_STRING,n.snapshotVersion)),Fo(e,t);const r=new hs(n.target,t,1,n.sequenceNumber);Lo(e,r)})),e.remoteSyncer.applyRemoteEvent(n)}(e,n)}catch(t){g("RemoteStore","Failed to raise snapshot:",t),await $o(e,t)}}async function $o(e,t,n){if(!ce(t))throw t;e.lu.add(1),await Vo(e),e._u.set("Offline"),n||(n=()=>Hi(e.localStore)),e.asyncQueue.enqueueRetryable((async()=>{g("RemoteStore","Retrying IndexedDB access"),await n(),e.lu.delete(1),await Co(e)}))}function zo(e,t){return t().catch((n=>$o(e,n,t)))}async function jo(e){const t=E(e),n=sa(t);let r=t.au.length>0?t.au[t.au.length-1].batchId:-1;for(;Qo(t);)try{const e=await Yi(t.localStore,r);if(null===e){0===t.au.length&&n.ko();break}r=e.batchId,Wo(t,e)}catch(e){await $o(t,e)}Ho(t)&&Jo(t)}function Qo(e){return qo(e)&&e.au.length<10}function Wo(e,t){e.au.push(t);const n=sa(e);n.Co()&&n.zo&&n.Ho(t.mutations)}function Ho(e){return qo(e)&&!sa(e).Do()&&e.au.length>0}function Jo(e){sa(e).start()}async function Yo(e){sa(e).Xo()}async function Xo(e){const t=sa(e);for(const n of e.au)t.Ho(n.mutations)}async function Zo(e,t,n){const r=e.au.shift(),s=cs.from(r,t,n);await zo(e,(()=>e.remoteSyncer.applySuccessfulWrite(s))),await jo(e)}async function ea(e,t){t&&sa(e).zo&&await async function(e,t){if(Cn(n=t.code)&&n!==T.ABORTED){const n=e.au.shift();sa(e).No(),await zo(e,(()=>e.remoteSyncer.rejectFailedWrite(n.batchId,t))),await jo(e)}var n}(e,t),Ho(e)&&Jo(e)}async function ta(e,t){const n=E(e);n.asyncQueue.verifyOperationInProgress(),g("RemoteStore","RemoteStore received new credentials");const r=qo(n);n.lu.add(3),await Vo(n),r&&n._u.set("Unknown"),await n.remoteSyncer.handleCredentialChange(t),n.lu.delete(3),await Co(n)}async function na(e,t){const n=E(e);t?(n.lu.delete(2),await Co(n)):t||(n.lu.add(2),await Vo(n),n._u.set("Unknown"))}function ra(e){return e.mu||(e.mu=function(e,t,n){const r=E(e);return r.tu(),new Do(t,r.bo,r.authCredentials,r.appCheckCredentials,r.wt,n)}(e.datastore,e.asyncQueue,{zr:Bo.bind(null,e),Jr:Ko.bind(null,e),Go:Go.bind(null,e)}),e.fu.push((async t=>{t?(e.mu.No(),Po(e)?Oo(e):e._u.set("Unknown")):(await e.mu.stop(),Uo(e))}))),e.mu}function sa(e){return e.gu||(e.gu=function(e,t,n){const r=E(e);return r.tu(),new _o(t,r.bo,r.authCredentials,r.appCheckCredentials,r.wt,n)}(e.datastore,e.asyncQueue,{zr:Yo.bind(null,e),Jr:ea.bind(null,e),Yo:Xo.bind(null,e),Jo:Zo.bind(null,e)}),e.fu.push((async t=>{t?(e.gu.No(),await jo(e)):(await e.gu.stop(),e.au.length>0&&(g("RemoteStore",`Stopping write stream with ${e.au.length} pending writes`),e.au=[]))}))),e.gu}class ia{constructor(e,t,n,r,s){this.asyncQueue=e,this.timerId=t,this.targetTimeMs=n,this.op=r,this.removalCallback=s,this.deferred=new x,this.then=this.deferred.promise.then.bind(this.deferred.promise),this.deferred.promise.catch((e=>{}))}static createAndSchedule(e,t,n,r,s){const i=Date.now()+n,o=new ia(e,t,i,r,s);return o.start(n),o}start(e){this.timerHandle=setTimeout((()=>this.handleDelayElapsed()),e)}skipDelay(){return this.handleDelayElapsed()}cancel(e){null!==this.timerHandle&&(this.clearTimeout(),this.deferred.reject(new S(T.CANCELLED,"Operation cancelled"+(e?": "+e:""))))}handleDelayElapsed(){this.asyncQueue.enqueueAndForget((()=>null!==this.timerHandle?(this.clearTimeout(),this.op().then((e=>this.deferred.resolve(e)))):Promise.resolve()))}clearTimeout(){null!==this.timerHandle&&(this.removalCallback(this),clearTimeout(this.timerHandle),this.timerHandle=null)}}function oa(e,t){if(p("AsyncQueue",`${t}: ${e}`),ce(e))return new S(T.UNAVAILABLE,`${t}: ${e}`);throw e}class aa{constructor(e){this.comparator=e?(t,n)=>e(t,n)||z.comparator(t.key,n.key):(e,t)=>z.comparator(e.key,t.key),this.keyedMap=On(),this.sortedSet=new Ie(this.comparator)}static emptySet(e){return new aa(e.comparator)}has(e){return null!=this.keyedMap.get(e)}get(e){return this.keyedMap.get(e)}first(){return this.sortedSet.minKey()}last(){return this.sortedSet.maxKey()}isEmpty(){return this.sortedSet.isEmpty()}indexOf(e){const t=this.keyedMap.get(e);return t?this.sortedSet.indexOf(t):-1}get size(){return this.sortedSet.size}forEach(e){this.sortedSet.inorderTraversal(((t,n)=>(e(t),!1)))}add(e){const t=this.delete(e.key);return t.copy(t.keyedMap.insert(e.key,e),t.sortedSet.insert(e,null))}delete(e){const t=this.get(e);return t?this.copy(this.keyedMap.remove(e),this.sortedSet.remove(t)):this}isEqual(e){if(!(e instanceof aa))return!1;if(this.size!==e.size)return!1;const t=this.sortedSet.getIterator(),n=e.sortedSet.getIterator();for(;t.hasNext();){const e=t.getNext().key,r=n.getNext().key;if(!e.isEqual(r))return!1}return!0}toString(){const e=[];return this.forEach((t=>{e.push(t.toString())})),0===e.length?"DocumentSet ()":"DocumentSet (\n  "+e.join("  \n")+"\n)"}copy(e,t){const n=new aa;return n.comparator=this.comparator,n.keyedMap=e,n.sortedSet=t,n}}class ua{constructor(){this.yu=new Ie(z.comparator)}track(e){const t=e.doc.key,n=this.yu.get(t);n?0!==e.type&&3===n.type?this.yu=this.yu.insert(t,e):3===e.type&&1!==n.type?this.yu=this.yu.insert(t,{type:n.type,doc:e.doc}):2===e.type&&2===n.type?this.yu=this.yu.insert(t,{type:2,doc:e.doc}):2===e.type&&0===n.type?this.yu=this.yu.insert(t,{type:0,doc:e.doc}):1===e.type&&0===n.type?this.yu=this.yu.remove(t):1===e.type&&2===n.type?this.yu=this.yu.insert(t,{type:1,doc:n.doc}):0===e.type&&1===n.type?this.yu=this.yu.insert(t,{type:2,doc:e.doc}):v():this.yu=this.yu.insert(t,e)}pu(){const e=[];return this.yu.inorderTraversal(((t,n)=>{e.push(n)})),e}}class ca{constructor(e,t,n,r,s,i,o,a){this.query=e,this.docs=t,this.oldDocs=n,this.docChanges=r,this.mutatedKeys=s,this.fromCache=i,this.syncStateChanged=o,this.excludesMetadataChanges=a}static fromInitialDocuments(e,t,n,r){const s=[];return t.forEach((e=>{s.push({type:0,doc:e})})),new ca(e,t,aa.emptySet(t),s,n,r,!0,!1)}get hasPendingWrites(){return!this.mutatedKeys.isEmpty()}isEqual(e){if(!(this.fromCache===e.fromCache&&this.syncStateChanged===e.syncStateChanged&&this.mutatedKeys.isEqual(e.mutatedKeys)&&Kt(this.query,e.query)&&this.docs.isEqual(e.docs)&&this.oldDocs.isEqual(e.oldDocs)))return!1;const t=this.docChanges,n=e.docChanges;if(t.length!==n.length)return!1;for(let r=0;r<t.length;r++)if(t[r].type!==n[r].type||!t[r].doc.isEqual(n[r].doc))return!1;return!0}}class la{constructor(){this.Iu=void 0,this.listeners=[]}}class ha{constructor(){this.queries=new Mn((e=>Gt(e)),Kt),this.onlineState="Unknown",this.Tu=new Set}}async function da(e,t){const n=E(e),r=t.query;let s=!1,i=n.queries.get(r);if(i||(s=!0,i=new la),s)try{i.Iu=await n.onListen(r)}catch(e){const n=oa(e,`Initialization of query '${$t(t.query)}' failed`);return void t.onError(n)}n.queries.set(r,i),i.listeners.push(t),t.Eu(n.onlineState),i.Iu&&t.Au(i.Iu)&&pa(n)}async function fa(e,t){const n=E(e),r=t.query;let s=!1;const i=n.queries.get(r);if(i){const e=i.listeners.indexOf(t);e>=0&&(i.listeners.splice(e,1),s=0===i.listeners.length)}if(s)return n.queries.delete(r),n.onUnlisten(r)}function ma(e,t){const n=E(e);let r=!1;for(const s of t){const e=s.query,t=n.queries.get(e);if(t){for(const e of t.listeners)e.Au(s)&&(r=!0);t.Iu=s}}r&&pa(n)}function ga(e,t,n){const r=E(e),s=r.queries.get(t);if(s)for(const i of s.listeners)i.onError(n);r.queries.delete(t)}function pa(e){e.Tu.forEach((e=>{e.next()}))}class ya{constructor(e,t,n){this.query=e,this.Ru=t,this.bu=!1,this.Pu=null,this.onlineState="Unknown",this.options=n||{}}Au(e){if(!this.options.includeMetadataChanges){const t=[];for(const n of e.docChanges)3!==n.type&&t.push(n);e=new ca(e.query,e.docs,e.oldDocs,t,e.mutatedKeys,e.fromCache,e.syncStateChanged,!0)}let t=!1;return this.bu?this.vu(e)&&(this.Ru.next(e),t=!0):this.Vu(e,this.onlineState)&&(this.Su(e),t=!0),this.Pu=e,t}onError(e){this.Ru.error(e)}Eu(e){this.onlineState=e;let t=!1;return this.Pu&&!this.bu&&this.Vu(this.Pu,e)&&(this.Su(this.Pu),t=!0),t}Vu(e,t){if(!e.fromCache)return!0;const n="Offline"!==t;return(!this.options.Du||!n)&&(!e.docs.isEmpty()||"Offline"===t)}vu(e){if(e.docChanges.length>0)return!0;const t=this.Pu&&this.Pu.hasPendingWrites!==e.hasPendingWrites;return!(!e.syncStateChanged&&!t)&&!0===this.options.includeMetadataChanges}Su(e){e=ca.fromInitialDocuments(e.query,e.docs,e.mutatedKeys,e.fromCache),this.bu=!0,this.Ru.next(e)}}class wa{constructor(e,t){this.payload=e,this.byteLength=t}Cu(){return"metadata"in this.payload}}class va{constructor(e){this.wt=e}Wi(e){return dr(this.wt,e)}zi(e){return e.metadata.exists?wr(this.wt,e.document,!1):lt.newNoDocument(this.Wi(e.metadata.name),this.Hi(e.metadata.readTime))}Hi(e){return ur(e)}}class Ia{constructor(e,t,n){this.xu=e,this.localStore=t,this.wt=n,this.queries=[],this.documents=[],this.collectionGroups=new Set,this.progress=ba(e)}Nu(e){this.progress.bytesLoaded+=e.byteLength;let t=this.progress.documentsLoaded;if(e.payload.namedQuery)this.queries.push(e.payload.namedQuery);else if(e.payload.documentMetadata){this.documents.push({metadata:e.payload.documentMetadata}),e.payload.documentMetadata.exists||++t;const n=K.fromString(e.payload.documentMetadata.name);this.collectionGroups.add(n.get(n.length-2))}else e.payload.document&&(this.documents[this.documents.length-1].document=e.payload.document,++t);return t!==this.progress.documentsLoaded?(this.progress.documentsLoaded=t,Object.assign({},this.progress)):null}ku(e){const t=new Map,n=new va(this.wt);for(const r of e)if(r.metadata.queries){const e=n.Wi(r.metadata.name);for(const n of r.metadata.queries){const r=(t.get(n)||$n()).add(e);t.set(n,r)}}return t}async complete(){const e=await async function(e,t,n,r){const s=E(e);let i=$n(),o=Ln();for(const c of n){const e=t.Wi(c.metadata.name);c.document&&(i=i.add(e));const n=t.zi(c);n.setReadTime(t.Hi(c.metadata.readTime)),o=o.insert(e,n)}const a=s.Ui.newChangeBuffer({trackRemovals:!0}),u=await Xi(s,function(e){return Ut(Lt(K.fromString(`__bundle__/docs/${e}`)))}(r));return s.persistence.runTransaction("Apply bundle documents","readwrite",(e=>Ji(e,a,o).next((t=>(a.apply(e),t))).next((t=>s.Vs.removeMatchingKeysForTargetId(e,u.targetId).next((()=>s.Vs.addMatchingKeys(e,i,u.targetId))).next((()=>s.localDocuments.getLocalViewOfDocuments(e,t.Gi,t.Qi))).next((()=>t.Gi))))))}(this.localStore,new va(this.wt),this.documents,this.xu.id),t=this.ku(this.documents);for(const n of this.queries)await so(this.localStore,n,t.get(n.name));return this.progress.taskState="Success",{progress:this.progress,Ou:this.collectionGroups,Mu:e}}}function ba(e){return{taskState:"Running",documentsLoaded:0,bytesLoaded:0,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}class Ea{constructor(e){this.key=e}}class Ta{constructor(e){this.key=e}}class Sa{constructor(e,t){this.query=e,this.Fu=t,this.$u=null,this.current=!1,this.Bu=$n(),this.mutatedKeys=$n(),this.Lu=Qt(e),this.Uu=new aa(this.Lu)}get qu(){return this.Fu}Ku(e,t){const n=t?t.Gu:new ua,r=t?t.Uu:this.Uu;let s=t?t.mutatedKeys:this.mutatedKeys,i=r,o=!1;const a="F"===this.query.limitType&&r.size===this.query.limit?r.last():null,u="L"===this.query.limitType&&r.size===this.query.limit?r.first():null;if(e.inorderTraversal(((e,t)=>{const c=r.get(e),l=zt(this.query,t)?t:null,h=!!c&&this.mutatedKeys.has(c.key),d=!!l&&(l.hasLocalMutations||this.mutatedKeys.has(l.key)&&l.hasCommittedMutations);let f=!1;c&&l?c.data.isEqual(l.data)?h!==d&&(n.track({type:3,doc:l}),f=!0):this.Qu(c,l)||(n.track({type:2,doc:l}),f=!0,(a&&this.Lu(l,a)>0||u&&this.Lu(l,u)<0)&&(o=!0)):!c&&l?(n.track({type:0,doc:l}),f=!0):c&&!l&&(n.track({type:1,doc:c}),f=!0,(a||u)&&(o=!0)),f&&(l?(i=i.add(l),s=d?s.add(e):s.delete(e)):(i=i.delete(e),s=s.delete(e)))})),null!==this.query.limit)for(;i.size>this.query.limit;){const e="F"===this.query.limitType?i.last():i.first();i=i.delete(e.key),s=s.delete(e.key),n.track({type:1,doc:e})}return{Uu:i,Gu:n,Oi:o,mutatedKeys:s}}Qu(e,t){return e.hasLocalMutations&&t.hasCommittedMutations&&!t.hasLocalMutations}applyChanges(e,t,n){const r=this.Uu;this.Uu=e.Uu,this.mutatedKeys=e.mutatedKeys;const s=e.Gu.pu();s.sort(((e,t)=>function(e,t){const n=e=>{switch(e){case 0:return 1;case 2:case 3:return 2;case 1:return 0;default:return v()}};return n(e)-n(t)}(e.type,t.type)||this.Lu(e.doc,t.doc))),this.ju(n);const i=t?this.Wu():[],o=0===this.Bu.size&&this.current?1:0,a=o!==this.$u;return this.$u=o,0!==s.length||a?{snapshot:new ca(this.query,e.Uu,r,s,e.mutatedKeys,0===o,a,!1),zu:i}:{zu:i}}Eu(e){return this.current&&"Offline"===e?(this.current=!1,this.applyChanges({Uu:this.Uu,Gu:new ua,mutatedKeys:this.mutatedKeys,Oi:!1},!1)):{zu:[]}}Hu(e){return!this.Fu.has(e)&&!!this.Uu.has(e)&&!this.Uu.get(e).hasLocalMutations}ju(e){e&&(e.addedDocuments.forEach((e=>this.Fu=this.Fu.add(e))),e.modifiedDocuments.forEach((e=>{})),e.removedDocuments.forEach((e=>this.Fu=this.Fu.delete(e))),this.current=e.current)}Wu(){if(!this.current)return[];const e=this.Bu;this.Bu=$n(),this.Uu.forEach((e=>{this.Hu(e.key)&&(this.Bu=this.Bu.add(e.key))}));const t=[];return e.forEach((e=>{this.Bu.has(e)||t.push(new Ta(e))})),this.Bu.forEach((n=>{e.has(n)||t.push(new Ea(n))})),t}Ju(e){this.Fu=e.ji,this.Bu=$n();const t=this.Ku(e.documents);return this.applyChanges(t,!0)}Yu(){return ca.fromInitialDocuments(this.query,this.Uu,this.mutatedKeys,0===this.$u)}}class xa{constructor(e,t,n){this.query=e,this.targetId=t,this.view=n}}class Da{constructor(e){this.key=e,this.Xu=!1}}class _a{constructor(e,t,n,r,s,i){this.localStore=e,this.remoteStore=t,this.eventManager=n,this.sharedClientState=r,this.currentUser=s,this.maxConcurrentLimboResolutions=i,this.Zu={},this.tc=new Mn((e=>Gt(e)),Kt),this.ec=new Map,this.nc=new Set,this.sc=new Ie(z.comparator),this.ic=new Map,this.rc=new Ni,this.oc={},this.uc=new Map,this.cc=si.Rn(),this.onlineState="Unknown",this.ac=void 0}get isPrimaryClient(){return!0===this.ac}}async function Na(e,t){const n=eu(e);let r,s;const i=n.tc.get(t);if(i)r=i.targetId,n.sharedClientState.addLocalQueryTarget(r),s=i.view.Yu();else{const e=await Xi(n.localStore,Ut(t));n.isPrimaryClient&&Mo(n.remoteStore,e);const i=n.sharedClientState.addLocalQueryTarget(e.targetId);r=e.targetId,s=await Aa(n,t,r,"current"===i)}return s}async function Aa(e,t,n,r){e.hc=(t,n,r)=>async function(e,t,n,r){let s=t.view.Ku(n);s.Oi&&(s=await eo(e.localStore,t.query,!1).then((({documents:e})=>t.view.Ku(e,s))));const i=r&&r.targetChanges.get(t.targetId),o=t.view.applyChanges(s,e.isPrimaryClient,i);return Ua(e,t.targetId,o.zu),o.snapshot}(e,t,n,r);const s=await eo(e.localStore,t,!0),i=new Sa(t,s.ji),o=i.Ku(s.documents),a=Wn.createSynthesizedTargetChangeForCurrentChange(n,r&&"Offline"!==e.onlineState),u=i.applyChanges(o,e.isPrimaryClient,a);Ua(e,n,u.zu);const c=new xa(t,n,i);return e.tc.set(t,c),e.ec.has(n)?e.ec.get(n).push(t):e.ec.set(n,[t]),u.snapshot}async function ka(e,t){const n=E(e),r=n.tc.get(t),s=n.ec.get(r.targetId);if(s.length>1)return n.ec.set(r.targetId,s.filter((e=>!Kt(e,t)))),void n.tc.delete(t);n.isPrimaryClient?(n.sharedClientState.removeLocalQueryTarget(r.targetId),n.sharedClientState.isActiveQueryTarget(r.targetId)||await Zi(n.localStore,r.targetId,!1).then((()=>{n.sharedClientState.clearQueryState(r.targetId),Ro(n.remoteStore,r.targetId),Pa(n,r.targetId)})).catch(re)):(Pa(n,r.targetId),await Zi(n.localStore,r.targetId,!0))}async function Ca(e,t){const n=E(e);try{const e=await function(e,t){const n=E(e),r=t.snapshotVersion;let s=n.$i;return n.persistence.runTransaction("Apply remote event","readwrite-primary",(e=>{const i=n.Ui.newChangeBuffer({trackRemovals:!0});s=n.$i;const o=[];t.targetChanges.forEach(((i,a)=>{const u=s.get(a);if(!u)return;o.push(n.Vs.removeMatchingKeys(e,i.removedDocuments,a).next((()=>n.Vs.addMatchingKeys(e,i.addedDocuments,a))));let c=u.withSequenceNumber(e.currentSequenceNumber);t.targetMismatches.has(a)?c=c.withResumeToken(Ne.EMPTY_BYTE_STRING,U.min()).withLastLimboFreeSnapshotVersion(U.min()):i.resumeToken.approximateByteSize()>0&&(c=c.withResumeToken(i.resumeToken,r)),s=s.insert(a,c),function(e,t,n){return 0===e.resumeToken.approximateByteSize()||t.snapshotVersion.toMicroseconds()-e.snapshotVersion.toMicroseconds()>=3e8||n.addedDocuments.size+n.modifiedDocuments.size+n.removedDocuments.size>0}(u,c,i)&&o.push(n.Vs.updateTargetData(e,c))}));let a=Ln(),u=$n();if(t.documentUpdates.forEach((r=>{t.resolvedLimboDocuments.has(r)&&o.push(n.persistence.referenceDelegate.updateLimboDocument(e,r))})),o.push(Ji(e,i,t.documentUpdates).next((e=>{a=e.Gi,u=e.Qi}))),!r.isEqual(U.min())){const t=n.Vs.getLastRemoteSnapshotVersion(e).next((t=>n.Vs.setTargetsMetadata(e,e.currentSequenceNumber,r)));o.push(t)}return se.waitFor(o).next((()=>i.apply(e))).next((()=>n.localDocuments.getLocalViewOfDocuments(e,a,u))).next((()=>a))})).then((e=>(n.$i=s,e)))}(n.localStore,t);t.targetChanges.forEach(((e,t)=>{const r=n.ic.get(t);r&&(I(e.addedDocuments.size+e.modifiedDocuments.size+e.removedDocuments.size<=1),e.addedDocuments.size>0?r.Xu=!0:e.modifiedDocuments.size>0?I(r.Xu):e.removedDocuments.size>0&&(I(r.Xu),r.Xu=!1))})),await Ga(n,e,t)}catch(e){await re(e)}}function Va(e,t,n){const r=E(e);if(r.isPrimaryClient&&0===n||!r.isPrimaryClient&&1===n){const e=[];r.tc.forEach(((n,r)=>{const s=r.view.Eu(t);s.snapshot&&e.push(s.snapshot)})),function(e,t){const n=E(e);n.onlineState=t;let r=!1;n.queries.forEach(((e,n)=>{for(const s of n.listeners)s.Eu(t)&&(r=!0)})),r&&pa(n)}(r.eventManager,t),e.length&&r.Zu.Go(e),r.onlineState=t,r.isPrimaryClient&&r.sharedClientState.setOnlineState(t)}}async function Ma(e,t,n){const r=E(e);r.sharedClientState.updateQueryState(t,"rejected",n);const s=r.ic.get(t),i=s&&s.key;if(i){let e=new Ie(z.comparator);e=e.insert(i,lt.newNoDocument(i,U.min()));const n=$n().add(i),s=new Qn(U.min(),new Map,new Te(F),e,n);await Ca(r,s),r.sc=r.sc.remove(i),r.ic.delete(t),Ka(r)}else await Zi(r.localStore,t,!1).then((()=>Pa(r,t,n))).catch(re)}async function Ra(e,t){const n=E(e),r=t.batch.batchId;try{const e=await function(e,t){const n=E(e);return n.persistence.runTransaction("Acknowledge batch","readwrite-primary",(e=>{const r=t.batch.keys(),s=n.Ui.newChangeBuffer({trackRemovals:!0});return function(e,t,n,r){const s=n.batch,i=s.keys();let o=se.resolve();return i.forEach((e=>{o=o.next((()=>r.getEntry(t,e))).next((t=>{const i=n.docVersions.get(e);I(null!==i),t.version.compareTo(i)<0&&(s.applyToRemoteDocument(t,n),t.isValidDocument()&&(t.setReadTime(n.commitVersion),r.addEntry(t)))}))})),o.next((()=>e.mutationQueue.removeMutationBatch(t,s)))}(n,e,t,s).next((()=>s.apply(e))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t.batch.batchId))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,function(e){let t=$n();for(let n=0;n<e.mutationResults.length;++n)e.mutationResults[n].transformResults.length>0&&(t=t.add(e.batch.mutations[n].key));return t}(t)))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(n.localStore,t);Oa(n,r,null),Fa(n,r),n.sharedClientState.updateMutationState(r,"acknowledged"),await Ga(n,e)}catch(e){await re(e)}}async function La(e,t,n){const r=E(e);try{const e=await function(e,t){const n=E(e);return n.persistence.runTransaction("Reject batch","readwrite-primary",(e=>{let r;return n.mutationQueue.lookupMutationBatch(e,t).next((t=>(I(null!==t),r=t.keys(),n.mutationQueue.removeMutationBatch(e,t)))).next((()=>n.mutationQueue.performConsistencyCheck(e))).next((()=>n.documentOverlayCache.removeOverlaysForBatchId(e,r,t))).next((()=>n.localDocuments.recalculateAndSaveOverlaysForDocumentKeys(e,r))).next((()=>n.localDocuments.getDocuments(e,r)))}))}(r.localStore,t);Oa(r,t,n),Fa(r,t),r.sharedClientState.updateMutationState(t,"rejected",n),await Ga(r,e)}catch(n){await re(n)}}function Fa(e,t){(e.uc.get(t)||[]).forEach((e=>{e.resolve()})),e.uc.delete(t)}function Oa(e,t,n){const r=E(e);let s=r.oc[r.currentUser.toKey()];if(s){const e=s.get(t);e&&(n?e.reject(n):e.resolve(),s=s.remove(t)),r.oc[r.currentUser.toKey()]=s}}function Pa(e,t,n=null){e.sharedClientState.removeLocalQueryTarget(t);for(const r of e.ec.get(t))e.tc.delete(r),n&&e.Zu.lc(r,n);e.ec.delete(t),e.isPrimaryClient&&e.rc.us(t).forEach((t=>{e.rc.containsKey(t)||qa(e,t)}))}function qa(e,t){e.nc.delete(t.path.canonicalString());const n=e.sc.get(t);null!==n&&(Ro(e.remoteStore,n),e.sc=e.sc.remove(t),e.ic.delete(n),Ka(e))}function Ua(e,t,n){for(const r of n)r instanceof Ea?(e.rc.addReference(r.key,t),Ba(e,r)):r instanceof Ta?(g("SyncEngine","Document no longer in limbo: "+r.key),e.rc.removeReference(r.key,t),e.rc.containsKey(r.key)||qa(e,r.key)):v()}function Ba(e,t){const n=t.key,r=n.path.canonicalString();e.sc.get(n)||e.nc.has(r)||(g("SyncEngine","New document in limbo: "+n),e.nc.add(r),Ka(e))}function Ka(e){for(;e.nc.size>0&&e.sc.size<e.maxConcurrentLimboResolutions;){const t=e.nc.values().next().value;e.nc.delete(t);const n=new z(K.fromString(t)),r=e.cc.next();e.ic.set(r,new Da(n)),e.sc=e.sc.insert(n,r),Mo(e.remoteStore,new hs(Ut(Lt(n.path)),r,2,pe.ot))}}async function Ga(e,t,n){const r=E(e),s=[],i=[],o=[];r.tc.isEmpty()||(r.tc.forEach(((e,a)=>{o.push(r.hc(a,t,n).then((e=>{if(e){r.isPrimaryClient&&r.sharedClientState.updateQueryState(a.targetId,e.fromCache?"not-current":"current"),s.push(e);const t=$i.Vi(a.targetId,e);i.push(t)}})))})),await Promise.all(o),r.Zu.Go(s),await async function(e,t){const n=E(e);try{await n.persistence.runTransaction("notifyLocalViewChanges","readwrite",(e=>se.forEach(t,(t=>se.forEach(t.Pi,(r=>n.persistence.referenceDelegate.addReference(e,t.targetId,r))).next((()=>se.forEach(t.vi,(r=>n.persistence.referenceDelegate.removeReference(e,t.targetId,r)))))))))}catch(e){if(!ce(e))throw e;g("LocalStore","Failed to update sequence numbers: "+e)}for(const r of t){const e=r.targetId;if(!r.fromCache){const t=n.$i.get(e),r=t.snapshotVersion,s=t.withLastLimboFreeSnapshotVersion(r);n.$i=n.$i.insert(e,s)}}}(r.localStore,i))}async function $a(e,t){const n=E(e);if(!n.currentUser.isEqual(t)){g("SyncEngine","User change. New user:",t.toKey());const e=await Wi(n.localStore,t);n.currentUser=t,function(e,t){e.uc.forEach((e=>{e.forEach((e=>{e.reject(new S(T.CANCELLED,"'waitForPendingWrites' promise is rejected due to a user change."))}))})),e.uc.clear()}(n),n.sharedClientState.handleUserChange(t,e.removedBatchIds,e.addedBatchIds),await Ga(n,e.Ki)}}function za(e,t){const n=E(e),r=n.ic.get(t);if(r&&r.Xu)return $n().add(r.key);{let e=$n();const r=n.ec.get(t);if(!r)return e;for(const t of r){const r=n.tc.get(t);e=e.unionWith(r.view.qu)}return e}}async function ja(e,t){const n=E(e),r=await eo(n.localStore,t.query,!0),s=t.view.Ju(r);return n.isPrimaryClient&&Ua(n,t.targetId,s.zu),s}async function Qa(e,t){const n=E(e);return no(n.localStore,t).then((e=>Ga(n,e)))}async function Wa(e,t,n,r){const s=E(e),i=await function(e,t){const n=E(e),r=E(n.mutationQueue);return n.persistence.runTransaction("Lookup mutation documents","readonly",(e=>r.yn(e,t).next((t=>t?n.localDocuments.getDocuments(e,t):se.resolve(null)))))}(s.localStore,t);null!==i?("pending"===n?await jo(s.remoteStore):"acknowledged"===n||"rejected"===n?(Oa(s,t,r||null),Fa(s,t),function(e,t){E(E(e).mutationQueue).In(t)}(s.localStore,t)):v(),await Ga(s,i)):g("SyncEngine","Cannot apply mutation batch with id: "+t)}async function Ha(e,t,n){const r=E(e),s=[],i=[];for(const o of t){let e;const t=r.ec.get(o);if(t&&0!==t.length){e=await Xi(r.localStore,Ut(t[0]));for(const e of t){const t=r.tc.get(e),n=await ja(r,t);n.snapshot&&i.push(n.snapshot)}}else{const t=await to(r.localStore,o);e=await Xi(r.localStore,t),await Aa(r,Ja(t),o,!1)}s.push(e)}return r.Zu.Go(i),s}function Ja(e){return Rt(e.path,e.collectionGroup,e.orderBy,e.filters,e.limit,"F",e.startAt,e.endAt)}function Ya(e){const t=E(e);return E(E(t.localStore).persistence).Ri()}async function Xa(e,t,n,r){const s=E(e);if(s.ac)return void g("SyncEngine","Ignoring unexpected query state notification.");const i=s.ec.get(t);if(i&&i.length>0)switch(n){case"current":case"not-current":{const e=await no(s.localStore,jt(i[0])),r=Qn.createSynthesizedRemoteEventForCurrentChange(t,"current"===n);await Ga(s,e,r);break}case"rejected":await Zi(s.localStore,t,!0),Pa(s,t,r);break;default:v()}}async function Za(e,t,n){const r=eu(e);if(r.ac){for(const e of t){if(r.ec.has(e)){g("SyncEngine","Adding an already active target "+e);continue}const t=await to(r.localStore,e),n=await Xi(r.localStore,t);await Aa(r,Ja(t),n.targetId,!1),Mo(r.remoteStore,n)}for(const e of n)r.ec.has(e)&&await Zi(r.localStore,e,!1).then((()=>{Ro(r.remoteStore,e),Pa(r,e)})).catch(re)}}function eu(e){const t=E(e);return t.remoteStore.remoteSyncer.applyRemoteEvent=Ca.bind(null,t),t.remoteStore.remoteSyncer.getRemoteKeysForTarget=za.bind(null,t),t.remoteStore.remoteSyncer.rejectListen=Ma.bind(null,t),t.Zu.Go=ma.bind(null,t.eventManager),t.Zu.lc=ga.bind(null,t.eventManager),t}function tu(e){const t=E(e);return t.remoteStore.remoteSyncer.applySuccessfulWrite=Ra.bind(null,t),t.remoteStore.remoteSyncer.rejectFailedWrite=La.bind(null,t),t}class nu{constructor(){this.synchronizeTabs=!1}async initialize(e){this.wt=To(e.databaseInfo.databaseId),this.sharedClientState=this.dc(e),this.persistence=this._c(e),await this.persistence.start(),this.localStore=this.wc(e),this.gcScheduler=this.mc(e,this.localStore),this.indexBackfillerScheduler=this.gc(e,this.localStore)}mc(e,t){return null}gc(e,t){return null}wc(e){return Qi(this.persistence,new zi,e.initialUser,this.wt)}_c(e){return new Ri(Fi.Ms,this.wt)}dc(e){return new go}async terminate(){this.gcScheduler&&this.gcScheduler.stop(),await this.sharedClientState.shutdown(),await this.persistence.shutdown()}}class ru extends nu{constructor(e,t,n){super(),this.yc=e,this.cacheSizeBytes=t,this.forceOwnership=n,this.synchronizeTabs=!1}async initialize(e){await super.initialize(e),await this.yc.initialize(this,e),await tu(this.yc.syncEngine),await jo(this.yc.remoteStore),await this.persistence.ci((()=>(this.gcScheduler&&!this.gcScheduler.started&&this.gcScheduler.start(),this.indexBackfillerScheduler&&!this.indexBackfillerScheduler.started&&this.indexBackfillerScheduler.start(),Promise.resolve())))}wc(e){return Qi(this.persistence,new zi,e.initialUser,this.wt)}mc(e,t){const n=this.persistence.referenceDelegate.garbageCollector;return new hi(n,e.asyncQueue,t)}gc(e,t){const n=new ge(t,this.persistence);return new me(e.asyncQueue,n)}_c(e){const t=Gi(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey),n=void 0!==this.cacheSizeBytes?Js.withCacheSize(this.cacheSizeBytes):Js.DEFAULT;return new Ui(this.synchronizeTabs,t,e.clientId,n,e.asyncQueue,bo(),Eo(),this.wt,this.sharedClientState,!!this.forceOwnership)}dc(e){return new go}}class su extends ru{constructor(e,t){super(e,t,!1),this.yc=e,this.cacheSizeBytes=t,this.synchronizeTabs=!0}async initialize(e){await super.initialize(e);const t=this.yc.syncEngine;this.sharedClientState instanceof mo&&(this.sharedClientState.syncEngine={kr:Wa.bind(null,t),Or:Xa.bind(null,t),Mr:Za.bind(null,t),Ri:Ya.bind(null,t),Nr:Qa.bind(null,t)},await this.sharedClientState.start()),await this.persistence.ci((async e=>{await async function(e,t){const n=E(e);if(eu(n),tu(n),!0===t&&!0!==n.ac){const e=n.sharedClientState.getAllActiveQueryTargets(),t=await Ha(n,e.toArray());n.ac=!0,await na(n.remoteStore,!0);for(const r of t)Mo(n.remoteStore,r)}else if(!1===t&&!1!==n.ac){const e=[];let t=Promise.resolve();n.ec.forEach(((r,s)=>{n.sharedClientState.isLocalQueryTarget(s)?e.push(s):t=t.then((()=>(Pa(n,s),Zi(n.localStore,s,!0)))),Ro(n.remoteStore,s)})),await t,await Ha(n,e),function(e){const t=E(e);t.ic.forEach(((e,n)=>{Ro(t.remoteStore,n)})),t.rc.cs(),t.ic=new Map,t.sc=new Ie(z.comparator)}(n),n.ac=!1,await na(n.remoteStore,!1)}}(this.yc.syncEngine,e),this.gcScheduler&&(e&&!this.gcScheduler.started?this.gcScheduler.start():e||this.gcScheduler.stop()),this.indexBackfillerScheduler&&(e&&!this.indexBackfillerScheduler.started?this.indexBackfillerScheduler.start():e||this.indexBackfillerScheduler.stop())}))}dc(e){const t=bo();if(!mo.V(t))throw new S(T.UNIMPLEMENTED,"IndexedDB persistence is only available on platforms that support LocalStorage.");const n=Gi(e.databaseInfo.databaseId,e.databaseInfo.persistenceKey);return new mo(t,e.asyncQueue,n,e.clientId,e.initialUser)}}class iu{async initialize(e,t){this.localStore||(this.localStore=e.localStore,this.sharedClientState=e.sharedClientState,this.datastore=this.createDatastore(t),this.remoteStore=this.createRemoteStore(t),this.eventManager=this.createEventManager(t),this.syncEngine=this.createSyncEngine(t,!e.synchronizeTabs),this.sharedClientState.onlineStateHandler=e=>Va(this.syncEngine,e,1),this.remoteStore.remoteSyncer.handleCredentialChange=$a.bind(null,this.syncEngine),await na(this.remoteStore,this.syncEngine.isPrimaryClient))}createEventManager(e){return new ha}createDatastore(e){const t=To(e.databaseInfo.databaseId),n=(r=e.databaseInfo,new Io(r));var r;return function(e,t,n,r){return new No(e,t,n,r)}(e.authCredentials,e.appCheckCredentials,n,t)}createRemoteStore(e){return t=this.localStore,n=this.datastore,r=e.asyncQueue,s=e=>Va(this.syncEngine,e,0),i=yo.V()?new yo:new po,new ko(t,n,r,s,i);var t,n,r,s,i}createSyncEngine(e,t){return function(e,t,n,r,s,i,o){const a=new _a(e,t,n,r,s,i);return o&&(a.ac=!0),a}(this.localStore,this.remoteStore,this.eventManager,this.sharedClientState,e.initialUser,e.maxConcurrentLimboResolutions,t)}terminate(){return async function(e){const t=E(e);g("RemoteStore","RemoteStore shutting down."),t.lu.add(5),await Vo(t),t.du.shutdown(),t._u.set("Unknown")}(this.remoteStore)}}function ou(e,t=10240){let n=0;return{async read(){if(n<e.byteLength){const r={value:e.slice(n,n+t),done:!1};return n+=t,r}return{done:!0}},async cancel(){},releaseLock(){},closed:Promise.reject("unimplemented")}}class au{constructor(e){this.observer=e,this.muted=!1}next(e){this.observer.next&&this.Ic(this.observer.next,e)}error(e){this.observer.error?this.Ic(this.observer.error,e):console.error("Uncaught Error in snapshot listener:",e)}Tc(){this.muted=!0}Ic(e,t){this.muted||setTimeout((()=>{this.muted||e(t)}),0)}}class uu{constructor(e,t){this.Ec=e,this.wt=t,this.metadata=new x,this.buffer=new Uint8Array,this.Ac=new TextDecoder("utf-8"),this.Rc().then((e=>{e&&e.Cu()?this.metadata.resolve(e.payload.metadata):this.metadata.reject(new Error(`The first element of the bundle is not a metadata, it is\n             ${JSON.stringify(null==e?void 0:e.payload)}`))}),(e=>this.metadata.reject(e)))}close(){return this.Ec.cancel()}async getMetadata(){return this.metadata.promise}async fc(){return await this.getMetadata(),this.Rc()}async Rc(){const e=await this.bc();if(null===e)return null;const t=this.Ac.decode(e),n=Number(t);isNaN(n)&&this.Pc(`length string (${t}) is not valid number`);const r=await this.vc(n);return new wa(JSON.parse(r),e.length+n)}Vc(){return this.buffer.findIndex((e=>e==="{".charCodeAt(0)))}async bc(){for(;this.Vc()<0&&!(await this.Sc()););if(0===this.buffer.length)return null;const e=this.Vc();e<0&&this.Pc("Reached the end of bundle when a length string is expected.");const t=this.buffer.slice(0,e);return this.buffer=this.buffer.slice(e),t}async vc(e){for(;this.buffer.length<e;)await this.Sc()&&this.Pc("Reached the end of bundle when more is expected.");const t=this.Ac.decode(this.buffer.slice(0,e));return this.buffer=this.buffer.slice(e),t}Pc(e){throw this.Ec.cancel(),new Error(`Invalid bundle format: ${e}`)}async Sc(){const e=await this.Ec.read();if(!e.done){const t=new Uint8Array(this.buffer.length+e.value.length);t.set(this.buffer),t.set(e.value,this.buffer.length),this.buffer=t}return e.done}}class cu{constructor(e){this.datastore=e,this.readVersions=new Map,this.mutations=[],this.committed=!1,this.lastWriteError=null,this.writtenDocs=new Set}async lookup(e){if(this.ensureCommitNotCalled(),this.mutations.length>0)throw new S(T.INVALID_ARGUMENT,"Firestore transactions require all reads to be executed before all writes.");const t=await async function(e,t){const n=E(e),r=gr(n.wt)+"/documents",s={documents:t.map((e=>hr(n.wt,e)))},i=await n.ao("BatchGetDocuments",r,s,t.length),o=new Map;i.forEach((e=>{const t=function(e,t){return"found"in t?function(e,t){I(!!t.found),t.found.name,t.found.updateTime;const n=dr(e,t.found.name),r=ur(t.found.updateTime),s=new ut({mapValue:{fields:t.found.fields}});return lt.newFoundDocument(n,r,s)}(e,t):"missing"in t?function(e,t){I(!!t.missing),I(!!t.readTime);const n=dr(e,t.missing),r=ur(t.readTime);return lt.newNoDocument(n,r)}(e,t):v()}(n.wt,e);o.set(t.key.toString(),t)}));const a=[];return t.forEach((e=>{const t=o.get(e.toString());I(!!t),a.push(t)})),a}(this.datastore,e);return t.forEach((e=>this.recordVersion(e))),t}set(e,t){this.write(t.toMutation(e,this.precondition(e))),this.writtenDocs.add(e.toString())}update(e,t){try{this.write(t.toMutation(e,this.preconditionForUpdate(e)))}catch(e){this.lastWriteError=e}this.writtenDocs.add(e.toString())}delete(e){this.write(new Dn(e,this.precondition(e))),this.writtenDocs.add(e.toString())}async commit(){if(this.ensureCommitNotCalled(),this.lastWriteError)throw this.lastWriteError;const e=this.readVersions;this.mutations.forEach((t=>{e.delete(t.key.toString())})),e.forEach(((e,t)=>{const n=z.fromPath(t);this.mutations.push(new _n(n,this.precondition(n)))})),await async function(e,t){const n=E(e),r=gr(n.wt)+"/documents",s={writes:t.map((e=>vr(n.wt,e)))};await n.ro("Commit",r,s)}(this.datastore,this.mutations),this.committed=!0}recordVersion(e){let t;if(e.isFoundDocument())t=e.version;else{if(!e.isNoDocument())throw v();t=U.min()}const n=this.readVersions.get(e.key.toString());if(n){if(!t.isEqual(n))throw new S(T.ABORTED,"Document version changed between two reads.")}else this.readVersions.set(e.key.toString(),t)}precondition(e){const t=this.readVersions.get(e.toString());return!this.writtenDocs.has(e.toString())&&t?fn.updateTime(t):fn.none()}preconditionForUpdate(e){const t=this.readVersions.get(e.toString());if(!this.writtenDocs.has(e.toString())&&t){if(t.isEqual(U.min()))throw new S(T.INVALID_ARGUMENT,"Can't update a document that doesn't exist.");return fn.updateTime(t)}return fn.exists(!0)}write(e){this.ensureCommitNotCalled(),this.mutations.push(e)}ensureCommitNotCalled(){}}class lu{constructor(e,t,n,r,s){this.asyncQueue=e,this.datastore=t,this.options=n,this.updateFunction=r,this.deferred=s,this.Dc=n.maxAttempts,this.So=new So(this.asyncQueue,"transaction_retry")}run(){this.Dc-=1,this.Cc()}Cc(){this.So.Io((async()=>{const e=new cu(this.datastore),t=this.xc(e);t&&t.then((t=>{this.asyncQueue.enqueueAndForget((()=>e.commit().then((()=>{this.deferred.resolve(t)})).catch((e=>{this.Nc(e)}))))})).catch((e=>{this.Nc(e)}))}))}xc(e){try{const t=this.updateFunction(e);return!Pe(t)&&t.catch&&t.then?t:(this.deferred.reject(Error("Transaction callback must return a Promise")),null)}catch(e){return this.deferred.reject(e),null}}Nc(e){this.Dc>0&&this.kc(e)?(this.Dc-=1,this.asyncQueue.enqueueAndForget((()=>(this.Cc(),Promise.resolve())))):this.deferred.reject(e)}kc(e){if("FirebaseError"===e.name){const t=e.code;return"aborted"===t||"failed-precondition"===t||!Cn(t)}return!1}}class hu{constructor(e,t,n,r){this.authCredentials=e,this.appCheckCredentials=t,this.asyncQueue=n,this.databaseInfo=r,this.user=l.UNAUTHENTICATED,this.clientId=L.I(),this.authCredentialListener=()=>Promise.resolve(),this.appCheckCredentialListener=()=>Promise.resolve(),this.authCredentials.start(n,(async e=>{g("FirestoreClient","Received user=",e.uid),await this.authCredentialListener(e),this.user=e})),this.appCheckCredentials.start(n,(e=>(g("FirestoreClient","Received new app check token=",e),this.appCheckCredentialListener(e,this.user))))}async getConfiguration(){return{asyncQueue:this.asyncQueue,databaseInfo:this.databaseInfo,clientId:this.clientId,authCredentials:this.authCredentials,appCheckCredentials:this.appCheckCredentials,initialUser:this.user,maxConcurrentLimboResolutions:100}}setCredentialChangeListener(e){this.authCredentialListener=e}setAppCheckTokenChangeListener(e){this.appCheckCredentialListener=e}verifyNotTerminated(){if(this.asyncQueue.isShuttingDown)throw new S(T.FAILED_PRECONDITION,"The client has already been terminated.")}terminate(){this.asyncQueue.enterRestrictedMode();const e=new x;return this.asyncQueue.enqueueAndForgetEvenWhileRestricted((async()=>{try{this.onlineComponents&&await this.onlineComponents.terminate(),this.offlineComponents&&await this.offlineComponents.terminate(),this.authCredentials.shutdown(),this.appCheckCredentials.shutdown(),e.resolve()}catch(t){const n=oa(t,"Failed to shutdown persistence");e.reject(n)}})),e.promise}}async function du(e,t){e.asyncQueue.verifyOperationInProgress(),g("FirestoreClient","Initializing OfflineComponentProvider");const n=await e.getConfiguration();await t.initialize(n);let r=n.initialUser;e.setCredentialChangeListener((async e=>{r.isEqual(e)||(await Wi(t.localStore,e),r=e)})),t.persistence.setDatabaseDeletedListener((()=>e.terminate())),e.offlineComponents=t}async function fu(e,t){e.asyncQueue.verifyOperationInProgress();const n=await mu(e);g("FirestoreClient","Initializing OnlineComponentProvider");const r=await e.getConfiguration();await t.initialize(n,r),e.setCredentialChangeListener((e=>ta(t.remoteStore,e))),e.setAppCheckTokenChangeListener(((e,n)=>ta(t.remoteStore,n))),e.onlineComponents=t}async function mu(e){return e.offlineComponents||(g("FirestoreClient","Using default OfflineComponentProvider"),await du(e,new nu)),e.offlineComponents}async function gu(e){return e.onlineComponents||(g("FirestoreClient","Using default OnlineComponentProvider"),await fu(e,new iu)),e.onlineComponents}function pu(e){return mu(e).then((e=>e.persistence))}function yu(e){return mu(e).then((e=>e.localStore))}function wu(e){return gu(e).then((e=>e.remoteStore))}function vu(e){return gu(e).then((e=>e.syncEngine))}async function Iu(e){const t=await gu(e),n=t.eventManager;return n.onListen=Na.bind(null,t.syncEngine),n.onUnlisten=ka.bind(null,t.syncEngine),n}function bu(e,t,n={}){const r=new x;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new au({next:i=>{t.enqueueAndForget((()=>fa(e,o)));const a=i.docs.has(n);!a&&i.fromCache?s.reject(new S(T.UNAVAILABLE,"Failed to get document because the client is offline.")):a&&i.fromCache&&r&&"server"===r.source?s.reject(new S(T.UNAVAILABLE,'Failed to get document from server. (However, this document does exist in the local cache. Run again without setting source to "server" to retrieve the cached document.)')):s.resolve(i)},error:e=>s.reject(e)}),o=new ya(Lt(n.path),i,{includeMetadataChanges:!0,Du:!0});return da(e,o)}(await Iu(e),e.asyncQueue,t,n,r))),r.promise}function Eu(e,t,n={}){const r=new x;return e.asyncQueue.enqueueAndForget((async()=>function(e,t,n,r,s){const i=new au({next:n=>{t.enqueueAndForget((()=>fa(e,o))),n.fromCache&&"server"===r.source?s.reject(new S(T.UNAVAILABLE,'Failed to get documents from server. (However, these documents may exist in the local cache. Run again without setting source to "server" to retrieve the cached documents.)')):s.resolve(n)},error:e=>s.reject(e)}),o=new ya(n,i,{includeMetadataChanges:!0,Du:!0});return da(e,o)}(await Iu(e),e.asyncQueue,t,n,r))),r.promise}function Tu(e,t,n,r){const s=function(e,t){let n;return n="string"==typeof e?(new TextEncoder).encode(e):e,function(e,t){return new uu(e,t)}(function(e,t){if(e instanceof Uint8Array)return ou(e,t);if(e instanceof ArrayBuffer)return ou(new Uint8Array(e),t);if(e instanceof ReadableStream)return e.getReader();throw new Error("Source of `toByteStreamReader` has to be a ArrayBuffer or ReadableStream")}(n),t)}(n,To(t));e.asyncQueue.enqueueAndForget((async()=>{!function(e,t,n){const r=E(e);(async function(e,t,n){try{const r=await t.getMetadata();if(await function(e,t){const n=E(e),r=ur(t.createTime);return n.persistence.runTransaction("hasNewerBundle","readonly",(e=>n.Ds.getBundleMetadata(e,t.id))).then((e=>!!e&&e.createTime.compareTo(r)>=0))}(e.localStore,r))return await t.close(),n._completeWith(function(e){return{taskState:"Success",documentsLoaded:e.totalDocuments,bytesLoaded:e.totalBytes,totalDocuments:e.totalDocuments,totalBytes:e.totalBytes}}(r)),Promise.resolve(new Set);n._updateProgress(ba(r));const s=new Ia(r,e.localStore,t.wt);let i=await t.fc();for(;i;){const e=await s.Nu(i);e&&n._updateProgress(e),i=await t.fc()}const o=await s.complete();return await Ga(e,o.Mu,void 0),await function(e,t){const n=E(e);return n.persistence.runTransaction("Save bundle","readwrite",(e=>n.Ds.saveBundleMetadata(e,t)))}(e.localStore,r),n._completeWith(o.progress),Promise.resolve(o.Ou)}catch(e){return y("SyncEngine",`Loading bundle failed with ${e}`),n._failWith(e),Promise.resolve(new Set)}})(r,t,n).then((e=>{r.sharedClientState.notifyBundleLoaded(e)}))}(await vu(e),s,r)}))}const Su=new Map;function xu(e,t,n){if(!n)throw new S(T.INVALID_ARGUMENT,`Function ${e}() cannot be called with an empty ${t}.`)}function Du(e,t,n,r){if(!0===t&&!0===r)throw new S(T.INVALID_ARGUMENT,`${e} and ${n} cannot be used together.`)}function _u(e){if(!z.isDocumentKey(e))throw new S(T.INVALID_ARGUMENT,`Invalid document reference. Document references must have an even number of segments, but ${e} has ${e.length}.`)}function Nu(e){if(z.isDocumentKey(e))throw new S(T.INVALID_ARGUMENT,`Invalid collection reference. Collection references must have an odd number of segments, but ${e} has ${e.length}.`)}function Au(e){if(void 0===e)return"undefined";if(null===e)return"null";if("string"==typeof e)return e.length>20&&(e=`${e.substring(0,20)}...`),JSON.stringify(e);if("number"==typeof e||"boolean"==typeof e)return""+e;if("object"==typeof e){if(e instanceof Array)return"an array";{const t=function(e){return e.constructor?e.constructor.name:null}(e);return t?`a custom ${t} object`:"an object"}}return"function"==typeof e?"a function":v()}function ku(e,t){if("_delegate"in e&&(e=e._delegate),!(e instanceof t)){if(t.name===e.constructor.name)throw new S(T.INVALID_ARGUMENT,"Type does not match the expected instance. Did you pass a reference from a different Firestore SDK?");{const n=Au(e);throw new S(T.INVALID_ARGUMENT,`Expected type '${t.name}', but it was: ${n}`)}}return e}function Cu(e,t){if(t<=0)throw new S(T.INVALID_ARGUMENT,`Function ${e}() requires a positive number, but it was: ${t}.`)}class Vu{constructor(e){var t;if(void 0===e.host){if(void 0!==e.ssl)throw new S(T.INVALID_ARGUMENT,"Can't provide ssl option if host option is not set");this.host="firestore.googleapis.com",this.ssl=!0}else this.host=e.host,this.ssl=null===(t=e.ssl)||void 0===t||t;if(this.credentials=e.credentials,this.ignoreUndefinedProperties=!!e.ignoreUndefinedProperties,void 0===e.cacheSizeBytes)this.cacheSizeBytes=41943040;else{if(-1!==e.cacheSizeBytes&&e.cacheSizeBytes<1048576)throw new S(T.INVALID_ARGUMENT,"cacheSizeBytes must be at least 1048576");this.cacheSizeBytes=e.cacheSizeBytes}this.experimentalForceLongPolling=!!e.experimentalForceLongPolling,this.experimentalAutoDetectLongPolling=!!e.experimentalAutoDetectLongPolling,this.useFetchStreams=!!e.useFetchStreams,Du("experimentalForceLongPolling",e.experimentalForceLongPolling,"experimentalAutoDetectLongPolling",e.experimentalAutoDetectLongPolling)}isEqual(e){return this.host===e.host&&this.ssl===e.ssl&&this.credentials===e.credentials&&this.cacheSizeBytes===e.cacheSizeBytes&&this.experimentalForceLongPolling===e.experimentalForceLongPolling&&this.experimentalAutoDetectLongPolling===e.experimentalAutoDetectLongPolling&&this.ignoreUndefinedProperties===e.ignoreUndefinedProperties&&this.useFetchStreams===e.useFetchStreams}}class Mu{constructor(e,t,n){this._authCredentials=t,this._appCheckCredentials=n,this.type="firestore-lite",this._persistenceKey="(lite)",this._settings=new Vu({}),this._settingsFrozen=!1,e instanceof Oe?this._databaseId=e:(this._app=e,this._databaseId=function(e){if(!Object.prototype.hasOwnProperty.apply(e.options,["projectId"]))throw new S(T.INVALID_ARGUMENT,'"projectId" not provided in firebase.initializeApp.');return new Oe(e.options.projectId)}(e))}get app(){if(!this._app)throw new S(T.FAILED_PRECONDITION,"Firestore was not initialized using the Firebase SDK. 'app' is not available");return this._app}get _initialized(){return this._settingsFrozen}get _terminated(){return void 0!==this._terminateTask}_setSettings(e){if(this._settingsFrozen)throw new S(T.FAILED_PRECONDITION,"Firestore has already been started and its settings can no longer be changed. You can only modify settings before calling any other methods on a Firestore object.");this._settings=new Vu(e),void 0!==e.credentials&&(this._authCredentials=function(e){if(!e)return new _;switch(e.type){case"gapi":const t=e.client;return I(!("object"!=typeof t||null===t||!t.auth||!t.auth.getAuthHeaderValueForFirstParty)),new C(t,e.sessionIndex||"0",e.iamToken||null);case"provider":return e.client;default:throw new S(T.INVALID_ARGUMENT,"makeAuthCredentialsProvider failed due to invalid credential type")}}(e.credentials))}_getSettings(){return this._settings}_freezeSettings(){return this._settingsFrozen=!0,this._settings}_delete(){return this._terminateTask||(this._terminateTask=this._terminate()),this._terminateTask}toJSON(){return{app:this._app,databaseId:this._databaseId,settings:this._settings}}_terminate(){return function(e){const t=Su.get(e);t&&(g("ComponentProvider","Removing Datastore"),Su.delete(e),t.terminate())}(this),Promise.resolve()}}function Ru(e,t,n,r={}){var s;const i=(e=ku(e,Mu))._getSettings();if("firestore.googleapis.com"!==i.host&&i.host!==t&&y("Host has been set in both settings() and useEmulator(), emulator host will be used"),e._setSettings(Object.assign(Object.assign({},i),{host:`${t}:${n}`,ssl:!1})),r.mockUserToken){let t,n;if("string"==typeof r.mockUserToken)t=r.mockUserToken,n=l.MOCK_USER;else{t=(0,o.Sg)(r.mockUserToken,null===(s=e._app)||void 0===s?void 0:s.options.projectId);const i=r.mockUserToken.sub||r.mockUserToken.user_id;if(!i)throw new S(T.INVALID_ARGUMENT,"mockUserToken must contain 'sub' or 'user_id' field!");n=new l(i)}e._authCredentials=new N(new D(t,n))}}class Lu{constructor(e,t,n){this.converter=t,this._key=n,this.type="document",this.firestore=e}get _path(){return this._key.path}get id(){return this._key.path.lastSegment()}get path(){return this._key.path.canonicalString()}get parent(){return new Ou(this.firestore,this.converter,this._key.path.popLast())}withConverter(e){return new Lu(this.firestore,e,this._key)}}class Fu{constructor(e,t,n){this.converter=t,this._query=n,this.type="query",this.firestore=e}withConverter(e){return new Fu(this.firestore,e,this._query)}}class Ou extends Fu{constructor(e,t,n){super(e,t,Lt(n)),this._path=n,this.type="collection"}get id(){return this._query.path.lastSegment()}get path(){return this._query.path.canonicalString()}get parent(){const e=this._path.popLast();return e.isEmpty()?null:new Lu(this.firestore,null,new z(e))}withConverter(e){return new Ou(this.firestore,e,this._path)}}function Pu(e,t,...n){if(e=(0,o.m9)(e),xu("collection","path",t),e instanceof Mu){const r=K.fromString(t,...n);return Nu(r),new Ou(e,null,r)}{if(!(e instanceof Lu||e instanceof Ou))throw new S(T.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(K.fromString(t,...n));return Nu(r),new Ou(e.firestore,null,r)}}function qu(e,t){if(e=ku(e,Mu),xu("collectionGroup","collection id",t),t.indexOf("/")>=0)throw new S(T.INVALID_ARGUMENT,`Invalid collection ID '${t}' passed to function collectionGroup(). Collection IDs must not contain '/'.`);return new Fu(e,null,function(e){return new Mt(K.emptyPath(),e)}(t))}function Uu(e,t,...n){if(e=(0,o.m9)(e),1===arguments.length&&(t=L.I()),xu("doc","path",t),e instanceof Mu){const r=K.fromString(t,...n);return _u(r),new Lu(e,null,new z(r))}{if(!(e instanceof Lu||e instanceof Ou))throw new S(T.INVALID_ARGUMENT,"Expected first argument to collection() to be a CollectionReference, a DocumentReference or FirebaseFirestore");const r=e._path.child(K.fromString(t,...n));return _u(r),new Lu(e.firestore,e instanceof Ou?e.converter:null,new z(r))}}function Bu(e,t){return e=(0,o.m9)(e),t=(0,o.m9)(t),(e instanceof Lu||e instanceof Ou)&&(t instanceof Lu||t instanceof Ou)&&e.firestore===t.firestore&&e.path===t.path&&e.converter===t.converter}function Ku(e,t){return e=(0,o.m9)(e),t=(0,o.m9)(t),e instanceof Fu&&t instanceof Fu&&e.firestore===t.firestore&&Kt(e._query,t._query)&&e.converter===t.converter}class Gu{constructor(){this.Oc=Promise.resolve(),this.Mc=[],this.Fc=!1,this.$c=[],this.Bc=null,this.Lc=!1,this.Uc=!1,this.qc=[],this.So=new So(this,"async_queue_retry"),this.Kc=()=>{const e=Eo();e&&g("AsyncQueue","Visibility state changed to "+e.visibilityState),this.So.Eo()};const e=Eo();e&&"function"==typeof e.addEventListener&&e.addEventListener("visibilitychange",this.Kc)}get isShuttingDown(){return this.Fc}enqueueAndForget(e){this.enqueue(e)}enqueueAndForgetEvenWhileRestricted(e){this.Gc(),this.Qc(e)}enterRestrictedMode(e){if(!this.Fc){this.Fc=!0,this.Uc=e||!1;const t=Eo();t&&"function"==typeof t.removeEventListener&&t.removeEventListener("visibilitychange",this.Kc)}}enqueue(e){if(this.Gc(),this.Fc)return new Promise((()=>{}));const t=new x;return this.Qc((()=>this.Fc&&this.Uc?Promise.resolve():(e().then(t.resolve,t.reject),t.promise))).then((()=>t.promise))}enqueueRetryable(e){this.enqueueAndForget((()=>(this.Mc.push(e),this.jc())))}async jc(){if(0!==this.Mc.length){try{await this.Mc[0](),this.Mc.shift(),this.So.reset()}catch(e){if(!ce(e))throw e;g("AsyncQueue","Operation failed with retryable error: "+e)}this.Mc.length>0&&this.So.Io((()=>this.jc()))}}Qc(e){const t=this.Oc.then((()=>(this.Lc=!0,e().catch((e=>{this.Bc=e,this.Lc=!1;const t=function(e){let t=e.message||"";return e.stack&&(t=e.stack.includes(e.message)?e.stack:e.message+"\n"+e.stack),t}(e);throw p("INTERNAL UNHANDLED ERROR: ",t),e})).then((e=>(this.Lc=!1,e))))));return this.Oc=t,t}enqueueAfterDelay(e,t,n){this.Gc(),this.qc.indexOf(e)>-1&&(t=0);const r=ia.createAndSchedule(this,e,t,n,(e=>this.Wc(e)));return this.$c.push(r),r}Gc(){this.Bc&&v()}verifyOperationInProgress(){}async zc(){let e;do{e=this.Oc,await e}while(e!==this.Oc)}Hc(e){for(const t of this.$c)if(t.timerId===e)return!0;return!1}Jc(e){return this.zc().then((()=>{this.$c.sort(((e,t)=>e.targetTimeMs-t.targetTimeMs));for(const t of this.$c)if(t.skipDelay(),"all"!==e&&t.timerId===e)break;return this.zc()}))}Yc(e){this.qc.push(e)}Wc(e){const t=this.$c.indexOf(e);this.$c.splice(t,1)}}function $u(e){return function(e,t){if("object"!=typeof e||null===e)return!1;const n=e;for(const r of["next","error","complete"])if(r in n&&"function"==typeof n[r])return!0;return!1}(e)}class zu{constructor(){this._progressObserver={},this._taskCompletionResolver=new x,this._lastProgress={taskState:"Running",totalBytes:0,totalDocuments:0,bytesLoaded:0,documentsLoaded:0}}onProgress(e,t,n){this._progressObserver={next:e,error:t,complete:n}}catch(e){return this._taskCompletionResolver.promise.catch(e)}then(e,t){return this._taskCompletionResolver.promise.then(e,t)}_completeWith(e){this._updateProgress(e),this._progressObserver.complete&&this._progressObserver.complete(),this._taskCompletionResolver.resolve(e)}_failWith(e){this._lastProgress.taskState="Error",this._progressObserver.next&&this._progressObserver.next(this._lastProgress),this._progressObserver.error&&this._progressObserver.error(e),this._taskCompletionResolver.reject(e)}_updateProgress(e){this._lastProgress=e,this._progressObserver.next&&this._progressObserver.next(e)}}const ju=-1;class Qu extends Mu{constructor(e,t,n){super(e,t,n),this.type="firestore",this._queue=new Gu,this._persistenceKey="name"in e?e.name:"[DEFAULT]"}_terminate(){return this._firestoreClient||Hu(this),this._firestoreClient.terminate()}}function Wu(e){return e._firestoreClient||Hu(e),e._firestoreClient.verifyNotTerminated(),e._firestoreClient}function Hu(e){var t;const n=e._freezeSettings(),r=function(e,t,n,r){return new Fe(e,t,n,r.host,r.ssl,r.experimentalForceLongPolling,r.experimentalAutoDetectLongPolling,r.useFetchStreams)}(e._databaseId,(null===(t=e._app)||void 0===t?void 0:t.options.appId)||"",e._persistenceKey,n);e._firestoreClient=new hu(e._authCredentials,e._appCheckCredentials,e._queue,r)}function Ju(e,t){ic(e=ku(e,Qu));const n=Wu(e),r=e._freezeSettings(),s=new iu;return Xu(n,s,new ru(s,r.cacheSizeBytes,null==t?void 0:t.forceOwnership))}function Yu(e){ic(e=ku(e,Qu));const t=Wu(e),n=e._freezeSettings(),r=new iu;return Xu(t,r,new su(r,n.cacheSizeBytes))}function Xu(e,t,n){const r=new x;return e.asyncQueue.enqueue((async()=>{try{await du(e,n),await fu(e,t),r.resolve()}catch(e){const n=e;if(!function(e){return"FirebaseError"===e.name?e.code===T.FAILED_PRECONDITION||e.code===T.UNIMPLEMENTED:!("undefined"!=typeof DOMException&&e instanceof DOMException)||(22===e.code||20===e.code||11===e.code)}(n))throw n;console.warn("Error enabling offline persistence. Falling back to persistence disabled: "+n),r.reject(n)}})).then((()=>r.promise))}function Zu(e){if(e._initialized&&!e._terminated)throw new S(T.FAILED_PRECONDITION,"Persistence can only be cleared before a Firestore instance is initialized or after it is terminated.");const t=new x;return e._queue.enqueueAndForgetEvenWhileRestricted((async()=>{try{await async function(e){if(!oe.V())return Promise.resolve();const t=e+"main";await oe.delete(t)}(Gi(e._databaseId,e._persistenceKey)),t.resolve()}catch(e){t.reject(e)}})),t.promise}function ec(e){return function(e){const t=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t){const n=E(e);qo(n.remoteStore)||g("SyncEngine","The network is disabled. The task returned by 'awaitPendingWrites()' will not complete until the network is enabled.");try{const e=await function(e){const t=E(e);return t.persistence.runTransaction("Get highest unacknowledged batch id","readonly",(e=>t.mutationQueue.getHighestUnacknowledgedBatchId(e)))}(n.localStore);if(-1===e)return void t.resolve();const r=n.uc.get(e)||[];r.push(t),n.uc.set(e,r)}catch(e){const n=oa(e,"Initialization of waitForPendingWrites() operation failed");t.reject(n)}}(await vu(e),t))),t.promise}(Wu(e=ku(e,Qu)))}function tc(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await pu(e),n=await wu(e);return t.setNetworkEnabled(!0),function(e){const t=E(e);return t.lu.delete(0),Co(t)}(n)}))}(Wu(e=ku(e,Qu)))}function nc(e){return function(e){return e.asyncQueue.enqueue((async()=>{const t=await pu(e),n=await wu(e);return t.setNetworkEnabled(!1),async function(e){const t=E(e);t.lu.add(0),await Vo(t),t._u.set("Offline")}(n)}))}(Wu(e=ku(e,Qu)))}function rc(e,t){const n=Wu(e=ku(e,Qu)),r=new zu;return Tu(n,e._databaseId,t,r),r}function sc(e,t){return function(e,t){return e.asyncQueue.enqueue((async()=>function(e,t){const n=E(e);return n.persistence.runTransaction("Get named query","readonly",(e=>n.Ds.getNamedQuery(e,t)))}(await yu(e),t)))}(Wu(e=ku(e,Qu)),t).then((t=>t?new Fu(e,null,t.query):null))}function ic(e){if(e._initialized||e._terminated)throw new S(T.FAILED_PRECONDITION,"Firestore has already been started and persistence can no longer be enabled. You can only enable persistence before calling any other methods on a Firestore object.")}class oc{constructor(...e){for(let t=0;t<e.length;++t)if(0===e[t].length)throw new S(T.INVALID_ARGUMENT,"Invalid field name at argument $(i + 1). Field names must not be empty.");this._internalPath=new $(e)}isEqual(e){return this._internalPath.isEqual(e._internalPath)}}class ac{constructor(e){this._byteString=e}static fromBase64String(e){try{return new ac(Ne.fromBase64String(e))}catch(e){throw new S(T.INVALID_ARGUMENT,"Failed to construct data from Base64 string: "+e)}}static fromUint8Array(e){return new ac(Ne.fromUint8Array(e))}toBase64(){return this._byteString.toBase64()}toUint8Array(){return this._byteString.toUint8Array()}toString(){return"Bytes(base64: "+this.toBase64()+")"}isEqual(e){return this._byteString.isEqual(e._byteString)}}class uc{constructor(e){this._methodName=e}}class cc{constructor(e,t){if(!isFinite(e)||e<-90||e>90)throw new S(T.INVALID_ARGUMENT,"Latitude must be a number between -90 and 90, but was: "+e);if(!isFinite(t)||t<-180||t>180)throw new S(T.INVALID_ARGUMENT,"Longitude must be a number between -180 and 180, but was: "+t);this._lat=e,this._long=t}get latitude(){return this._lat}get longitude(){return this._long}isEqual(e){return this._lat===e._lat&&this._long===e._long}toJSON(){return{latitude:this._lat,longitude:this._long}}_compareTo(e){return F(this._lat,e._lat)||F(this._long,e._long)}}const lc=/^__.*__$/;class hc{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return null!==this.fieldMask?new En(e,this.data,this.fieldMask,t,this.fieldTransforms):new bn(e,this.data,t,this.fieldTransforms)}}class dc{constructor(e,t,n){this.data=e,this.fieldMask=t,this.fieldTransforms=n}toMutation(e,t){return new En(e,this.data,this.fieldMask,t,this.fieldTransforms)}}function fc(e){switch(e){case 0:case 2:case 1:return!0;case 3:case 4:return!1;default:throw v()}}class mc{constructor(e,t,n,r,s,i){this.settings=e,this.databaseId=t,this.wt=n,this.ignoreUndefinedProperties=r,void 0===s&&this.Xc(),this.fieldTransforms=s||[],this.fieldMask=i||[]}get path(){return this.settings.path}get Zc(){return this.settings.Zc}ta(e){return new mc(Object.assign(Object.assign({},this.settings),e),this.databaseId,this.wt,this.ignoreUndefinedProperties,this.fieldTransforms,this.fieldMask)}ea(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ta({path:n,na:!1});return r.sa(e),r}ia(e){var t;const n=null===(t=this.path)||void 0===t?void 0:t.child(e),r=this.ta({path:n,na:!1});return r.Xc(),r}ra(e){return this.ta({path:void 0,na:!0})}oa(e){return Rc(e,this.settings.methodName,this.settings.ua||!1,this.path,this.settings.ca)}contains(e){return void 0!==this.fieldMask.find((t=>e.isPrefixOf(t)))||void 0!==this.fieldTransforms.find((t=>e.isPrefixOf(t.field)))}Xc(){if(this.path)for(let e=0;e<this.path.length;e++)this.sa(this.path.get(e))}sa(e){if(0===e.length)throw this.oa("Document fields must not be empty");if(fc(this.Zc)&&lc.test(e))throw this.oa('Document fields cannot begin and end with "__"')}}class gc{constructor(e,t,n){this.databaseId=e,this.ignoreUndefinedProperties=t,this.wt=n||To(e)}aa(e,t,n,r=!1){return new mc({Zc:e,methodName:t,ca:n,path:$.emptyPath(),na:!1,ua:r},this.databaseId,this.wt,this.ignoreUndefinedProperties)}}function pc(e){const t=e._freezeSettings(),n=To(e._databaseId);return new gc(e._databaseId,!!t.ignoreUndefinedProperties,n)}function yc(e,t,n,r,s,i={}){const o=e.aa(i.merge||i.mergeFields?2:0,t,n,s);kc("Data must be an object, but it was:",o,r);const a=Nc(r,o);let u,c;if(i.merge)u=new De(o.fieldMask),c=o.fieldTransforms;else if(i.mergeFields){const e=[];for(const r of i.mergeFields){const s=Cc(t,r,n);if(!o.contains(s))throw new S(T.INVALID_ARGUMENT,`Field '${s}' is specified in your field mask but missing from your input data.`);Lc(e,s)||e.push(s)}u=new De(e),c=o.fieldTransforms.filter((e=>u.covers(e.field)))}else u=null,c=o.fieldTransforms;return new hc(new ut(a),u,c)}class wc extends uc{_toFieldTransform(e){if(2!==e.Zc)throw 1===e.Zc?e.oa(`${this._methodName}() can only appear at the top level of your update data`):e.oa(`${this._methodName}() cannot be used with set() unless you pass {merge:true}`);return e.fieldMask.push(e.path),null}isEqual(e){return e instanceof wc}}function vc(e,t,n){return new mc({Zc:3,ca:t.settings.ca,methodName:e._methodName,na:n},t.databaseId,t.wt,t.ignoreUndefinedProperties)}class Ic extends uc{_toFieldTransform(e){return new hn(e.path,new nn)}isEqual(e){return e instanceof Ic}}class bc extends uc{constructor(e,t){super(e),this.ha=t}_toFieldTransform(e){const t=vc(this,e,!0),n=this.ha.map((e=>_c(e,t))),r=new rn(n);return new hn(e.path,r)}isEqual(e){return this===e}}class Ec extends uc{constructor(e,t){super(e),this.ha=t}_toFieldTransform(e){const t=vc(this,e,!0),n=this.ha.map((e=>_c(e,t))),r=new on(n);return new hn(e.path,r)}isEqual(e){return this===e}}class Tc extends uc{constructor(e,t){super(e),this.la=t}_toFieldTransform(e){const t=new un(e.wt,Yt(e.wt,this.la));return new hn(e.path,t)}isEqual(e){return this===e}}function Sc(e,t,n,r){const s=e.aa(1,t,n);kc("Data must be an object, but it was:",s,r);const i=[],a=ut.empty();we(r,((e,r)=>{const u=Mc(t,e,n);r=(0,o.m9)(r);const c=s.ia(u);if(r instanceof wc)i.push(u);else{const e=_c(r,c);null!=e&&(i.push(u),a.set(u,e))}}));const u=new De(i);return new dc(a,u,s.fieldTransforms)}function xc(e,t,n,r,s,i){const a=e.aa(1,t,n),u=[Cc(t,r,n)],c=[s];if(i.length%2!=0)throw new S(T.INVALID_ARGUMENT,`Function ${t}() needs to be called with an even number of arguments that alternate between field names and values.`);for(let o=0;o<i.length;o+=2)u.push(Cc(t,i[o])),c.push(i[o+1]);const l=[],h=ut.empty();for(let f=u.length-1;f>=0;--f)if(!Lc(l,u[f])){const e=u[f];let t=c[f];t=(0,o.m9)(t);const n=a.ia(e);if(t instanceof wc)l.push(e);else{const r=_c(t,n);null!=r&&(l.push(e),h.set(e,r))}}const d=new De(l);return new dc(h,d,a.fieldTransforms)}function Dc(e,t,n,r=!1){return _c(n,e.aa(r?4:3,t))}function _c(e,t){if(Ac(e=(0,o.m9)(e)))return kc("Unsupported field value:",t,e),Nc(e,t);if(e instanceof uc)return function(e,t){if(!fc(t.Zc))throw t.oa(`${e._methodName}() can only be used with update() and set()`);if(!t.path)throw t.oa(`${e._methodName}() is not currently supported inside arrays`);const n=e._toFieldTransform(t);n&&t.fieldTransforms.push(n)}(e,t),null;if(void 0===e&&t.ignoreUndefinedProperties)return null;if(t.path&&t.fieldMask.push(t.path),e instanceof Array){if(t.settings.na&&4!==t.Zc)throw t.oa("Nested arrays are not supported");return function(e,t){const n=[];let r=0;for(const s of e){let e=_c(s,t.ra(r));null==e&&(e={nullValue:"NULL_VALUE"}),n.push(e),r++}return{arrayValue:{values:n}}}(e,t)}return function(e,t){if(null===(e=(0,o.m9)(e)))return{nullValue:"NULL_VALUE"};if("number"==typeof e)return Yt(t.wt,e);if("boolean"==typeof e)return{booleanValue:e};if("string"==typeof e)return{stringValue:e};if(e instanceof Date){const n=q.fromDate(e);return{timestampValue:ir(t.wt,n)}}if(e instanceof q){const n=new q(e.seconds,1e3*Math.floor(e.nanoseconds/1e3));return{timestampValue:ir(t.wt,n)}}if(e instanceof cc)return{geoPointValue:{latitude:e.latitude,longitude:e.longitude}};if(e instanceof ac)return{bytesValue:or(t.wt,e._byteString)};if(e instanceof Lu){const n=t.databaseId,r=e.firestore._databaseId;if(!r.isEqual(n))throw t.oa(`Document reference is for database ${r.projectId}/${r.database} but should be for database ${n.projectId}/${n.database}`);return{referenceValue:cr(e.firestore._databaseId||t.databaseId,e._key.path)}}throw t.oa(`Unsupported field value: ${Au(e)}`)}(e,t)}function Nc(e,t){const n={};return ve(e)?t.path&&t.path.length>0&&t.fieldMask.push(t.path):we(e,((e,r)=>{const s=_c(r,t.ea(e));null!=s&&(n[e]=s)})),{mapValue:{fields:n}}}function Ac(e){return!("object"!=typeof e||null===e||e instanceof Array||e instanceof Date||e instanceof q||e instanceof cc||e instanceof ac||e instanceof Lu||e instanceof uc)}function kc(e,t,n){if(!Ac(n)||!function(e){return"object"==typeof e&&null!==e&&(Object.getPrototypeOf(e)===Object.prototype||null===Object.getPrototypeOf(e))}(n)){const r=Au(n);throw"an object"===r?t.oa(e+" a custom object"):t.oa(e+" "+r)}}function Cc(e,t,n){if((t=(0,o.m9)(t))instanceof oc)return t._internalPath;if("string"==typeof t)return Mc(e,t);throw Rc("Field path arguments must be of type string or ",e,!1,void 0,n)}const Vc=new RegExp("[~\\*/\\[\\]]");function Mc(e,t,n){if(t.search(Vc)>=0)throw Rc(`Invalid field path (${t}). Paths must not contain '~', '*', '/', '[', or ']'`,e,!1,void 0,n);try{return new oc(...t.split("."))._internalPath}catch(r){throw Rc(`Invalid field path (${t}). Paths must not be empty, begin with '.', end with '.', or contain '..'`,e,!1,void 0,n)}}function Rc(e,t,n,r,s){const i=r&&!r.isEmpty(),o=void 0!==s;let a=`Function ${t}() called with invalid data`;n&&(a+=" (via `toFirestore()`)"),a+=". ";let u="";return(i||o)&&(u+=" (found",i&&(u+=` in field ${r}`),o&&(u+=` in document ${s}`),u+=")"),new S(T.INVALID_ARGUMENT,a+e+u)}function Lc(e,t){return e.some((e=>e.isEqual(t)))}class Fc{constructor(e,t,n,r,s){this._firestore=e,this._userDataWriter=t,this._key=n,this._document=r,this._converter=s}get id(){return this._key.path.lastSegment()}get ref(){return new Lu(this._firestore,this._converter,this._key)}exists(){return null!==this._document}data(){if(this._document){if(this._converter){const e=new Oc(this._firestore,this._userDataWriter,this._key,this._document,null);return this._converter.fromFirestore(e)}return this._userDataWriter.convertValue(this._document.data.value)}}get(e){if(this._document){const t=this._document.data.field(Pc("DocumentSnapshot.get",e));if(null!==t)return this._userDataWriter.convertValue(t)}}}class Oc extends Fc{data(){return super.data()}}function Pc(e,t){return"string"==typeof t?Mc(e,t):t instanceof oc?t._internalPath:t._delegate._internalPath}class qc{constructor(e,t){this.hasPendingWrites=e,this.fromCache=t}isEqual(e){return this.hasPendingWrites===e.hasPendingWrites&&this.fromCache===e.fromCache}}class Uc extends Fc{constructor(e,t,n,r,s,i){super(e,t,n,r,i),this._firestore=e,this._firestoreImpl=e,this.metadata=s}exists(){return super.exists()}data(e={}){if(this._document){if(this._converter){const t=new Bc(this._firestore,this._userDataWriter,this._key,this._document,this.metadata,null);return this._converter.fromFirestore(t,e)}return this._userDataWriter.convertValue(this._document.data.value,e.serverTimestamps)}}get(e,t={}){if(this._document){const n=this._document.data.field(Pc("DocumentSnapshot.get",e));if(null!==n)return this._userDataWriter.convertValue(n,t.serverTimestamps)}}}class Bc extends Uc{data(e={}){return super.data(e)}}class Kc{constructor(e,t,n,r){this._firestore=e,this._userDataWriter=t,this._snapshot=r,this.metadata=new qc(r.hasPendingWrites,r.fromCache),this.query=n}get docs(){const e=[];return this.forEach((t=>e.push(t))),e}get size(){return this._snapshot.docs.size}get empty(){return 0===this.size}forEach(e,t){this._snapshot.docs.forEach((n=>{e.call(t,new Bc(this._firestore,this._userDataWriter,n.key,n,new qc(this._snapshot.mutatedKeys.has(n.key),this._snapshot.fromCache),this.query.converter))}))}docChanges(e={}){const t=!!e.includeMetadataChanges;if(t&&this._snapshot.excludesMetadataChanges)throw new S(T.INVALID_ARGUMENT,"To include metadata changes with your document changes, you must also pass { includeMetadataChanges:true } to onSnapshot().");return this._cachedChanges&&this._cachedChangesIncludeMetadataChanges===t||(this._cachedChanges=function(e,t){if(e._snapshot.oldDocs.isEmpty()){let t=0;return e._snapshot.docChanges.map((n=>({type:"added",doc:new Bc(e._firestore,e._userDataWriter,n.doc.key,n.doc,new qc(e._snapshot.mutatedKeys.has(n.doc.key),e._snapshot.fromCache),e.query.converter),oldIndex:-1,newIndex:t++})))}{let n=e._snapshot.oldDocs;return e._snapshot.docChanges.filter((e=>t||3!==e.type)).map((t=>{const r=new Bc(e._firestore,e._userDataWriter,t.doc.key,t.doc,new qc(e._snapshot.mutatedKeys.has(t.doc.key),e._snapshot.fromCache),e.query.converter);let s=-1,i=-1;return 0!==t.type&&(s=n.indexOf(t.doc.key),n=n.delete(t.doc.key)),1!==t.type&&(n=n.add(t.doc),i=n.indexOf(t.doc.key)),{type:Gc(t.type),doc:r,oldIndex:s,newIndex:i}}))}}(this,t),this._cachedChangesIncludeMetadataChanges=t),this._cachedChanges}}function Gc(e){switch(e){case 0:return"added";case 2:case 3:return"modified";case 1:return"removed";default:return v()}}function $c(e,t){return e instanceof Uc&&t instanceof Uc?e._firestore===t._firestore&&e._key.isEqual(t._key)&&(null===e._document?null===t._document:e._document.isEqual(t._document))&&e._converter===t._converter:e instanceof Kc&&t instanceof Kc&&e._firestore===t._firestore&&Ku(e.query,t.query)&&e.metadata.isEqual(t.metadata)&&e._snapshot.isEqual(t._snapshot)}function zc(e){if("L"===e.limitType&&0===e.explicitOrderBy.length)throw new S(T.UNIMPLEMENTED,"limitToLast() queries require specifying at least one orderBy() clause")}class jc{}function Qc(e,...t){for(const n of t)e=n._apply(e);return e}class Wc extends jc{constructor(e,t,n){super(),this.fa=e,this.da=t,this._a=n,this.type="where"}_apply(e){const t=pc(e.firestore),n=function(e,t,n,r,s,i,o){let a;if(s.isKeyField()){if("array-contains"===i||"array-contains-any"===i)throw new S(T.INVALID_ARGUMENT,`Invalid Query. You can't perform '${i}' queries on documentId().`);if("in"===i||"not-in"===i){cl(o,i);const t=[];for(const n of o)t.push(ul(r,e,n));a={arrayValue:{values:t}}}else a=ul(r,e,o)}else"in"!==i&&"not-in"!==i&&"array-contains-any"!==i||cl(o,i),a=Dc(n,"where",o,"in"===i||"not-in"===i);const u=vt.create(s,i,a);return function(e,t){if(t.ht()){const n=Ot(e);if(null!==n&&!n.isEqual(t.field))throw new S(T.INVALID_ARGUMENT,`Invalid query. All where filters with an inequality (<, <=, !=, not-in, >, or >=) must be on the same field. But you have inequality filters on '${n.toString()}' and '${t.field.toString()}'`);const r=Ft(e);null!==r&&ll(e,t.field,r)}const n=function(e,t){for(const n of e.filters)if(t.indexOf(n.op)>=0)return n.op;return null}(e,function(e){switch(e){case"!=":return["!=","not-in"];case"array-contains":return["array-contains","array-contains-any","not-in"];case"in":return["array-contains-any","in","not-in"];case"array-contains-any":return["array-contains","array-contains-any","in","not-in"];case"not-in":return["array-contains","array-contains-any","in","not-in","!="];default:return[]}}(t.op));if(null!==n)throw n===t.op?new S(T.INVALID_ARGUMENT,`Invalid query. You cannot use more than one '${t.op.toString()}' filter.`):new S(T.INVALID_ARGUMENT,`Invalid query. You cannot use '${t.op.toString()}' filters with '${n.toString()}' filters.`)}(e,u),u}(e._query,0,t,e.firestore._databaseId,this.fa,this.da,this._a);return new Fu(e.firestore,e.converter,function(e,t){const n=e.filters.concat([t]);return new Mt(e.path,e.collectionGroup,e.explicitOrderBy.slice(),n,e.limit,e.limitType,e.startAt,e.endAt)}(e._query,n))}}function Hc(e,t,n){const r=t,s=Pc("where",e);return new Wc(s,r,n)}class Jc extends jc{constructor(e,t){super(),this.fa=e,this.wa=t,this.type="orderBy"}_apply(e){const t=function(e,t,n){if(null!==e.startAt)throw new S(T.INVALID_ARGUMENT,"Invalid query. You must not call startAt() or startAfter() before calling orderBy().");if(null!==e.endAt)throw new S(T.INVALID_ARGUMENT,"Invalid query. You must not call endAt() or endBefore() before calling orderBy().");const r=new At(t,n);return function(e,t){if(null===Ft(e)){const n=Ot(e);null!==n&&ll(e,n,t.field)}}(e,r),r}(e._query,this.fa,this.wa);return new Fu(e.firestore,e.converter,function(e,t){const n=e.explicitOrderBy.concat([t]);return new Mt(e.path,e.collectionGroup,n,e.filters.slice(),e.limit,e.limitType,e.startAt,e.endAt)}(e._query,t))}}function Yc(e,t="asc"){const n=t,r=Pc("orderBy",e);return new Jc(r,n)}class Xc extends jc{constructor(e,t,n){super(),this.type=e,this.ma=t,this.ga=n}_apply(e){return new Fu(e.firestore,e.converter,Bt(e._query,this.ma,this.ga))}}function Zc(e){return Cu("limit",e),new Xc("limit",e,"F")}function el(e){return Cu("limitToLast",e),new Xc("limitToLast",e,"L")}class tl extends jc{constructor(e,t,n){super(),this.type=e,this.ya=t,this.pa=n}_apply(e){const t=al(e,this.type,this.ya,this.pa);return new Fu(e.firestore,e.converter,function(e,t){return new Mt(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,t,e.endAt)}(e._query,t))}}function nl(...e){return new tl("startAt",e,!0)}function rl(...e){return new tl("startAfter",e,!1)}class sl extends jc{constructor(e,t,n){super(),this.type=e,this.ya=t,this.pa=n}_apply(e){const t=al(e,this.type,this.ya,this.pa);return new Fu(e.firestore,e.converter,function(e,t){return new Mt(e.path,e.collectionGroup,e.explicitOrderBy.slice(),e.filters.slice(),e.limit,e.limitType,e.startAt,t)}(e._query,t))}}function il(...e){return new sl("endBefore",e,!1)}function ol(...e){return new sl("endAt",e,!0)}function al(e,t,n,r){if(n[0]=(0,o.m9)(n[0]),n[0]instanceof Fc)return function(e,t,n,r,s){if(!r)throw new S(T.NOT_FOUND,`Can't use a DocumentSnapshot that doesn't exist for ${n}().`);const i=[];for(const o of qt(e))if(o.field.isKeyField())i.push(Je(t,r.key));else{const e=r.data.field(o.field);if(Me(e))throw new S(T.INVALID_ARGUMENT,'Invalid query. You are trying to start or end a query using a document for which the field "'+o.field+'" is an uncommitted server timestamp. (Since the value of this field is unknown, you cannot start/end a query with it.)');if(null===e){const e=o.field.canonicalString();throw new S(T.INVALID_ARGUMENT,`Invalid query. You are trying to start or end a query using a document for which the field '${e}' (used as the orderBy) does not exist.`)}i.push(e)}return new Nt(i,s)}(e._query,e.firestore._databaseId,t,n[0]._document,r);{const s=pc(e.firestore);return function(e,t,n,r,s,i){const o=e.explicitOrderBy;if(s.length>o.length)throw new S(T.INVALID_ARGUMENT,`Too many arguments provided to ${r}(). The number of arguments must be less than or equal to the number of orderBy() clauses`);const a=[];for(let u=0;u<s.length;u++){const i=s[u];if(o[u].field.isKeyField()){if("string"!=typeof i)throw new S(T.INVALID_ARGUMENT,`Invalid query. Expected a string for document ID in ${r}(), but got a ${typeof i}`);if(!Pt(e)&&-1!==i.indexOf("/"))throw new S(T.INVALID_ARGUMENT,`Invalid query. When querying a collection and ordering by documentId(), the value passed to ${r}() must be a plain document ID, but '${i}' contains a slash.`);const n=e.path.child(K.fromString(i));if(!z.isDocumentKey(n))throw new S(T.INVALID_ARGUMENT,`Invalid query. When querying a collection group and ordering by documentId(), the value passed to ${r}() must result in a valid document path, but '${n}' is not because it contains an odd number of segments.`);const s=new z(n);a.push(Je(t,s))}else{const e=Dc(n,r,i);a.push(e)}}return new Nt(a,i)}(e._query,e.firestore._databaseId,s,t,n,r)}}function ul(e,t,n){if("string"==typeof(n=(0,o.m9)(n))){if(""===n)throw new S(T.INVALID_ARGUMENT,"Invalid query. When querying with documentId(), you must provide a valid document ID, but it was an empty string.");if(!Pt(t)&&-1!==n.indexOf("/"))throw new S(T.INVALID_ARGUMENT,`Invalid query. When querying a collection by documentId(), you must provide a plain document ID, but '${n}' contains a '/' character.`);const r=t.path.child(K.fromString(n));if(!z.isDocumentKey(r))throw new S(T.INVALID_ARGUMENT,`Invalid query. When querying a collection group by documentId(), the value provided must result in a valid document path, but '${r}' is not because it has an odd number of segments (${r.length}).`);return Je(e,new z(r))}if(n instanceof Lu)return Je(e,n._key);throw new S(T.INVALID_ARGUMENT,`Invalid query. When querying with documentId(), you must provide a valid string or a DocumentReference, but it was: ${Au(n)}.`)}function cl(e,t){if(!Array.isArray(e)||0===e.length)throw new S(T.INVALID_ARGUMENT,`Invalid Query. A non-empty array is required for '${t.toString()}' filters.`);if(e.length>10)throw new S(T.INVALID_ARGUMENT,`Invalid Query. '${t.toString()}' filters support a maximum of 10 elements in the value array.`)}function ll(e,t,n){if(!n.isEqual(t))throw new S(T.INVALID_ARGUMENT,`Invalid query. You have a where filter with an inequality (<, <=, !=, not-in, >, or >=) on field '${t.toString()}' and so you must also use '${t.toString()}' as your first argument to orderBy(), but your first orderBy() is on field '${n.toString()}' instead.`)}const hl={maxAttempts:5};class dl{convertValue(e,t="none"){switch(Ge(e)){case 0:return null;case 1:return e.booleanValue;case 2:return Ce(e.integerValue||e.doubleValue);case 3:return this.convertTimestamp(e.timestampValue);case 4:return this.convertServerTimestamp(e,t);case 5:return e.stringValue;case 6:return this.convertBytes(Ve(e.bytesValue));case 7:return this.convertReference(e.referenceValue);case 8:return this.convertGeoPoint(e.geoPointValue);case 9:return this.convertArray(e.arrayValue,t);case 10:return this.convertObject(e.mapValue,t);default:throw v()}}convertObject(e,t){const n={};return we(e.fields,((e,r)=>{n[e]=this.convertValue(r,t)})),n}convertGeoPoint(e){return new cc(Ce(e.latitude),Ce(e.longitude))}convertArray(e,t){return(e.values||[]).map((e=>this.convertValue(e,t)))}convertServerTimestamp(e,t){switch(t){case"previous":const n=Re(e);return null==n?null:this.convertValue(n,t);case"estimate":return this.convertTimestamp(Le(e));default:return null}}convertTimestamp(e){const t=ke(e);return new q(t.seconds,t.nanos)}convertDocumentKey(e,t){const n=K.fromString(e);I(Vr(n));const r=new Oe(n.get(1),n.get(3)),s=new z(n.popFirst(5));return r.isEqual(t)||p(`Document ${s} contains a document reference within a different database (${r.projectId}/${r.database}) which is not supported. It will be treated as a reference in the current database (${t.projectId}/${t.database}) instead.`),s}}function fl(e,t,n){let r;return r=e?n&&(n.merge||n.mergeFields)?e.toFirestore(t,n):e.toFirestore(t):t,r}class ml extends dl{constructor(e){super(),this.firestore=e}convertBytes(e){return new ac(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Lu(this.firestore,null,t)}}class gl{constructor(e,t){this._firestore=e,this._commitHandler=t,this._mutations=[],this._committed=!1,this._dataReader=pc(e)}set(e,t,n){this._verifyNotCommitted();const r=pl(e,this._firestore),s=fl(r.converter,t,n),i=yc(this._dataReader,"WriteBatch.set",r._key,s,null!==r.converter,n);return this._mutations.push(i.toMutation(r._key,fn.none())),this}update(e,t,n,...r){this._verifyNotCommitted();const s=pl(e,this._firestore);let i;return i="string"==typeof(t=(0,o.m9)(t))||t instanceof oc?xc(this._dataReader,"WriteBatch.update",s._key,t,n,r):Sc(this._dataReader,"WriteBatch.update",s._key,t),this._mutations.push(i.toMutation(s._key,fn.exists(!0))),this}delete(e){this._verifyNotCommitted();const t=pl(e,this._firestore);return this._mutations=this._mutations.concat(new Dn(t._key,fn.none())),this}commit(){return this._verifyNotCommitted(),this._committed=!0,this._mutations.length>0?this._commitHandler(this._mutations):Promise.resolve()}_verifyNotCommitted(){if(this._committed)throw new S(T.FAILED_PRECONDITION,"A write batch can no longer be used after commit() has been called.")}}function pl(e,t){if((e=(0,o.m9)(e)).firestore!==t)throw new S(T.INVALID_ARGUMENT,"Provided document reference is from a different Firestore instance.");return e}function yl(e){e=ku(e,Lu);const t=ku(e.firestore,Qu);return bu(Wu(t),e._key).then((n=>Cl(t,e,n)))}class wl extends dl{constructor(e){super(),this.firestore=e}convertBytes(e){return new ac(e)}convertReference(e){const t=this.convertDocumentKey(e,this.firestore._databaseId);return new Lu(this.firestore,null,t)}}function vl(e){e=ku(e,Lu);const t=ku(e.firestore,Qu),n=Wu(t),r=new wl(t);return function(e,t){const n=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await function(e,t){const n=E(e);return n.persistence.runTransaction("read document","readonly",(e=>n.localDocuments.getDocument(e,t)))}(e,t);r.isFoundDocument()?n.resolve(r):r.isNoDocument()?n.resolve(null):n.reject(new S(T.UNAVAILABLE,"Failed to get document from cache. (However, this document may exist on the server. Run again without setting 'source' in the GetOptions to attempt to retrieve the document from the server.)"))}catch(e){const r=oa(e,`Failed to get document '${t} from cache`);n.reject(r)}}(await yu(e),t,n))),n.promise}(n,e._key).then((n=>new Uc(t,r,e._key,n,new qc(null!==n&&n.hasLocalMutations,!0),e.converter)))}function Il(e){e=ku(e,Lu);const t=ku(e.firestore,Qu);return bu(Wu(t),e._key,{source:"server"}).then((n=>Cl(t,e,n)))}function bl(e){e=ku(e,Fu);const t=ku(e.firestore,Qu),n=Wu(t),r=new wl(t);return zc(e._query),Eu(n,e._query).then((n=>new Kc(t,r,e,n)))}function El(e){e=ku(e,Fu);const t=ku(e.firestore,Qu),n=Wu(t),r=new wl(t);return function(e,t){const n=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){try{const r=await eo(e,t,!0),s=new Sa(t,r.ji),i=s.Ku(r.documents),o=s.applyChanges(i,!1);n.resolve(o.snapshot)}catch(e){const r=oa(e,`Failed to execute query '${t} against cache`);n.reject(r)}}(await yu(e),t,n))),n.promise}(n,e._query).then((n=>new Kc(t,r,e,n)))}function Tl(e){e=ku(e,Fu);const t=ku(e.firestore,Qu),n=Wu(t),r=new wl(t);return Eu(n,e._query,{source:"server"}).then((n=>new Kc(t,r,e,n)))}function Sl(e,t,n){e=ku(e,Lu);const r=ku(e.firestore,Qu),s=fl(e.converter,t,n);return kl(r,[yc(pc(r),"setDoc",e._key,s,null!==e.converter,n).toMutation(e._key,fn.none())])}function xl(e,t,n,...r){e=ku(e,Lu);const s=ku(e.firestore,Qu),i=pc(s);let a;return a="string"==typeof(t=(0,o.m9)(t))||t instanceof oc?xc(i,"updateDoc",e._key,t,n,r):Sc(i,"updateDoc",e._key,t),kl(s,[a.toMutation(e._key,fn.exists(!0))])}function Dl(e){return kl(ku(e.firestore,Qu),[new Dn(e._key,fn.none())])}function _l(e,t){const n=ku(e.firestore,Qu),r=Uu(e),s=fl(e.converter,t);return kl(n,[yc(pc(e.firestore),"addDoc",r._key,s,null!==e.converter,{}).toMutation(r._key,fn.exists(!1))]).then((()=>r))}function Nl(e,...t){var n,r,s;e=(0,o.m9)(e);let i={includeMetadataChanges:!1},a=0;"object"!=typeof t[a]||$u(t[a])||(i=t[a],a++);const u={includeMetadataChanges:i.includeMetadataChanges};if($u(t[a])){const e=t[a];t[a]=null===(n=e.next)||void 0===n?void 0:n.bind(e),t[a+1]=null===(r=e.error)||void 0===r?void 0:r.bind(e),t[a+2]=null===(s=e.complete)||void 0===s?void 0:s.bind(e)}let c,l,h;if(e instanceof Lu)l=ku(e.firestore,Qu),h=Lt(e._key.path),c={next:n=>{t[a]&&t[a](Cl(l,e,n))},error:t[a+1],complete:t[a+2]};else{const n=ku(e,Fu);l=ku(n.firestore,Qu),h=n._query;const r=new wl(l);c={next:e=>{t[a]&&t[a](new Kc(l,r,n,e))},error:t[a+1],complete:t[a+2]},zc(e._query)}return function(e,t,n,r){const s=new au(r),i=new ya(t,s,n);return e.asyncQueue.enqueueAndForget((async()=>da(await Iu(e),i))),()=>{s.Tc(),e.asyncQueue.enqueueAndForget((async()=>fa(await Iu(e),i)))}}(Wu(l),h,u,c)}function Al(e,t){return function(e,t){const n=new au(t);return e.asyncQueue.enqueueAndForget((async()=>function(e,t){E(e).Tu.add(t),t.next()}(await Iu(e),n))),()=>{n.Tc(),e.asyncQueue.enqueueAndForget((async()=>function(e,t){E(e).Tu.delete(t)}(await Iu(e),n)))}}(Wu(e=ku(e,Qu)),$u(t)?t:{next:t})}function kl(e,t){return function(e,t){const n=new x;return e.asyncQueue.enqueueAndForget((async()=>async function(e,t,n){const r=tu(e);try{const e=await function(e,t){const n=E(e),r=q.now(),s=t.reduce(((e,t)=>e.add(t.key)),$n());let i,o;return n.persistence.runTransaction("Locally write mutations","readwrite",(e=>{let a=Ln(),u=$n();return n.Ui.getEntries(e,s).next((e=>{a=e,a.forEach(((e,t)=>{t.isValidDocument()||(u=u.add(e))}))})).next((()=>n.localDocuments.getOverlayedDocuments(e,a))).next((s=>{i=s;const o=[];for(const e of t){const t=vn(e,i.get(e.key).overlayedDocument);null!=t&&o.push(new En(e.key,t,ct(t.value.mapValue),fn.exists(!0)))}return n.mutationQueue.addMutationBatch(e,r,o,t)})).next((t=>{o=t;const r=t.applyToLocalDocumentSet(i,u);return n.documentOverlayCache.saveOverlays(e,t.batchId,r)}))})).then((()=>({batchId:o.batchId,changes:Pn(i)})))}(r.localStore,t);r.sharedClientState.addPendingMutation(e.batchId),function(e,t,n){let r=e.oc[e.currentUser.toKey()];r||(r=new Ie(F)),r=r.insert(t,n),e.oc[e.currentUser.toKey()]=r}(r,e.batchId,n),await Ga(r,e.changes),await jo(r.remoteStore)}catch(e){const t=oa(e,"Failed to persist write");n.reject(t)}}(await vu(e),t,n))),n.promise}(Wu(e),t)}function Cl(e,t,n){const r=n.docs.get(t._key),s=new wl(e);return new Uc(e,s,t._key,r,new qc(n.hasPendingWrites,n.fromCache),t.converter)}class Vl extends class{constructor(e,t){this._firestore=e,this._transaction=t,this._dataReader=pc(e)}get(e){const t=pl(e,this._firestore),n=new ml(this._firestore);return this._transaction.lookup([t._key]).then((e=>{if(!e||1!==e.length)return v();const r=e[0];if(r.isFoundDocument())return new Fc(this._firestore,n,r.key,r,t.converter);if(r.isNoDocument())return new Fc(this._firestore,n,t._key,null,t.converter);throw v()}))}set(e,t,n){const r=pl(e,this._firestore),s=fl(r.converter,t,n),i=yc(this._dataReader,"Transaction.set",r._key,s,null!==r.converter,n);return this._transaction.set(r._key,i),this}update(e,t,n,...r){const s=pl(e,this._firestore);let i;return i="string"==typeof(t=(0,o.m9)(t))||t instanceof oc?xc(this._dataReader,"Transaction.update",s._key,t,n,r):Sc(this._dataReader,"Transaction.update",s._key,t),this._transaction.update(s._key,i),this}delete(e){const t=pl(e,this._firestore);return this._transaction.delete(t._key),this}}{constructor(e,t){super(e,t),this._firestore=e}get(e){const t=pl(e,this._firestore),n=new wl(this._firestore);return super.get(e).then((e=>new Uc(this._firestore,n,t._key,e._document,new qc(!1,!1),t.converter)))}}function Ml(e,t,n){e=ku(e,Qu);const r=Object.assign(Object.assign({},hl),n);return function(e){if(e.maxAttempts<1)throw new S(T.INVALID_ARGUMENT,"Max attempts must be at least 1")}(r),function(e,t,n){const r=new x;return e.asyncQueue.enqueueAndForget((async()=>{const s=await function(e){return gu(e).then((e=>e.datastore))}(e);new lu(e.asyncQueue,s,n,t,r).run()})),r.promise}(Wu(e),(n=>t(new Vl(e,n))),r)}function Rl(){return new wc("deleteField")}function Ll(){return new Ic("serverTimestamp")}function Fl(...e){return new bc("arrayUnion",e)}function Ol(...e){return new Ec("arrayRemove",e)}function Pl(e){return new Tc("increment",e)}!function(e,t=!0){!function(e){h=e}(r.SDK_VERSION),(0,r._registerComponent)(new s.wA("firestore",((e,{options:n})=>{const r=e.getProvider("app").getImmediate(),s=new Qu(r,new A(e.getProvider("auth-internal")),new M(e.getProvider("app-check-internal")));return n=Object.assign({useFetchStreams:t},n),s._setSettings(n),s}),"PUBLIC")),(0,r.registerVersion)(c,"3.4.12",e),(0,r.registerVersion)(c,"3.4.12","esm2017")}()}}]);